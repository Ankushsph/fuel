<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <title>Dashboard - Fuel Flux</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/tailwind.css') }}">
  <style>
    #toast {
      position: fixed;
      top: -100px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 50;
      padding: 1rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 500;
      color: white;
      opacity: 0;
      transition: all 0.5s ease-in-out;
      min-width: 250px;
      text-align: center;
    }

    #toast.show {
      top: 2rem;
      opacity: 1;
    }

    .locked {
      filter: blur(2px);
      position: relative;
    }

    .locked::after {
      content: "üîí";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #FFA500;
      font-weight: bold;
      text-align: center;
      pointer-events: none;
    }

    .locked:hover {
      background-color: #1f1f1f;
      transform: scale(1.02);
      transition: all 0.2s;
    }

    .sidebar,
    .scrollable {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .sidebar::-webkit-scrollbar,
    .scrollable::-webkit-scrollbar {
      display: none;
      width: 0;
      height: 0;
    }

    .sidebar {
      overflow-y: auto;
    }
  </style>
</head>
<body class="bg-fuel-black text-white min-h-screen flex flex-col">

  <script>
    // Receipt, Comparison, Density functions must be declared before DOM loads
    function getReceiptTemplate() {
      return `
      <div class="animate-fade-in flex flex-col gap-6">
        <div class="flex flex-col lg:flex-row gap-6">
          <div class="flex-1 bg-fuel-gray rounded-2xl p-6 shadow">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
              <div>
                <p class="text-sm uppercase tracking-wide text-gray-400">Receipt Management</p>
                <h2 class="text-2xl font-bold text-white">Upload Receipt</h2>
              </div>
              <button id="selectReceiptBtn" class="mt-4 md:mt-0 px-4 py-2 bg-fuel-orange text-white rounded-lg font-semibold shadow hover:bg-orange-500 transition">
                Select File
              </button>
            </div>
            <div id="receiptDropZone" class="border-2 border-dashed border-gray-600 rounded-2xl p-8 text-center cursor-pointer transition">
              <div class="text-5xl mb-4 text-fuel-orange">‚¨ÜÔ∏è</div>
              <p class="text-gray-200 font-semibold mb-2">Drag and drop your receipt</p>
              <p class="text-sm text-gray-400 mb-4">or click to browse files</p>
              <div class="flex justify-center">
                <div class="bg-fuel-black/40 px-4 py-2 rounded-lg text-sm text-gray-300">Supported: JPG / PNG</div>
              </div>
              <div id="selectedReceiptPreview" class="mt-6 hidden">
                <img id="receiptPreviewImage" src="" class="max-h-72 mx-auto rounded-lg shadow-lg object-contain" alt="Receipt preview">
                <p id="receiptFileName" class="mt-3 text-gray-300 text-sm"></p>
                <button id="changeReceiptBtn" type="button" class="mt-2 text-fuel-orange underline">Change File</button>
              </div>
              <input type="file" id="receiptFileInput" accept="image/*" class="hidden">
            </div>
            <button id="processReceiptBtn" class="mt-6 w-full bg-fuel-orange text-white py-3 rounded-xl font-semibold hover:bg-orange-500 transition disabled:opacity-40" disabled>
              Process Receipt
            </button>
          </div>

          <div class="w-full lg:w-1/3 bg-fuel-gray rounded-2xl p-6 shadow">
            <h3 class="text-xl font-semibold text-white mb-4">Extracted Data</h3>
            <div id="extractedDataContent" class="text-gray-300 text-sm">
              <p>No data yet. Upload a receipt to view details.</p>
            </div>
          </div>
        </div>

        <div class="bg-fuel-gray rounded-2xl p-6 shadow">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold text-white">Receipt History</h3>
            <button id="refreshHistoryBtn" class="text-sm text-fuel-orange underline hover:text-white">Refresh</button>
          </div>
          <div id="receiptHistoryList" class="space-y-3 text-sm text-gray-200">
            <p>No receipts uploaded yet.</p>
          </div>
        </div>
      </div>`;
    }

    function getComparisonTemplate() {
      return `
      <div class="animate-fade-in bg-fuel-gray rounded-2xl p-6 shadow space-y-6">
        <div id="comparisonSummary" class="grid gap-4 md:grid-cols-3 text-gray-200">
          <p>Loading comparison data...</p>
        </div>
        <div class="overflow-auto">
          <table class="w-full text-left text-sm text-gray-200">
            <thead class="text-gray-400 uppercase text-xs border-b border-gray-600">
              <tr>
                <th class="py-2">Nozzle</th>
                <th class="py-2">Latest Sales (‚Çπ)</th>
                <th class="py-2">Previous Sales (‚Çπ)</th>
                <th class="py-2">Net Change (‚Çπ)</th>
              </tr>
            </thead>
            <tbody id="comparisonTable">
              <tr><td colspan="4" class="py-4 text-center text-gray-400">Waiting for data...</td></tr>
            </tbody>
          </table>
        </div>
      </div>`;
    }

    function getDensityTemplate() {
      return `
      <div class="animate-fade-in bg-fuel-gray rounded-2xl p-6 shadow space-y-6">
        <div>
          <p class="text-sm uppercase tracking-wide text-gray-400">Density Conversion</p>
          <h2 class="text-2xl font-bold text-white">Fuel Density Standardization</h2>
          <p class="text-gray-300 text-sm mt-2">Convert recorded density to standard density at 15¬∞C.</p>
        </div>

        <form id="densityForm" class="grid gap-4 md:grid-cols-2">
          <div class="md:col-span-2">
            <label class="block text-gray-400 text-sm mb-1">Fuel Type</label>
            <select name="fuel_type" class="w-full bg-fuel-black text-white rounded-lg p-3 focus:outline-none">
              <option value="Petrol">Petrol</option>
              <option value="Diesel">Diesel</option>
            </select>
          </div>
          <div>
            <label class="block text-gray-400 text-sm mb-1">Current Density (g/cm¬≥)</label>
            <input type="number" step="0.0001" name="density" placeholder="0.82" class="w-full bg-fuel-black text-white rounded-lg p-3 focus:outline-none" required>
          </div>
          <div>
            <label class="block text-gray-400 text-sm mb-1">Current Temperature (¬∞C)</label>
            <input type="number" step="0.1" name="temperature" placeholder="25" class="w-full bg-fuel-black text-white rounded-lg p-3 focus:outline-none" required>
          </div>
          <div class="md:col-span-2">
            <button type="submit" class="w-full bg-fuel-orange hover:bg-orange-500 text-white font-semibold py-3 rounded-xl transition">
              Calculate Standard Density
            </button>
          </div>
        </form>

        <div class="bg-fuel-black/40 rounded-xl p-4 text-center">
          <p class="text-sm text-gray-400">Standard Density at 15¬∞C</p>
          <p id="densityResult" class="text-4xl font-bold text-white mt-2">--</p>
        </div>

        <div class="bg-fuel-black/30 rounded-xl p-4 text-sm text-gray-300 leading-relaxed">
          <h3 class="text-white font-semibold mb-2">How density changes with temperature</h3>
          <p>Petrol density drops by ~0.1% per ¬∞C while diesel by ~0.07% per ¬∞C. The calculator accounts for this to show the equivalent density at the standard reference temperature (15¬∞C).</p>
        </div>
      </div>`;
    }

    function renderExtractedData(data) {
      const container = document.getElementById('extractedDataContent');
      if (!container) return;

      if (!data) {
        container.innerHTML = '<p>No data yet. Upload a receipt to view details.</p>';
        return;
      }

      const nozzleHtml = (data.nozzles || [])
        .map(nozzle => `
          <div class="bg-fuel-black/40 rounded-lg p-3 mb-3">
            <p class="text-white font-semibold">Nozzle ${nozzle.nozzle || ''}</p>
            <p class="text-sm text-gray-300">A: ${nozzle.a || '--'}</p>
            <p class="text-sm text-gray-300">V: ${nozzle.v || '--'}</p>
            <p class="text-sm text-gray-300">Total Sales: ‚Çπ${nozzle.totSales || '--'}</p>
          </div>`).join('');

      container.innerHTML = `
        <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
          <div>
            <p class="text-gray-400">Print Date</p>
            <p class="text-white font-semibold">${data.printDate || '--'}</p>
          </div>
          <div>
            <p class="text-gray-400">Pump Serial Number</p>
            <p class="text-white font-semibold">${data.pumpSerialNumber || '--'}</p>
          </div>
          <div>
            <p class="text-gray-400">Model</p>
            <p class="text-white font-semibold">${data.model || '--'}</p>
          </div>
          <div>
            <p class="text-gray-400">Total Sales</p>
            <p class="text-white font-semibold">‚Çπ${(data.totalSales || 0).toLocaleString()}</p>
          </div>
        </div>
        <div class="space-y-3">${nozzleHtml || '<p class="text-gray-400 text-sm">No nozzle data captured.</p>'}</div>`;
    }

    async function loadReceiptHistory() {
      const list = document.getElementById('receiptHistoryList');
      if (!list || !pumpId) return;
      list.innerHTML = '<p class="text-gray-400">Loading history...</p>';
      try {
        const res = await fetch(`/pump/${pumpId}/receipt/history`, { credentials: 'same-origin' });
        const data = await res.json();
        if (res.ok && data.success && data.receipts.length) {
          list.innerHTML = data.receipts
            .map(record => {
              const encoded = encodeURIComponent(JSON.stringify(record));
              return `
              <div class="bg-fuel-black/40 rounded-lg p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-2">
                <div>
                  <p class="text-white font-semibold">${record.print_date || 'Unknown date'}</p>
                  <p class="text-gray-400 text-xs">Total Sales: ‚Çπ${(record.total_sales || 0).toLocaleString()}</p>
                </div>
                <button data-record='${encoded}' class="px-3 py-1 bg-fuel-orange text-white rounded-lg text-sm history-view-btn">
                  View
                </button>
              </div>
            `;
            })
            .join('');
          list.querySelectorAll('.history-view-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              const payload = JSON.parse(decodeURIComponent(btn.dataset.record || '{}'));
              renderExtractedData(payload.data);
              showToast('Loaded receipt snapshot.', 'success');
            });
          });
        } else {
          list.innerHTML = `<p class="text-gray-400 text-sm">${data.message || 'No receipts uploaded yet.'}</p>`;
        }
      } catch (err) {
        console.error(err);
        list.innerHTML = '<p class="text-red-400 text-sm">Failed to load history.</p>';
      }
    }

    function initReceiptSection() {
      const dropZone = document.getElementById('receiptDropZone');
      const fileInput = document.getElementById('receiptFileInput');
      const selectBtn = document.getElementById('selectReceiptBtn');
      const changeBtn = document.getElementById('changeReceiptBtn');
      const processBtn = document.getElementById('processReceiptBtn');
      const previewWrapper = document.getElementById('selectedReceiptPreview');
      const previewImage = document.getElementById('receiptPreviewImage');
      const previewName = document.getElementById('receiptFileName');
      const refreshBtn = document.getElementById('refreshHistoryBtn');
      let selectedFile = null;

      const setPreview = () => {
        if (selectedFile) {
          previewWrapper.classList.remove('hidden');
          previewImage.src = URL.createObjectURL(selectedFile);
          previewName.textContent = selectedFile.name;
          processBtn.disabled = false;
        } else {
          previewWrapper.classList.add('hidden');
          previewImage.src = '';
          previewName.textContent = '';
          processBtn.disabled = true;
        }
      };

      const handleFiles = files => {
        if (files && files.length) {
          selectedFile = files[0];
          setPreview();
        }
      };

      if (selectBtn) selectBtn.addEventListener('click', () => fileInput.click());
      if (changeBtn) changeBtn.addEventListener('click', () => fileInput.click());
      if (refreshBtn) refreshBtn.addEventListener('click', () => loadReceiptHistory());

      dropZone.addEventListener('click', () => fileInput.click());
      dropZone.addEventListener('dragover', e => {
        e.preventDefault();
        dropZone.classList.add('border-fuel-orange');
      });
      dropZone.addEventListener('dragleave', () => dropZone.classList.remove('border-fuel-orange'));
      dropZone.addEventListener('drop', e => {
        e.preventDefault();
        dropZone.classList.remove('border-fuel-orange');
        handleFiles(e.dataTransfer.files);
      });

      fileInput.addEventListener('change', e => handleFiles(e.target.files));

      processBtn.addEventListener('click', async () => {
        if (!selectedFile) {
          showToast('Please select a receipt image first.', 'error');
          return;
        }

        processBtn.disabled = true;
        processBtn.textContent = 'Processing...';

        try {
          const formData = new FormData();
          formData.append('receipt', selectedFile);
          
          // Add CSRF token for file upload
          const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
          if (csrfToken) {
            formData.append('csrf_token', csrfToken);
          }
          
          const res = await fetch(`/pump/${pumpId}/receipt/upload`, {
            method: 'POST',
            body: formData,
            credentials: 'same-origin',
            headers: {
              'X-CSRFToken': csrfToken || ''
            }
          });
          const data = await res.json();
          if (res.ok && data.success) {
            showToast('Receipt processed successfully!', 'success');
            renderExtractedData(data.data);
            await loadReceiptHistory();
          } else {
            showToast(data.error || 'Failed to process receipt', 'error');
          }
        } catch (err) {
          console.error(err);
          showToast('Unable to process receipt. Please try again.', 'error');
        } finally {
          processBtn.disabled = false;
          processBtn.textContent = 'Process Receipt';
        }
      });

      loadReceiptHistory();
      renderExtractedData(null);
    }

    async function initDailyComparison() {
      const summary = document.getElementById('comparisonSummary');
      const table = document.getElementById('comparisonTable');
      if (!pumpId) return;
      summary.innerHTML = '<p class="text-gray-400">Loading comparison data...</p>';
      table.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-400">Loading...</td></tr>';

      try {
        const res = await fetch(`/pump/${pumpId}/receipt/comparison`, { credentials: 'same-origin' });
        const data = await res.json();
        if (!res.ok || !data.success || data.message) {
          summary.innerHTML = `<p class="text-gray-400">${data.message || data.error || 'Upload at least two receipts to view comparison.'}</p>`;
          table.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-400">Not enough data.</td></tr>';
          return;
        }

        summary.innerHTML = `
          <div class="bg-fuel-black/40 rounded-xl p-4">
            <p class="text-xs text-gray-400">Latest Receipt</p>
            <p class="text-white font-semibold">${data.latest.print_date || '--'}</p>
            <p class="text-gray-300 text-sm">Total Sales: ‚Çπ${(data.latest.total_sales || 0).toLocaleString()}</p>
          </div>
          <div class="bg-fuel-black/40 rounded-xl p-4">
            <p class="text-xs text-gray-400">Previous Receipt</p>
            <p class="text-white font-semibold">${data.previous.print_date || '--'}</p>
            <p class="text-gray-300 text-sm">Total Sales: ‚Çπ${(data.previous.total_sales || 0).toLocaleString()}</p>
          </div>
          <div class="bg-green-600/30 rounded-xl p-4">
            <p class="text-xs text-gray-200">Net Change</p>
            <p class="text-2xl font-bold text-white">‚Çπ${(data.net_sales || 0).toLocaleString()}</p>
            <p class="text-gray-200 text-sm">Latest - Previous</p>
          </div>`;

        table.innerHTML = data.comparison.map(row => `
          <tr class="border-b border-gray-700">
            <td class="py-3">${row.nozzle}</td>
            <td class="py-3 text-green-300">‚Çπ${(row.current || 0).toLocaleString()}</td>
            <td class="py-3 text-gray-300">‚Çπ${(row.previous || 0).toLocaleString()}</td>
            <td class="py-3 ${row.difference >= 0 ? 'text-green-300' : 'text-red-400'}">‚Çπ${(row.difference || 0).toLocaleString()}</td>
          </tr>
        `).join('');
      } catch (err) {
        console.error(err);
        summary.innerHTML = '<p class="text-red-400">Failed to load comparison data.</p>';
        table.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-red-400">Error</td></tr>';
      }
    }

    function initDensityCalculator() {
      const form = document.getElementById('densityForm');
      const resultEl = document.getElementById('densityResult');
      if (!form) return;

      form.addEventListener('submit', async e => {
        e.preventDefault();
        const formData = new FormData(form);
        const payload = {
          fuel_type: formData.get('fuel_type'),
          density: formData.get('density'),
          temperature: formData.get('temperature')
        };
        resultEl.textContent = 'Calculating...';
        try {
          const res = await fetch(`/pump/${pumpId}/density/calculate`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            },
            credentials: 'same-origin',
            body: JSON.stringify(payload)
          });
          const data = await res.json();
          if (res.ok && data.success) {
            resultEl.textContent = `${data.standard_density} g/cm¬≥`;
            showToast('Standard density calculated.', 'success');
          } else {
            resultEl.textContent = '--';
            showToast(data.error || 'Failed to calculate density', 'error');
          }
        } catch (err) {
          console.error(err);
          resultEl.textContent = '--';
          showToast('Unable to calculate density.', 'error');
        }
      });
    }

    async function unlockFeatures() {
      const pumpId = "{{ pump.id }}";
      if (!pumpId) return;

      try {
        const res = await fetch(`/subscription/current-subscription/${pumpId}`, {
          credentials: 'same-origin'
        });
        if (!res.ok) return;

        const data = await res.json();
        const rawPlan = (data.plan || '').toString().trim();
        const planKey = rawPlan.toLowerCase();
        const displayPlan = rawPlan ? (rawPlan.charAt(0).toUpperCase() + rawPlan.slice(1)) : 'Free Trial';

        document.querySelectorAll('.subscription-info span').forEach(span => {
          span.textContent = displayPlan;
        });

        const baseSelectors = '[data-feature="vehicle-verification"], [data-feature="station-data"]';
        const premiumSelectors = '[data-feature="receipts"], [data-feature="daily-comparison"], [data-feature="density-calculator"]';

        const activateLinks = selector => {
          document.querySelectorAll(selector).forEach(el => {
            el.classList.remove('locked', 'opacity-50', 'pointer-events-none');
            el.classList.add('border-fuel-orange');
            el.classList.remove('border-gray-600');
            el.style.pointerEvents = 'auto';
            el.style.filter = 'none';
            el.textContent = el.textContent.replace(' üîí', '');
          });
        };

        const basePlans = ['silver', 'gold', 'diamond'];
        const premiumPlans = ['gold', 'diamond'];

        if (basePlans.includes(planKey)) {
          activateLinks(baseSelectors);
        }
        if (premiumPlans.includes(planKey)) {
          activateLinks(premiumSelectors);
        }

        window.currentSubscriptionPlan = planKey;
      } catch (err) {
        console.error('[unlockFeatures] fetch error', err);
        // Set default text if there was an error
        document.querySelectorAll('.subscription-info span').forEach(span => {
          span.textContent = 'Free Trial';
        });
      }
    }
  </script>

  <!-- Toast -->
  <div id="toast"></div>

  <!-- Header -->
  <header class="bg-fuel-gray p-4 flex justify-between items-center shadow-md">
    <div class="flex items-center space-x-2">
      <button id="openMobileSidebar" class="lg:hidden text-fuel-orange text-2xl font-bold">‚ò∞</button>
      <img src="{{ url_for('static', filename='images/logo2.png') }}" alt="Fuel Flux Logo" class="h-10 w-auto" />
      <span class="text-fuel-orange font-bold text-xl">Dashboard</span>
    </div>
    <div class="flex items-center space-x-4">
      <a href="/logout" class="bg-fuel-orange hover:bg-orange-600 px-4 py-2 rounded-lg font-semibold transition">
        Logout
      </a>
    </div>

  </header>

  <!-- Main Dashboard Layout -->
  <div class="flex flex-1 min-h-0 ">

    <!-- Sidebar (Desktop) -->
    <aside id="desktopSidebar" class="w-64 bg-fuel-gray flex flex-col justify-between p-6 hidden lg:flex sidebar">
      <div>
        <!-- Main navigation -->
        <nav class="space-y-4 mb-6">
          <a href="{{ url_for('pump.select_pump') }}" class="block py-2 px-3 rounded-lg border border-fuel-orange hover:bg-fuel-black transition">
            ‚õΩ My Pumps
          </a>
          <a href="#" class="block py-2 px-3 rounded-lg border border-fuel-orange hover:bg-fuel-black transition">üí≥ Subscriptions</a>
          <a href="#" class="block py-2 px-3 rounded-lg border border-fuel-orange hover:bg-fuel-black transition">üë§ Profile</a>
        </nav>

        <hr class="my-6 border-fuel-black">

        <!-- Gold+ features -->
        <div class="text-xs text-gray-500 uppercase tracking-wide mb-2 px-3">Gold Features</div>
        <nav class="space-y-4 mb-6">
          <a href="#" data-feature="receipts" class="block py-2 px-3 rounded-lg border border-gray-600 hover:bg-fuel-black transition locked opacity-50 pointer-events-none">üßæ Receipts üîí</a>
          <a href="#" data-feature="daily-comparison" class="block py-2 px-3 rounded-lg border border-gray-600 hover:bg-fuel-black transition locked opacity-50 pointer-events-none">üìà Daily Comparison üîí</a>
          <a href="#" data-feature="density-calculator" class="block py-2 px-3 rounded-lg border border-gray-600 hover:bg-fuel-black transition locked opacity-50 pointer-events-none">üß™ Density Calculator üîí</a>
        </nav>

        <hr class="my-6 border-fuel-black">

        <!-- Silver+ features -->
        <div class="text-xs text-gray-500 uppercase tracking-wide mb-2 px-3">Silver Features</div>
        <nav class="space-y-4 mb-6">
          <a href="#" data-feature="vehicle-verification" class="block py-2 px-3 rounded-lg border border-gray-600 hover:bg-fuel-black transition locked opacity-50 pointer-events-none">üïµÔ∏è Vehicle verification üîí</a>
          <a href="#" data-feature="station-data" class="block py-2 px-3 rounded-lg border border-gray-600 hover:bg-fuel-black transition locked opacity-50 pointer-events-none">üìä Station vehicle data üîí</a>
        </nav>

        <hr class="my-6 border-fuel-black">

        <!-- Coming soon -->
        <div class="text-xs text-gray-500 uppercase tracking-wide mb-2 px-3">Coming Soon</div>
        <nav class="space-y-4">
          <a href="#" class="block py-2 px-3 rounded-lg border border-gray-600 hover:bg-fuel-black transition locked opacity-50 pointer-events-none">üö® Smoke and fire detection üîí</a>
          <a href="#" class="block py-2 px-3 rounded-lg border border-gray-600 hover:bg-fuel-black transition locked opacity-50 pointer-events-none">üîé Number plate detection üîí</a>
        </nav>
      </div>

      <div class="mt-10">
          <!-- Pump Info -->
      <div class="mb-4">
        <p class="text-sm text-gray-400">Pump Name</p>
        <p class="font-semibold">{{ pump.name }}</p>
        <p class="text-sm text-gray-400">Location</p>
        <p class="font-semibold">{{ pump.location }}</p>
      </div>

      <!-- Subscription Info -->
    <div  class="subscription-info mb-4 text-sm text-gray-400">
      Subscription: <span class="font-semibold text-fuel-orange">Loading...</span>
    </div>


      <!-- Logged in User -->
      <div>
        <p class="text-sm text-gray-400 mb-2">Logged in as</p>
        <p class="font-semibold">{{ user.email }}</p>
      </div>
          </div>
        </aside>

    <!-- Mobile Sidebar -->
<div id="mobileSidebar" class="fixed inset-0 bg-black bg-opacity-70 z-40 lg:hidden opacity-0 invisible transition-opacity duration-300">
  <aside class="w-64 bg-fuel-gray h-full p-6 flex flex-col">
    <button id="closeMobileSidebar" class="mb-4 px-3 py-2 bg-fuel-orange rounded-lg font-semibold">Close</button>

    <!-- Scrollable menu -->
    <div class="flex-1 overflow-y-auto scrollable">
      <!-- Menu -->


      <!-- Main Navigation -->
      <nav class="space-y-4 mb-6">
        <a href="{{ url_for('pump.select_pump') }}" 
          class="block py-2 px-3 rounded-lg border border-fuel-orange hover:bg-fuel-black transition">
          ‚õΩ My Pumps</a>
        <a href="#" class="block py-2 px-3 rounded-lg border border-fuel-orange hover:bg-fuel-black transition">üí≥ Subscriptions</a>
        <a href="#" class="block py-2 px-3 rounded-lg border border-fuel-orange hover:bg-fuel-black transition">üë§ Profile</a>
      </nav>

      <hr class="my-4 border-fuel-black">

      <!-- Premium Features (Gold+) -->
      <div class="text-xs text-gray-500 uppercase tracking-wide mb-2 px-3">Gold Features</div>
      <nav class="space-y-4 mb-6">
        <a href="#" data-feature="receipts" class="block py-2 px-3 rounded-lg border border-gray-600 hover:bg-fuel-black transition locked opacity-50 pointer-events-none">üßæ Receipts üîí</a>
        <a href="#" data-feature="daily-comparison" class="block py-2 px-3 rounded-lg border border-gray-600 hover:bg-fuel-black transition locked opacity-50 pointer-events-none">üìà Daily Comparison üîí</a>
        <a href="#" data-feature="density-calculator" class="block py-2 px-3 rounded-lg border border-gray-600 hover:bg-fuel-black transition locked opacity-50 pointer-events-none">üß™ Density Calculator üîí</a>
      </nav>

      <hr class="my-4 border-fuel-black">

      <!-- Base Paid Features (Silver+) -->
      <div class="text-xs text-gray-500 uppercase tracking-wide mb-2 px-3">Silver Features</div>
      <nav class="space-y-4 mb-6">
        <a href="#" data-feature="vehicle-verification" class="block py-2 px-3 rounded-lg border border-gray-600 hover:bg-fuel-black transition locked opacity-50 pointer-events-none">üïµÔ∏è Vehicle verification üîí</a>
        <a href="#" data-feature="station-data" class="block py-2 px-3 rounded-lg border border-gray-600 hover:bg-fuel-black transition locked opacity-50 pointer-events-none">üìä Station vehicle data üîí</a>
      </nav>

      <hr class="my-6 border-fuel-black">

      <!-- Future Features (Coming Soon) -->
      <div class="text-xs text-gray-500 uppercase tracking-wide mb-2 px-3">Coming Soon</div>
      <nav class="space-y-4">
        <a href="#" class="block py-2 px-3 rounded-lg border border-gray-600 hover:bg-fuel-black transition locked opacity-50 pointer-events-none">üö® Smoke and fire detection üîí</a>
        <a href="#" class="block py-2 px-3 rounded-lg border border-gray-600 hover:bg-fuel-black transition locked opacity-50 pointer-events-none">üîé Number plate detection üîí</a>
      </nav>
    </div>

    <!-- Bottom info: Pump + User -->
    <div class="mt-auto border-t border-fuel-black pt-4 px-3">
      <!-- Pump Info -->
      <div class="mb-3">
        <p class="text-sm text-gray-400">Pump Name</p>
        <p class="font-semibold">{{ pump.name }}</p>
        <p class="text-sm text-gray-400 mt-2">Location</p>
        <p class="font-semibold">{{ pump.location }}</p>
      </div>

      <!-- Subscription Info -->
      <div class="subscription-info mb-4 text-sm text-gray-400">
        Subscription: <span class="font-semibold text-fuel-orange">Loading...</span>
      </div>


      <!-- Logged-in User -->
      <div>
        <p class="text-sm text-gray-400">Logged in as</p>
        <p class="font-semibold">{{ user.email }}</p>
      </div>
    </div>
  </aside>
</div>


        <!-- Main Content -->
        <main class="flex-1 bg-fuel-black p-6 flex flex-col overflow-y-auto">
          <header class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-fuel-orange">Welcome, {{ user.full_name }} üéâ</h1>
          </header>

          <div class="flex-1 bg-fuel-gray rounded-xl shadow-lg p-6 flex flex-col overflow-y-auto text-gray-300" 
              id="mainWorkspace"
              data-wallet-balance="{{ user.wallet_balance or 0.00 }}"
              data-add-funds-url="{{ url_for('wallet.add_funds') }}"
              data-balance-url="{{ url_for('wallet.get_balance') }}">
            <!-- Profile content will be loaded here by default -->
          </div>
        </main>



  </div>


  <script>
    // Toast
    function showToast(message, type) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.className = "";
      toast.classList.add("px-6","py-3","rounded-lg","text-white","font-semibold",
        "shadow-lg","fixed","transition-all","duration-500","ease-in-out");
      if(type === "success") toast.classList.add("bg-fuel-green");
      else if(type === "error") toast.classList.add("bg-fuel-red");
      else toast.classList.add("bg-fuel-gray");
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3000);
    }

    const flashedMessages = JSON.parse('{{ get_flashed_messages(with_categories=true)|tojson|safe }}');
    if (Array.isArray(flashedMessages) && flashedMessages.length) {
      flashedMessages.forEach(([category, message]) => showToast(message, category));
    }



    // Mobile Sidebar toggle
    const mobileSidebar = document.getElementById('mobileSidebar');
    const openMobileSidebarBtn = document.getElementById('openMobileSidebar');
    const closeMobileSidebarBtn = document.getElementById('closeMobileSidebar');

    openMobileSidebarBtn.addEventListener('click', () => {
      mobileSidebar.classList.remove('opacity-0','invisible');
      mobileSidebar.classList.add('opacity-100','visible');
    });
    closeMobileSidebarBtn.addEventListener('click', () => {
      mobileSidebar.classList.remove('opacity-100','visible');
      mobileSidebar.classList.add('opacity-0','invisible');
    });

    // Dynamic main content
    const mainContent = document.getElementById('mainWorkspace');
    const menuLinks = document.querySelectorAll('nav a');
    const walletBalance = mainContent.dataset.walletBalance;
    const pumpId = "{{ pump.id }}" || "";

    function getReceiptTemplate() {
      return `
      <div class="animate-fade-in flex flex-col gap-6">
        <div class="flex flex-col lg:flex-row gap-6">
          <div class="flex-1 bg-fuel-gray rounded-2xl p-6 shadow">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
              <div>
                <p class="text-sm uppercase tracking-wide text-gray-400">Receipt Management</p>
                <h2 class="text-2xl font-bold text-white">Upload Receipt</h2>
              </div>
              <button id="selectReceiptBtn" class="mt-4 md:mt-0 px-4 py-2 bg-fuel-orange text-white rounded-lg font-semibold shadow hover:bg-orange-500 transition">
                Select File
              </button>
            </div>
            <div id="receiptDropZone" class="border-2 border-dashed border-gray-600 rounded-2xl p-8 text-center cursor-pointer transition">
              <div class="text-5xl mb-4 text-fuel-orange">‚¨ÜÔ∏è</div>
              <p class="text-gray-200 font-semibold mb-2">Drag and drop your receipt</p>
              <p class="text-sm text-gray-400 mb-4">or click to browse files</p>
              <div class="flex justify-center">
                <div class="bg-fuel-black/40 px-4 py-2 rounded-lg text-sm text-gray-300">Supported: JPG / PNG</div>
              </div>
              <div id="selectedReceiptPreview" class="mt-6 hidden">
                <img id="receiptPreviewImage" src="" class="max-h-72 mx-auto rounded-lg shadow-lg object-contain" alt="Receipt preview">
                <p id="receiptFileName" class="mt-3 text-gray-300 text-sm"></p>
                <button id="changeReceiptBtn" type="button" class="mt-2 text-fuel-orange underline">Change File</button>
              </div>
              <input type="file" id="receiptFileInput" accept="image/*" class="hidden">
            </div>
            <button id="processReceiptBtn" class="mt-6 w-full bg-fuel-orange text-white py-3 rounded-xl font-semibold hover:bg-orange-500 transition disabled:opacity-40" disabled>
              Process Receipt
            </button>
          </div>

          <div class="w-full lg:w-1/3 bg-fuel-gray rounded-2xl p-6 shadow">
            <h3 class="text-xl font-semibold text-white mb-4">Extracted Data</h3>
            <div id="extractedDataContent" class="text-gray-300 text-sm">
              <p>No data yet. Upload a receipt to view details.</p>
            </div>
          </div>
        </div>

        <div class="bg-fuel-gray rounded-2xl p-6 shadow">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold text-white">Receipt History</h3>
            <button id="refreshHistoryBtn" class="text-sm text-fuel-orange underline hover:text-white">Refresh</button>
          </div>
          <div id="receiptHistoryList" class="space-y-3 text-sm text-gray-200">
            <p>No receipts uploaded yet.</p>
          </div>
        </div>
      </div>`;
    }

    function getComparisonTemplate() {
      return `
      <div class="animate-fade-in bg-fuel-gray rounded-2xl p-6 shadow space-y-6">
        <div id="comparisonSummary" class="grid gap-4 md:grid-cols-3 text-gray-200">
          <p>Loading comparison data...</p>
        </div>
        <div class="overflow-auto">
          <table class="w-full text-left text-sm text-gray-200">
            <thead class="text-gray-400 uppercase text-xs border-b border-gray-600">
              <tr>
                <th class="py-2">Nozzle</th>
                <th class="py-2">Latest Sales (‚Çπ)</th>
                <th class="py-2">Previous Sales (‚Çπ)</th>
                <th class="py-2">Net Change (‚Çπ)</th>
              </tr>
            </thead>
            <tbody id="comparisonTable">
              <tr><td colspan="4" class="py-4 text-center text-gray-400">Waiting for data...</td></tr>
            </tbody>
          </table>
        </div>
      </div>`;
    }

    function getDensityTemplate() {
      return `
      <div class="animate-fade-in bg-fuel-gray rounded-2xl p-6 shadow space-y-6">
        <div>
          <p class="text-sm uppercase tracking-wide text-gray-400">Density Conversion</p>
          <h2 class="text-2xl font-bold text-white">Fuel Density Standardization</h2>
          <p class="text-gray-300 text-sm mt-2">Convert recorded density to standard density at 15¬∞C.</p>
        </div>

        <form id="densityForm" class="grid gap-4 md:grid-cols-2">
          <div class="md:col-span-2">
            <label class="block text-gray-400 text-sm mb-1">Fuel Type</label>
            <select name="fuel_type" class="w-full bg-fuel-black text-white rounded-lg p-3 focus:outline-none">
              <option value="Petrol">Petrol</option>
              <option value="Diesel">Diesel</option>
            </select>
          </div>
          <div>
            <label class="block text-gray-400 text-sm mb-1">Current Density (g/cm¬≥)</label>
            <input type="number" step="0.0001" name="density" placeholder="0.82" class="w-full bg-fuel-black text-white rounded-lg p-3 focus:outline-none" required>
          </div>
          <div>
            <label class="block text-gray-400 text-sm mb-1">Current Temperature (¬∞C)</label>
            <input type="number" step="0.1" name="temperature" placeholder="25" class="w-full bg-fuel-black text-white rounded-lg p-3 focus:outline-none" required>
          </div>
          <div class="md:col-span-2">
            <button type="submit" class="w-full bg-fuel-orange hover:bg-orange-500 text-white font-semibold py-3 rounded-xl transition">
              Calculate Standard Density
            </button>
          </div>
        </form>

        <div class="bg-fuel-black/40 rounded-xl p-4 text-center">
          <p class="text-sm text-gray-400">Standard Density at 15¬∞C</p>
          <p id="densityResult" class="text-4xl font-bold text-white mt-2">--</p>
        </div>

        <div class="bg-fuel-black/30 rounded-xl p-4 text-sm text-gray-300 leading-relaxed">
          <h3 class="text-white font-semibold mb-2">How density changes with temperature</h3>
          <p>Petrol density drops by ~0.1% per ¬∞C while diesel by ~0.07% per ¬∞C. The calculator accounts for this to show the equivalent density at the standard reference temperature (15¬∞C).</p>
        </div>
      </div>`;
    }

    function renderExtractedData(data) {
      const container = document.getElementById('extractedDataContent');
      if (!container) return;

      if (!data) {
        container.innerHTML = '<p>No data yet. Upload a receipt to view details.</p>';
        return;
      }

      const nozzleHtml = (data.nozzles || [])
        .map(nozzle => `
          <div class="bg-fuel-black/40 rounded-lg p-3 mb-3">
            <p class="text-white font-semibold">Nozzle ${nozzle.nozzle || ''}</p>
            <p class="text-sm text-gray-300">A: ${nozzle.a || '--'}</p>
            <p class="text-sm text-gray-300">V: ${nozzle.v || '--'}</p>
            <p class="text-sm text-gray-300">Total Sales: ‚Çπ${nozzle.totSales || '--'}</p>
          </div>`).join('');

      container.innerHTML = `
        <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
          <div>
            <p class="text-gray-400">Print Date</p>
            <p class="text-white font-semibold">${data.printDate || '--'}</p>
          </div>
          <div>
            <p class="text-gray-400">Pump Serial Number</p>
            <p class="text-white font-semibold">${data.pumpSerialNumber || '--'}</p>
          </div>
          <div>
            <p class="text-gray-400">Model</p>
            <p class="text-white font-semibold">${data.model || '--'}</p>
          </div>
          <div>
            <p class="text-gray-400">Total Sales</p>
            <p class="text-white font-semibold">‚Çπ${(data.totalSales || 0).toLocaleString()}</p>
          </div>
        </div>
        <div class="space-y-3">${nozzleHtml || '<p class="text-gray-400 text-sm">No nozzle data captured.</p>'}</div>`;
    }

    async function loadReceiptHistory() {
      const list = document.getElementById('receiptHistoryList');
      if (!list || !pumpId) return;
      list.innerHTML = '<p class="text-gray-400">Loading history...</p>';
      try {
        const res = await fetch(`/pump/${pumpId}/receipt/history`, { credentials: 'same-origin' });
        const data = await res.json();
        if (res.ok && data.success && data.receipts.length) {
          list.innerHTML = data.receipts
            .map(record => {
              const encoded = encodeURIComponent(JSON.stringify(record));
              return `
              <div class="bg-fuel-black/40 rounded-lg p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-2">
                <div>
                  <p class="text-white font-semibold">${record.print_date || 'Unknown date'}</p>
                  <p class="text-gray-400 text-xs">Total Sales: ‚Çπ${(record.total_sales || 0).toLocaleString()}</p>
                </div>
                <button data-record='${encoded}' class="px-3 py-1 bg-fuel-orange text-white rounded-lg text-sm history-view-btn">
                  View
                </button>
              </div>
            `;
            })
            .join('');
          list.querySelectorAll('.history-view-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              const payload = JSON.parse(decodeURIComponent(btn.dataset.record || '{}'));
              renderExtractedData(payload.data);
              showToast('Loaded receipt snapshot.', 'success');
            });
          });
        } else {
          list.innerHTML = `<p class="text-gray-400 text-sm">${data.message || 'No receipts uploaded yet.'}</p>`;
        }
      } catch (err) {
        console.error(err);
        list.innerHTML = '<p class="text-red-400 text-sm">Failed to load history.</p>';
      }
    }

    function initReceiptSection() {
      const dropZone = document.getElementById('receiptDropZone');
      const fileInput = document.getElementById('receiptFileInput');
      const selectBtn = document.getElementById('selectReceiptBtn');
      const changeBtn = document.getElementById('changeReceiptBtn');
      const processBtn = document.getElementById('processReceiptBtn');
      const previewWrapper = document.getElementById('selectedReceiptPreview');
      const previewImage = document.getElementById('receiptPreviewImage');
      const previewName = document.getElementById('receiptFileName');
      const refreshBtn = document.getElementById('refreshHistoryBtn');
      let selectedFile = null;

      const setPreview = () => {
        if (selectedFile) {
          previewWrapper.classList.remove('hidden');
          previewImage.src = URL.createObjectURL(selectedFile);
          previewName.textContent = selectedFile.name;
          processBtn.disabled = false;
        } else {
          previewWrapper.classList.add('hidden');
          previewImage.src = '';
          previewName.textContent = '';
          processBtn.disabled = true;
        }
      };

      const handleFiles = files => {
        if (files && files.length) {
          selectedFile = files[0];
          setPreview();
        }
      };

      if (selectBtn) selectBtn.addEventListener('click', () => fileInput.click());
      if (changeBtn) changeBtn.addEventListener('click', () => fileInput.click());
      if (refreshBtn) refreshBtn.addEventListener('click', () => loadReceiptHistory());

      dropZone.addEventListener('click', () => fileInput.click());
      dropZone.addEventListener('dragover', e => {
        e.preventDefault();
        dropZone.classList.add('border-fuel-orange');
      });
      dropZone.addEventListener('dragleave', () => dropZone.classList.remove('border-fuel-orange'));
      dropZone.addEventListener('drop', e => {
        e.preventDefault();
        dropZone.classList.remove('border-fuel-orange');
        handleFiles(e.dataTransfer.files);
      });

      fileInput.addEventListener('change', e => handleFiles(e.target.files));

      processBtn.addEventListener('click', async () => {
        if (!selectedFile) {
          showToast('Please select a receipt image first.', 'error');
          return;
        }

        processBtn.disabled = true;
        processBtn.textContent = 'Processing...';

        try {
          const formData = new FormData();
          formData.append('receipt', selectedFile);
          
          // Add CSRF token for file upload
          const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
          if (csrfToken) {
            formData.append('csrf_token', csrfToken);
          }
          
          const res = await fetch(`/pump/${pumpId}/receipt/upload`, {
            method: 'POST',
            body: formData,
            credentials: 'same-origin',
            headers: {
              'X-CSRFToken': csrfToken || ''
            }
          });
          const data = await res.json();
          if (res.ok && data.success) {
            showToast('Receipt processed successfully!', 'success');
            renderExtractedData(data.data);
            await loadReceiptHistory();
          } else {
            showToast(data.error || 'Failed to process receipt', 'error');
          }
        } catch (err) {
          console.error(err);
          showToast('Unable to process receipt. Please try again.', 'error');
        } finally {
          processBtn.disabled = false;
          processBtn.textContent = 'Process Receipt';
        }
      });

      loadReceiptHistory();
      renderExtractedData(null);
    }

    async function initDailyComparison() {
      const summary = document.getElementById('comparisonSummary');
      const table = document.getElementById('comparisonTable');
      if (!pumpId) return;
      summary.innerHTML = '<p class="text-gray-400">Loading comparison data...</p>';
      table.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-400">Loading...</td></tr>';

      try {
        const res = await fetch(`/pump/${pumpId}/receipt/comparison`, { credentials: 'same-origin' });
        const data = await res.json();
        if (!res.ok || !data.success || data.message) {
          summary.innerHTML = `<p class="text-gray-400">${data.message || data.error || 'Upload at least two receipts to view comparison.'}</p>`;
          table.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-400">Not enough data.</td></tr>';
          return;
        }

        summary.innerHTML = `
          <div class="bg-fuel-black/40 rounded-xl p-4">
            <p class="text-xs text-gray-400">Latest Receipt</p>
            <p class="text-white font-semibold">${data.latest.print_date || '--'}</p>
            <p class="text-gray-300 text-sm">Total Sales: ‚Çπ${(data.latest.total_sales || 0).toLocaleString()}</p>
          </div>
          <div class="bg-fuel-black/40 rounded-xl p-4">
            <p class="text-xs text-gray-400">Previous Receipt</p>
            <p class="text-white font-semibold">${data.previous.print_date || '--'}</p>
            <p class="text-gray-300 text-sm">Total Sales: ‚Çπ${(data.previous.total_sales || 0).toLocaleString()}</p>
          </div>
          <div class="bg-green-600/30 rounded-xl p-4">
            <p class="text-xs text-gray-200">Net Change</p>
            <p class="text-2xl font-bold text-white">‚Çπ${(data.net_sales || 0).toLocaleString()}</p>
            <p class="text-gray-200 text-sm">Latest - Previous</p>
          </div>`;

        table.innerHTML = data.comparison.map(row => `
          <tr class="border-b border-gray-700">
            <td class="py-3">${row.nozzle}</td>
            <td class="py-3 text-green-300">‚Çπ${(row.current || 0).toLocaleString()}</td>
            <td class="py-3 text-gray-300">‚Çπ${(row.previous || 0).toLocaleString()}</td>
            <td class="py-3 ${row.difference >= 0 ? 'text-green-300' : 'text-red-400'}">‚Çπ${(row.difference || 0).toLocaleString()}</td>
          </tr>
        `).join('');
      } catch (err) {
        console.error(err);
        summary.innerHTML = '<p class="text-red-400">Failed to load comparison data.</p>';
        table.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-red-400">Error</td></tr>';
      }
    }

    function initDensityCalculator() {
      const form = document.getElementById('densityForm');
      const resultEl = document.getElementById('densityResult');
      if (!form) return;

      form.addEventListener('submit', async e => {
        e.preventDefault();
        const formData = new FormData(form);
        const payload = {
          fuel_type: formData.get('fuel_type'),
          density: formData.get('density'),
          temperature: formData.get('temperature')
        };
        resultEl.textContent = 'Calculating...';
        try {
          const res = await fetch(`/pump/${pumpId}/density/calculate`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            },
            credentials: 'same-origin',
            body: JSON.stringify(payload)
          });
          const data = await res.json();
          if (res.ok && data.success) {
            resultEl.textContent = `${data.standard_density} g/cm¬≥`;
            showToast('Standard density calculated.', 'success');
          } else {
            resultEl.textContent = '--';
            showToast(data.error || 'Failed to calculate density', 'error');
          }
        } catch (err) {
          console.error(err);
          resultEl.textContent = '--';
          showToast('Unable to calculate density.', 'error');
        }
      });
    }

    function updateMainContent(selected) {
      let content = '';
      switch(selected){
case 'üí≥ Subscriptions':
  mainContent.innerHTML = `
<style>
  /* Animation for fade-in */
  .animate-fade-in { animation: fadeIn 0.8s ease-in-out; }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(15px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Highlight selected duration */
  .selected-duration { background-color: #FFA500; color: black; }

  /* Bouncing emoji */
  .emoji-bounce {
    animation: bounce 1.2s infinite;
  }
  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-15px); }
  }

  /* Responsive Emoji size */
  .emoji-big {
    font-size: 6rem; /* default for medium screens */
    line-height: 1;
  }

  @media (min-width: 768px) {
    .emoji-big { font-size: 8rem; } /* larger screens */
  }
  @media (min-width: 1200px) {
    .emoji-big { font-size: 9rem; } /* extra large screens */
  }

  /* Wrapper for all plans */
  .plans-wrapper {
    display: flex;
    flex-wrap: wrap;       /* wrap to next line if not enough space */
    justify-content: space-between;
    gap: 1.5rem;
  }

  /* Each plan card */
  .plan-card {
    flex: 1 1 300px;       /* grow, shrink, base width */
    min-width: 250px;      /* minimum width before wrapping */
    display: flex;
    flex-direction: column;
    background-color: #2A2A2A; /* bg-fuel-gray */
    border: 2px solid #FF6B35; /* border-fuel-orange */
    border-radius: 1rem;
    padding: 1.5rem;
    transition: all 0.3s ease;
  }

  .plan-card:hover {
    transform: scale(1.05);
    box-shadow: 0 10px 20px rgba(0,0,0,0.25);
  }

  /* Inner content of each card */
  .plan-card-inner {
    display: flex;
    flex-direction: column;
    flex: 1;
    justify-content: space-between;
    text-align: center;
  }

  /* Subscribe button */
  .subscribe-btn {
    background-color: #2A2A2A;   /* dark background */
    color: #FF6B35;               /* fuel-orange text */
    font-weight: bold;
    border-radius: 1rem;
    border: 2px solid #FF6B35;    /* fuel-orange border */
    padding: 0.75rem 0;
    width: 100%;
    font-size: 1.125rem;
    transition: all 0.3s ease;
    cursor: pointer;
    margin-top: auto;
  }

  .subscribe-btn:hover {
    background-color: #FFA500;    /* orange on hover */
    color: black;
    transform: scale(1.05);
    box-shadow: 0 10px 20px rgba(0,0,0,0.25);
  }

  /* Optional: vertical stack on small screens */
  @media (max-width: 600px) {
    .plans-wrapper {
      flex-direction: column;
      align-items: center;
    }
  }
</style>

<div class="w-full max-w-6xl mx-auto px-4">
  <div class="plans-wrapper">

    <!-- Silver Plan -->
    <div class="plan-card">
      <div class="plan-card-inner">
        <div>
          <div class="emoji-big mb-4 emoji-bounce">‚ö™</div>
          <h3 class="text-2xl font-bold text-fuel-orange mb-4">Silver</h3>
          <ul class="flex justify-center flex-wrap gap-2 mb-5 duration-options">
            <li class="cursor-pointer px-3 py-1 rounded-md hover:bg-fuel-orange transition">1 Month</li>
            <li class="cursor-pointer px-3 py-1 rounded-md hover:bg-fuel-orange transition">6 Months</li>
            <li class="cursor-pointer px-3 py-1 rounded-md hover:bg-fuel-orange transition">Annual</li>
          </ul>
          <div class="text-gray-300 mb-5" data-base-price="5000">
            <h1 class="font-bold text-3xl price-display">‚Çπ5,000</h1>
            <h2 class="text-sm duration-display">per month</h2>
          </div>
          <ul class="space-y-2 text-base text-white text-left mb-6">
            <li class="flex items-start gap-2"><span>üî∏</span><span>Vehicle verification</span></li>
            <li class="flex items-start gap-2"><span>üî∏</span><span>Station vehicle data</span></li>
            <li class="flex items-start gap-2"><span>üî∏</span><span>Basic billing system</span></li>
            <li class="flex items-start gap-2"><span>üî∏</span><span><del>Smoke and fire detection</del></span></li>
            <li class="flex items-start gap-2"><span>üî∏</span><span><del>Number plate detection</del></span></li>
            <li class="flex items-start gap-2"><span>üî∏</span><span><del>Work monitoring</del></span></li>
            <li class="flex items-start gap-2"><span>üî∏</span><span><del>Hydrotesting system</del></span></li>
          </ul>
        </div>
        <button class="subscribe-btn" data-plan="Silver">Subscribe</button>
      </div>
    </div>

    <!-- Gold Plan -->
    <div class="plan-card">
      <div class="plan-card-inner">
        <div>
          <div class="emoji-big mb-4 emoji-bounce">ü™ô</div>
          <h3 class="text-2xl font-bold text-fuel-orange mb-4">Gold</h3>
          <ul class="flex justify-center flex-wrap gap-2 mb-5 duration-options">
            <li class="cursor-pointer px-3 py-1 rounded-md hover:bg-fuel-orange transition">1 Month</li>
            <li class="cursor-pointer px-3 py-1 rounded-md hover:bg-fuel-orange transition">6 Months</li>
            <li class="cursor-pointer px-3 py-1 rounded-md hover:bg-fuel-orange transition">Annual</li>
          </ul>
          <div class="text-gray-300 mb-5" data-base-price="10000">
            <h1 class="font-bold text-3xl price-display">‚Çπ10,000</h1>
            <h2 class="text-sm duration-display">per month</h2>
          </div>
          <ul class="space-y-2 text-base text-white text-left mb-6">
            <li class="flex items-start gap-2"><span>üî∏</span><span>Vehicle verification</span></li>
            <li class="flex items-start gap-2"><span>üî∏</span><span>Station vehicle data</span></li>
            <li class="flex items-start gap-2"><span>üî∏</span><span>Basic billing system</span></li>
            <li class="flex items-start gap-2"><span>üî∏</span><span>Smoke and fire detection</span></li>
            <li class="flex items-start gap-2"><span>üî∏</span><span>Number plate detection</span></li>
            <li class="flex items-start gap-2"><span>üî∏</span><span><del>Work monitoring</del></span></li>
            <li class="flex items-start gap-2"><span>üî∏</span><span><del>Hydrotesting system</del></span></li>
          </ul>
        </div>
        <button class="subscribe-btn" data-plan="Gold">Subscribe</button>
      </div>
    </div>

    <!-- Diamond Plan -->
    <div class="plan-card">
      <div class="plan-card-inner">
        <div>
          <div class="emoji-big mb-4 emoji-bounce">üíé</div>
          <h3 class="text-2xl font-bold text-fuel-orange mb-4">Diamond</h3>
          <ul class="flex justify-center flex-wrap gap-2 mb-5 duration-options">
            <li class="cursor-pointer px-3 py-1 rounded-md hover:bg-fuel-orange transition">1 Month</li>
            <li class="cursor-pointer px-3 py-1 rounded-md hover:bg-fuel-orange transition">6 Months</li>
            <li class="cursor-pointer px-3 py-1 rounded-md hover:bg-fuel-orange transition">Annual</li>
          </ul>
          <div class="text-gray-300 mb-5" data-base-price="15000">
            <h1 class="font-bold text-3xl price-display">‚Çπ15,000</h1>
            <h2 class="text-sm duration-display">per month</h2>
          </div>
          <ul class="space-y-2 text-base text-white text-left mb-6">
            <li class="flex items-start gap-2"><span>üî∏</span><span>Vehicle verification</span></li>
            <li class="flex items-start gap-2"><span>üî∏</span><span>Station vehicle data</span></li>
            <li class="flex items-start gap-2"><span>üî∏</span><span>Basic billing system</span></li>
            <li class="flex items-start gap-2"><span>üî∏</span><span>Smoke and fire detection</span></li>
            <li class="flex items-start gap-2"><span>üî∏</span><span>Number plate detection</span></li>
            <li class="flex items-start gap-2"><span>üî∏</span><span>Work monitoring</span></li>
            <li class="flex items-start gap-2"><span>üî∏</span><span>Hydrotesting system</span></li>
          </ul>
        </div>
        <button class="subscribe-btn" data-plan="Diamond">Subscribe</button>
      </div>
    </div>

  </div>
</div>

`;
  // ---- Duration Selection Logic ----
  document.querySelectorAll('.plan-card').forEach(card => {
    const durationOptions = card.querySelectorAll('.duration-options li');
    const priceContainer = card.querySelector('[data-base-price]');
    const priceDisplay = priceContainer.querySelector('.price-display');
    const durationDisplay = priceContainer.querySelector('.duration-display');
    const basePrice = parseInt(priceContainer.getAttribute('data-base-price'), 10);

    durationOptions.forEach(option => {
      option.addEventListener('click', function () {
        durationOptions.forEach(li => li.classList.remove('selected-duration'));
        this.classList.add('selected-duration');

        let multiplier = 1;
        const duration = this.textContent.trim();
        if (duration === '6 Months') multiplier = 6;
        else if (duration === 'Annual') multiplier = 12;

        const totalPrice = basePrice * multiplier;
        priceDisplay.textContent = '‚Çπ' + totalPrice.toLocaleString();
        durationDisplay.textContent = duration === '1 Month' ? 'per month' : 'for ' + duration;
      });
    });
  });

  document.querySelectorAll('.subscribe-btn').forEach(button => {
    button.addEventListener('click', async function () {
      const card = this.closest('.plan-card');
      const priceContainer = card.querySelector('[data-base-price]');
      const basePrice = parseInt(priceContainer.getAttribute('data-base-price'), 10);
      const durationText = priceContainer.querySelector('.duration-display').textContent.trim();
      
      // Determine duration string
      let duration = "1 Month";
      if (durationText.includes('6 Months')) duration = "6 Months";
      else if (durationText.includes('Annual')) duration = "Annual";
      
      const planName = this.dataset.plan || card.querySelector('h3').textContent.trim();
      const pumpId = "{{ pump.id }}";
      
      if (!pumpId) {
        showToast("Pump ID not found", "error");
        return;
      }

      // Disable button during processing
      this.disabled = true;
      this.textContent = "Processing...";

      try {
        // Step 1: Create Razorpay order via backend
        const orderResponse = await fetch("/subscription/create-order", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": document.querySelector('meta[name="csrf-token"]')?.content || ""
          },
          credentials: 'same-origin',
          body: JSON.stringify({
            plan_type: planName,
            duration: duration,
            pump_id: parseInt(pumpId)
          })
        });

        const orderData = await orderResponse.json();

        if (!orderData.success) {
          throw new Error(orderData.error || "Failed to create order");
        }

        // Step 2: Open Razorpay checkout
        const options = {
          key: orderData.key_id || "rzp_test_RLoVxeTmO0idx0",
          amount: orderData.amount,
          currency: orderData.currency || "INR",
          name: "Fuel Flux",
          description: `${planName} Subscription - ${duration}`,
          order_id: orderData.order_id,
          image: "{{ url_for('static', filename='images/logo2.png') }}",
          handler: async function (response) {
            // Step 3: Handle payment success
            try {
              const successResponse = await fetch("/subscription/payment-success", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "X-CSRFToken": document.querySelector('meta[name="csrf-token"]')?.content || ""
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                  razorpay_payment_id: response.razorpay_payment_id,
                  razorpay_order_id: response.razorpay_order_id,
                  razorpay_signature: response.razorpay_signature,
                  plan_type: planName,
                  duration: duration,
                  pump_id: parseInt(pumpId)
                })
              });

              const result = await successResponse.json();

              if (result.success) {
                showToast(result.message || "‚úÖ Subscription activated successfully!", "success");
                
                // Step 4: Refresh subscription status and unlock features
                try {
                  await unlockFeatures();
                } catch (unlockErr) {
                  console.warn("unlockFeatures error (non-critical):", unlockErr);
                }
                
                // Reload the subscription section to show updated status
                setTimeout(() => {
                  updateMainContent('üí≥ Subscriptions');
                  // Refresh features again after view change
                  setTimeout(() => unlockFeatures(), 500);
                }, 800);
              } else {
                showToast(result.error || "Payment succeeded but subscription activation failed", "error");
              }
            } catch (err) {
              console.error("Payment success handler error:", err);
              // Still try to unlock features even if there was an error
              try {
                await unlockFeatures();
                showToast("Payment completed. Refreshing subscription status...", "success");
                setTimeout(() => {
                  updateMainContent('üí≥ Subscriptions');
                  setTimeout(() => unlockFeatures(), 500);
                }, 800);
              } catch (unlockErr) {
                showToast("Payment successful but page refresh needed. Please reload the page.", "error");
              }
            }
          },
          prefill: {
            name: "{{ user.full_name }}",
            email: "{{ user.email }}",
            contact: ""
          },
          theme: { color: "#FF6B35" },
          modal: {
            ondismiss: function() {
              // Re-enable button if user closes payment modal
              button.disabled = false;
              button.textContent = "Subscribe";
            }
          }
        };

        const rzp = new Razorpay(options);
        rzp.on('payment.failed', function (response) {
          showToast("Payment failed: " + (response.error.description || "Unknown error"), "error");
          button.disabled = false;
          button.textContent = "Subscribe";
        });
        
        rzp.open();

      } catch (err) {
        console.error("Subscription error:", err);
        showToast(err.message || "Failed to initiate payment", "error");
        this.disabled = false;
        this.textContent = "Subscribe";
      }
    });
  });

  break;





        case 'üßæ Receipts':
          mainContent.innerHTML = getReceiptTemplate();
          initReceiptSection();
          break;

        case 'üìà Daily Comparison':
          mainContent.innerHTML = getComparisonTemplate();
          initDailyComparison();
          break;

        case 'üß™ Density Calculator':
          mainContent.innerHTML = getDensityTemplate();
          initDensityCalculator();
          break;

        case 'üë§ Profile':
          content = `
            <h2 class="text-2xl font-bold text-fuel-orange mb-4">Profile</h2>
            <div class="space-y-6">

              <!-- User Info -->
              <div class="bg-fuel-black p-4 rounded-lg shadow mb-6">
                <h3 class="text-lg font-semibold text-gray-200 mb-2">Your Information</h3>
                <p><span class="font-semibold">Full Name:</span> {{ user.full_name }}</p>
                <p><span class="font-semibold">Email:</span> {{ user.email }}</p>
              </div>

              <!-- Update Profile Form -->
              <div class="bg-fuel-black p-4 rounded-lg shadow mb-6">
                <h3 class="text-lg font-semibold text-gray-200 mb-3">Update Profile</h3>
                <form method="POST" action="{{ url_for('pump_dashboard.update_profile') }}" class="space-y-3">
                    
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                  <input type="text" name="full_name" value="{{ user.full_name }}" 
                         class="w-full p-2 rounded bg-fuel-gray text-white focus:outline-none" required>
                  <button type="submit" 
                          class="px-4 py-2 bg-fuel-orange hover:bg-orange-600 rounded-lg font-semibold">
                    Save Changes
                  </button>
                </form>
              </div>

              <!-- Change Password -->
              {% if user.password_hash %}
              <div class="bg-fuel-black p-4 rounded-lg shadow">
                <h3 class="text-lg font-semibold text-gray-200 mb-3">Change Password</h3>
                <form method="POST" action="{{ url_for('pump_dashboard.change_password') }}" class="space-y-3">
                  
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                  <input type="password" name="old_password" placeholder="Current Password" 
                         class="w-full p-2 rounded bg-fuel-gray text-white focus:outline-none" required>
                  <input type="password" name="new_password" placeholder="New Password" 
                         class="w-full p-2 rounded bg-fuel-gray text-white focus:outline-none" required>
                  <input type="password" name="confirm_password" placeholder="Confirm New Password" 
                         class="w-full p-2 rounded bg-fuel-gray text-white focus:outline-none" required>
                  <button type="submit" 
                          class="px-4 py-2 bg-fuel-orange hover:bg-orange-600 rounded-lg font-semibold">
                    Update Password
                  </button>
                </form>
              </div>
              {% else %}
                <p class="bg-yellow-500 bg-opacity-20 text-yellow-400 px-3 py-2 rounded text-sm">
                  Password change not available for OAuth users.</p>
              {% endif %}

            `;
          mainContent.innerHTML = content;
          break;
          
case 'üìä Station vehicle data':
  content = `
    <style>
      .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .btn {
        background-color: #FF6B35;
        color: white;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        transition: 0.3s;
      }
      .btn:hover { background-color: #E65A24; }
      .input-field {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
        margin-bottom: 10px;
        color: black;
      }
      .stat-card {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        padding: 20px;
        text-align: center;
        transition: all 0.25s ease-in-out;
      }
      .stat-card:hover {
        background: #fff7f3;
        border-color: #FF6B35;
        box-shadow: 0 2px 10px rgba(255,107,53,0.15);
        transform: translateY(-3px);
      }
      .stat-title { font-size: 1rem; color: #555; font-weight: 600; }
      .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #333;
        margin-top: 6px;
        transition: color 0.25s ease-in-out;
      }
      .stat-card:hover .stat-value { color: #FF6B35; }
      .stat-status {
        font-weight: 600;
        font-size: 1rem;
        margin-top: 8px;
        color: #666;
        transition: color 0.25s ease-in-out;
      }
      .stat-card:hover .stat-status { color: #E65A24; }
    </style>

    <div class="animate-fade-in bg-white p-6 rounded-2xl shadow-md w-full md:w-2/3 mx-auto mt-6">
      <h2 class="text-2xl font-semibold mb-4 text-gray-800">üì° Station Vehicle Data</h2>
      <p class="text-gray-600 mb-6">Add or update the RTSP stream URL for your CCTV camera feed.</p>

      <div id="rtspForm">
        <label class="block mb-2 text-gray-700 font-medium">RTSP Stream URL:</label>
        <input id="rtspUrl" type="text" class="input-field" placeholder="rtsp://username:password@ip_address:port/stream" />
        <button class="btn w-full" id="saveRtspBtn">üíæ Save RTSP URL</button>
      </div>

      <div id="currentRtspSection" class="hidden mt-6">
        <h3 class="text-lg font-semibold text-gray-700 mb-2">Current RTSP URL:</h3>
        <p id="currentRtspValue" class="bg-gray-100 p-3 rounded-lg font-bold text-gray-800 break-all border" style="border-color:#FF6B35;"></p>
        <button class="btn mt-4 w-full" id="editRtspBtn">‚úèÔ∏è Modify RTSP URL</button>
      </div>
    </div>

    <div id="vehicleCountSection" class="mt-10 bg-white p-6 rounded-2xl shadow-lg">
      <h3 class="text-2xl font-semibold text-gray-800 mb-6">üìà Live Vehicle Statistics</h3>

      <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-8">
        <div class="stat-card">
          <div class="stat-title">üöó Current Vehicles</div>
          <div id="liveVehicleCount" class="stat-value">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">üì∂ Station Status</div>
          <div id="liveStatus" class="stat-status">Loading...</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">‚è± Last Updated</div>
          <div id="lastUpdated" class="stat-status">--:--:--</div>
        </div>
      </div>

      <div class="bg-gradient-to-br from-orange-50 to-white p-4 rounded-xl shadow-inner">
        <h4 class="text-lg font-semibold text-gray-700 mb-2">üö¶ Vehicle Count Trend</h4>
        <canvas id="vehicleLineChart" height="180"></canvas>
      </div>
    </div>
  `;

  mainContent.innerHTML = content;

  (() => {
    const lineCtx = document.getElementById('vehicleLineChart').getContext('2d');
    const vehicleCountEl = document.getElementById('liveVehicleCount');
    const statusEl = document.getElementById('liveStatus');
    const lastUpdatedEl = document.getElementById('lastUpdated');

    const lineData = {
      labels: [],
      datasets: [{
        label: 'Vehicle Count',
        data: [],
        fill: true,
        backgroundColor: 'rgba(255,107,53,0.2)',
        borderColor: 'rgba(255,107,53,1)',
        borderWidth: 2,
        tension: 0.4,
        pointRadius: 3
      }]
    };

    const lineChart = new Chart(lineCtx, {
      type: 'line',
      data: lineData,
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { display: false },
          y: { title: { display: true, text: 'Vehicle Count' }, beginAtZero: true }
        }
      }
    });

    function getStatusFromCount(count) {
      if (count > 15) return { text: 'üö® Busy', color: 'red' };
      if (count > 7) return { text: '‚ö° Moderate', color: 'orange' };
      return { text: 'üü¢ Idle', color: 'green' };
    }

    async function fetchVehicleCount() {
      try {
        const res = await fetch(`/vehicle-count?pump_id={{ pump.id }}`, { credentials: 'same-origin' });
        if (!res.ok) return;
        const json = await res.json();
        const count = json.vehicle_count || 0;

        lineData.labels.push('');
        lineData.datasets[0].data.push(count);
        if (lineData.labels.length > 15) {
          lineData.labels.shift();
          lineData.datasets[0].data.shift();
        }
        lineChart.update();

        vehicleCountEl.textContent = count;
        const status = getStatusFromCount(count);
        statusEl.textContent = status.text;
        statusEl.style.color = status.color;
        lastUpdatedEl.textContent = new Date().toLocaleTimeString();
      } catch (err) {
        console.error('Error fetching vehicle count:', err);
      }
    }

    setInterval(fetchVehicleCount, 10000);
    fetchVehicleCount();
  })();

  (() => {
    const rtspInput = document.getElementById('rtspUrl');
    const saveBtn = document.getElementById('saveRtspBtn');
    const formDiv = document.getElementById('rtspForm');
    const currentDiv = document.getElementById('currentRtspSection');
    const currentValue = document.getElementById('currentRtspValue');
    const editBtn = document.getElementById('editRtspBtn');

    const pumpId = "{{ pump.id if pump else '' }}";
    const stationName = "{{ pump.name if pump else '' }}";
    const location = "{{ pump.location if pump else '' }}";
    const getRtspUrl = "{{ url_for('pump_dashboard.get_rtsp_streams') }}";
    const saveRtspUrl = "{{ url_for('pump_dashboard.save_rtsp') }}";
    const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

    let stationId = null;

    async function fetchCurrentRtsp() {
      try {
        const res = await fetch(getRtspUrl, { credentials: 'same-origin' });
        if (!res.ok) return;
        const data = await res.json();
        if (!data.success || !Array.isArray(data.stations)) return;

        const matched = data.stations.find(s =>
          (s.station_name || '').trim() === (stationName || '').trim() &&
          (s.location || '').trim() === (location || '').trim()
        );

        if (matched) {
          stationId = matched.station_id;
          if (matched.rtsp_url) {
            currentValue.textContent = matched.rtsp_url;
            formDiv.classList.add('hidden');
            currentDiv.classList.remove('hidden');
          }
        }
      } catch (err) {
        console.error('Error fetching RTSP streams:', err);
      }
    }

    async function saveRtsp() {
      const rtsp = rtspInput.value.trim();
      if (!rtsp.startsWith('rtsp://')) {
        alert('Please enter a valid RTSP URL.');
        return;
      }

      const payload = { station_name: stationName, location: location, rtsp_url: rtsp };
      if (stationId) payload.station_id = stationId;

      try {
        const res = await fetch(saveRtspUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
          body: JSON.stringify(payload),
          credentials: 'same-origin'
        });

        const data = await res.json();
        if (data.success) {
          if (data.station_id) stationId = data.station_id;
          currentValue.textContent = data.rtsp_url || rtsp;
          formDiv.classList.add('hidden');
          currentDiv.classList.remove('hidden');
          showToast(data.message || 'RTSP saved', 'success');
        } else {
          showToast(data.message || 'Failed to save RTSP', 'error');
        }
      } catch (err) {
        console.error('Error saving RTSP:', err);
        showToast('Something went wrong', 'error');
      }
    }

    saveBtn.addEventListener('click', e => {
      e.preventDefault();
      saveRtsp();
    });

    editBtn.addEventListener('click', () => {
      rtspInput.value = currentValue.textContent;
      formDiv.classList.remove('hidden');
      currentDiv.classList.add('hidden');
    });

    fetchCurrentRtsp();
  })();
  break;


case 'üïµÔ∏è Vehicle verification':
  content = `
    <style>
      .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .btn {
        background-color: #FF6B35;
        color: white;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        transition: 0.3s;
      }
      .btn:hover { background-color: #E65A24; }
      .input-field {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
        margin-bottom: 10px;
        color: black;
      }
    </style>

    <div class="animate-fade-in bg-white p-6 rounded-2xl shadow-md w-full md:w-2/3 mx-auto mt-6">
      <h2 class="text-2xl font-semibold mb-4 text-gray-800">üïµÔ∏è Vehicle Verification</h2>
      <p class="text-gray-600 mb-6">
        Add or update your vehicle verification video feed (RTSP URL for vehicle camera).
      </p>

      <div id="verificationForm">
        <label class="block mb-2 text-gray-700 font-medium">Vehicle Verification RTSP URL:</label>
        <input id="verificationRtspUrl" type="text" class="input-field" placeholder="rtsp://username:password@ip_address:port/vehicle_stream" />
        <button class="btn w-full" id="saveVerificationBtn">üíæ Save Verification RTSP</button>
      </div>

      <div id="currentVerificationSection" class="hidden mt-6">
        <h3 class="text-lg font-semibold text-gray-700 mb-2">Current Verification RTSP:</h3>
        <p id="currentVerificationValue" class="bg-gray-100 p-3 rounded-lg font-bold text-gray-800 break-all border" style="border-color:#FF6B35;"></p>
        <button class="btn mt-4 w-full" id="editVerificationBtn">‚úèÔ∏è Modify Verification RTSP</button>
      </div>

    </div>

<!-- --- Vehicle Detection Log --- -->
<div id="vehicleLogSection" class="mt-6 bg-gray-50 p-4 rounded-lg border border-gray-300 flex-1 overflow-y-auto">
  <h3 class="text-lg font-semibold text-gray-700 mb-2">Detected Number Plates:</h3>
  <ul id="vehicleLogList" class="text-gray-800 text-sm"></ul>
</div>


  `;

  mainContent.innerHTML = content;

  (() => {
  const rtspInput = document.getElementById('verificationRtspUrl');
  const saveBtn = document.getElementById('saveVerificationBtn');
  const formDiv = document.getElementById('verificationForm');
  const currentDiv = document.getElementById('currentVerificationSection');
  const currentValue = document.getElementById('currentVerificationValue');
  const editBtn = document.getElementById('editVerificationBtn');

  const getVerificationUrl = "{{ url_for('pump_dashboard.get_vehicle_verifications') }}";
  const saveVerificationUrl = "{{ url_for('pump_dashboard.save_vehicle_verification') }}";
  const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

  let verificationId = null;

  // Fetch current RTSP URL from server
  async function fetchCurrentVerification() {
    try {
      const res = await fetch(getVerificationUrl, { credentials: 'same-origin' });
      if (!res.ok) return console.error('Failed to fetch vehicle verifications:', res.status);

      const data = await res.json();
      if (!data.success || !Array.isArray(data.verifications)) return;

      const latest = data.verifications[0]; // pick the first station
      if (latest) {
        verificationId = latest.id; // store database id
        if (latest.rtsp_url) {
          currentValue.textContent = latest.rtsp_url;
          formDiv.classList.add('hidden');
          currentDiv.classList.remove('hidden');
        }
      }
    } catch (err) {
      console.error("Error fetching verification RTSP:", err);
    }
  }

  // Save or update RTSP URL
  async function saveVerification() {
    const rtsp = rtspInput.value.trim();
    if (!rtsp.startsWith('rtsp://')) return alert('Please enter a valid RTSP URL.');

    const payload = { rtsp_url: rtsp };
    if (verificationId) payload.id = verificationId; // include id for update

    try {
      const res = await fetch(saveVerificationUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(payload),
        credentials: 'same-origin'
      });

      const text = await res.text();
      try {
        const data = JSON.parse(text);
        if (!res.ok) {
          console.error('Server error response:', data);
          return showToast(data.message || 'Server error saving verification RTSP', 'error');
        }

        if (data.success) {
          verificationId = data.id || verificationId;
          currentValue.textContent = data.rtsp_url || rtsp;
          formDiv.classList.add('hidden');
          currentDiv.classList.remove('hidden');
          showToast(data.message || 'Verification RTSP saved', 'success');
        } else {
          showToast(data.message || 'Failed to save verification RTSP', 'error');
        }
      } catch (jsonErr) {
        console.error('Non-JSON server response:', text);
        showToast('Failed to save verification RTSP (server error)', 'error');
      }
    } catch (err) {
      console.error('Error saving verification RTSP:', err);
      showToast('Something went wrong', 'error');
    }
  }

  saveBtn.addEventListener('click', (e) => {
    e.preventDefault();
    saveVerification();
  });

  editBtn.addEventListener('click', () => {
    rtspInput.value = currentValue.textContent;
    formDiv.classList.remove('hidden');
    currentDiv.classList.add('hidden');
  });

  // Initial fetch
  fetchCurrentVerification();

  // ------------------------------
  // Vehicle detection log handling
  // ------------------------------
  const vehicleLogList = document.getElementById('vehicleLogList');

  function logDetectedPlate(plate) {
    if (!vehicleLogList) return;

    const li = document.createElement('li');
    li.textContent = `${new Date().toLocaleTimeString()} - ${plate}`;
    vehicleLogList.prepend(li);

    // Limit log entries to 50
    if (vehicleLogList.children.length > 50) {
      vehicleLogList.removeChild(vehicleLogList.lastChild);
    }
  }

  // Polling endpoint for latest detected plates every 2 seconds
  setInterval(async () => {
    try {
      const res = await fetch("/vehicle-details", { credentials: "same-origin" });
      if (!res.ok) return;
      const data = await res.json();
      if (data.success && Array.isArray(data.plates)) {
        data.plates.forEach(plate => logDetectedPlate(plate));
      }
    } catch (err) {
      console.error("Error fetching vehicle details:", err);
    }
  }, 2000);

})();

  break;



        default:
      }
    }

     menuLinks.forEach(link => {
  link.addEventListener('click', (e) => {
    const selected = e.target.textContent.trim();

          // If the feature is locked, show a toast and do nothing
          if (link.classList.contains('locked')) {
            e.preventDefault();
            showToast('Feature is locked üîí', 'error');
            return;
          }

          // If it's one of the dynamic sections, load it in main
          if (["üí≥ Subscriptions", "üë§ Profile", "üìä Station vehicle data","üïµÔ∏è Vehicle verification","üßæ Receipts","üìà Daily Comparison","üß™ Density Calculator"].includes(selected)) {
            e.preventDefault();
            updateMainContent(selected);
            localStorage.setItem('selectedSection', selected);

            // Close mobile sidebar if needed
            if (!link.closest('.lg\\:flex')) {
              mobileSidebar.classList.remove('opacity-100', 'visible');
              mobileSidebar.classList.add('opacity-0', 'invisible');
            }
          } 
          // Otherwise, allow normal navigation (like My Pumps)
          else {
            localStorage.removeItem('selectedSection');
            window.location.href = link.href;
          }
        });
      });




    // Default content
    const lastSection = localStorage.getItem('selectedSection') || 'üë§ Profile';
    updateMainContent(lastSection);
    unlockFeatures();
  </script>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</body>
</html>