<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <title>Dashboard - Fuel Flux</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/tailwind.css') }}">
  <style>
    #toast {
      position: fixed;
      top: -100px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 50;
      padding: 1rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 500;
      color: white;
      opacity: 0;
      transition: all 0.5s ease-in-out;
      min-width: 250px;
      text-align: center;
    }

    #toast.show {
      top: 2rem;
      opacity: 1;
    }


    .sidebar,
    .scrollable {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .sidebar::-webkit-scrollbar,
    .scrollable::-webkit-scrollbar {
      display: none;
      width: 0;
      height: 0;
    }

    .sidebar {
      overflow-y: auto;
    }
  </style>
</head>
<body class="bg-fuel-black text-white min-h-screen flex flex-col">

  <script>
    // Receipt, Comparison, Density functions must be declared before DOM loads
    function getReceiptTemplate() {
      return `
      <div class="animate-fade-in flex flex-col gap-6">
        <div class="flex flex-col lg:flex-row gap-6">
          <div class="flex-1 bg-fuel-gray rounded-2xl p-6 shadow">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
              <div>
                <p class="text-sm uppercase tracking-wide text-gray-400">Receipt Management</p>
                <h2 class="text-2xl font-bold text-white">Upload Receipt</h2>
              </div>
              <button id="selectReceiptBtn" class="mt-4 md:mt-0 px-4 py-2 bg-fuel-orange text-white rounded-lg font-semibold shadow hover:bg-orange-500 transition">
                Select File
              </button>
            </div>
            <div id="receiptDropZone" class="border-2 border-dashed border-gray-600 rounded-2xl p-8 text-center cursor-pointer transition">
              <div class="text-5xl mb-4 text-fuel-orange">‚¨ÜÔ∏è</div>
              <p class="text-gray-200 font-semibold mb-2">Drag and drop your receipt</p>
              <p class="text-sm text-gray-400 mb-4">or click to browse files</p>
              <div class="flex justify-center">
                <div class="bg-fuel-black/40 px-4 py-2 rounded-lg text-sm text-gray-300">Supported: JPG / PNG</div>
              </div>
              <div id="selectedReceiptPreview" class="mt-6 hidden">
                <img id="receiptPreviewImage" src="" class="max-h-72 mx-auto rounded-lg shadow-lg object-contain" alt="Receipt preview">
                <p id="receiptFileName" class="mt-3 text-gray-300 text-sm"></p>
                <button id="changeReceiptBtn" type="button" class="mt-2 text-fuel-orange underline">Change File</button>
              </div>
              <input type="file" id="receiptFileInput" accept="image/*" class="hidden">
            </div>
            <button id="processReceiptBtn" class="mt-6 w-full bg-fuel-orange text-white py-3 rounded-xl font-semibold hover:bg-orange-500 transition disabled:opacity-40" disabled>
              Process Receipt
            </button>
          </div>

          <div class="w-full lg:w-1/3 bg-fuel-gray rounded-2xl p-6 shadow">
            <h3 class="text-xl font-semibold text-white mb-4">Extracted Data</h3>
            <div id="extractedDataContent" class="text-gray-300 text-sm">
              <p>No data yet. Upload a receipt to view details.</p>
            </div>
          </div>
        </div>

        <div class="bg-fuel-gray rounded-2xl p-6 shadow">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold text-white">Receipt History</h3>
            <button id="refreshHistoryBtn" class="text-sm text-fuel-orange underline hover:text-white">Refresh</button>
          </div>
          <div id="receiptHistoryList" class="space-y-3 text-sm text-gray-200">
            <p>No receipts uploaded yet.</p>
          </div>
        </div>
      </div>`;
    }

    function getComparisonTemplate() {
      return `
      <div class="animate-fade-in bg-fuel-gray rounded-2xl p-6 shadow space-y-6">
        <div id="comparisonSummary" class="grid gap-4 md:grid-cols-3 text-gray-200">
          <p>Loading comparison data...</p>
        </div>
        <div class="overflow-auto">
          <table class="w-full text-left text-sm text-gray-200">
            <thead class="text-gray-400 uppercase text-xs border-b border-gray-600">
              <tr>
                <th class="py-2">Nozzle</th>
                <th class="py-2">Latest Sales (‚Çπ)</th>
                <th class="py-2">Previous Sales (‚Çπ)</th>
                <th class="py-2">Net Change (‚Çπ)</th>
              </tr>
            </thead>
            <tbody id="comparisonTable">
              <tr><td colspan="4" class="py-4 text-center text-gray-400">Waiting for data...</td></tr>
            </tbody>
          </table>
        </div>
      </div>`;
    }

    function getDensityTemplate() {
      return `
      <div class="animate-fade-in bg-fuel-gray rounded-2xl p-6 shadow space-y-6">
        <div>
          <p class="text-sm uppercase tracking-wide text-gray-400">Density Conversion</p>
          <h2 class="text-2xl font-bold text-white">Fuel Density Standardization</h2>
          <p class="text-gray-300 text-sm mt-2">Convert recorded density to standard density at 15¬∞C.</p>
        </div>

        <form id="densityForm" class="grid gap-4 md:grid-cols-2">
          <div class="md:col-span-2">
            <label class="block text-gray-400 text-sm mb-1">Fuel Type</label>
            <select name="fuel_type" class="w-full bg-fuel-black text-white rounded-lg p-3 focus:outline-none">
              <option value="Petrol">Petrol</option>
              <option value="Diesel">Diesel</option>
            </select>
          </div>
          <div>
            <label class="block text-gray-400 text-sm mb-1">Current Density (g/cm¬≥)</label>
            <input type="number" step="0.0001" name="density" placeholder="0.82" class="w-full bg-fuel-black text-white rounded-lg p-3 focus:outline-none" required>
          </div>
          <div>
            <label class="block text-gray-400 text-sm mb-1">Current Temperature (¬∞C)</label>
            <input type="number" step="0.1" name="temperature" placeholder="25" class="w-full bg-fuel-black text-white rounded-lg p-3 focus:outline-none" required>
          </div>
          <div class="md:col-span-2">
            <button type="submit" class="w-full bg-fuel-orange hover:bg-orange-500 text-white font-semibold py-3 rounded-xl transition">
              Calculate Standard Density
            </button>
          </div>
        </form>

        <div class="bg-fuel-black/40 rounded-xl p-4 text-center">
          <p class="text-sm text-gray-400">Standard Density at 15¬∞C</p>
          <p id="densityResult" class="text-4xl font-bold text-white mt-2">--</p>
        </div>

        <div class="bg-fuel-black/30 rounded-xl p-4 text-sm text-gray-300 leading-relaxed">
          <h3 class="text-white font-semibold mb-2">How density changes with temperature</h3>
          <p>Petrol density drops by ~0.1% per ¬∞C while diesel by ~0.07% per ¬∞C. The calculator accounts for this to show the equivalent density at the standard reference temperature (15¬∞C).</p>
        </div>
      </div>`;
    }

    function renderExtractedData(data) {
      const container = document.getElementById('extractedDataContent');
      if (!container) return;

      if (!data) {
        container.innerHTML = '<p>No data yet. Upload a receipt to view details.</p>';
        return;
      }

      const nozzleHtml = (data.nozzles || [])
        .map(nozzle => `
          <div class="bg-fuel-black/40 rounded-lg p-3 mb-3">
            <p class="text-white font-semibold">Nozzle ${nozzle.nozzle || ''}</p>
            <p class="text-sm text-gray-300">A: ${nozzle.a || '--'}</p>
            <p class="text-sm text-gray-300">V: ${nozzle.v || '--'}</p>
            <p class="text-sm text-gray-300">Total Sales: ‚Çπ${nozzle.totSales || '--'}</p>
          </div>`).join('');

      container.innerHTML = `
        <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
          <div>
            <p class="text-gray-400">Print Date</p>
            <p class="text-white font-semibold">${data.printDate || '--'}</p>
          </div>
          <div>
            <p class="text-gray-400">Pump Serial Number</p>
            <p class="text-white font-semibold">${data.pumpSerialNumber || '--'}</p>
          </div>
          <div>
            <p class="text-gray-400">Model</p>
            <p class="text-white font-semibold">${data.model || '--'}</p>
          </div>
          <div>
            <p class="text-gray-400">Total Sales</p>
            <p class="text-white font-semibold">‚Çπ${(data.totalSales || 0).toLocaleString()}</p>
          </div>
        </div>
        <div class="space-y-3">${nozzleHtml || '<p class="text-gray-400 text-sm">No nozzle data captured.</p>'}</div>`;
    }

    async function loadReceiptHistory() {
      const list = document.getElementById('receiptHistoryList');
      if (!list || !pumpId) return;
      list.innerHTML = '<p class="text-gray-400">Loading history...</p>';
      try {
        const res = await fetch(`/pump/${pumpId}/receipt/history`, { credentials: 'same-origin' });
        const data = await res.json();
        if (res.ok && data.success && data.receipts.length) {
          list.innerHTML = data.receipts
            .map(record => {
              const encoded = encodeURIComponent(JSON.stringify(record));
              return `
              <div class="bg-fuel-black/40 rounded-lg p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-2">
                <div>
                  <p class="text-white font-semibold">${record.print_date || 'Unknown date'}</p>
                  <p class="text-gray-400 text-xs">Total Sales: ‚Çπ${(record.total_sales || 0).toLocaleString()}</p>
                </div>
                <button data-record='${encoded}' class="px-3 py-1 bg-fuel-orange text-white rounded-lg text-sm history-view-btn">
                  View
                </button>
              </div>
            `;
            })
            .join('');
          list.querySelectorAll('.history-view-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              const payload = JSON.parse(decodeURIComponent(btn.dataset.record || '{}'));
              renderExtractedData(payload.data);
              showToast('Loaded receipt snapshot.', 'success');
            });
          });
        } else {
          list.innerHTML = `<p class="text-gray-400 text-sm">${data.message || 'No receipts uploaded yet.'}</p>`;
        }
      } catch (err) {
        console.error(err);
        list.innerHTML = '<p class="text-red-400 text-sm">Failed to load history.</p>';
      }
    }

    function initReceiptSection() {
      const dropZone = document.getElementById('receiptDropZone');
      const fileInput = document.getElementById('receiptFileInput');
      const selectBtn = document.getElementById('selectReceiptBtn');
      const changeBtn = document.getElementById('changeReceiptBtn');
      const processBtn = document.getElementById('processReceiptBtn');
      const previewWrapper = document.getElementById('selectedReceiptPreview');
      const previewImage = document.getElementById('receiptPreviewImage');
      const previewName = document.getElementById('receiptFileName');
      const refreshBtn = document.getElementById('refreshHistoryBtn');
      let selectedFile = null;

      const setPreview = () => {
        if (selectedFile) {
          previewWrapper.classList.remove('hidden');
          previewImage.src = URL.createObjectURL(selectedFile);
          previewName.textContent = selectedFile.name;
          processBtn.disabled = false;
        } else {
          previewWrapper.classList.add('hidden');
          previewImage.src = '';
          previewName.textContent = '';
          processBtn.disabled = true;
        }
      };

      const handleFiles = files => {
        if (files && files.length) {
          selectedFile = files[0];
          setPreview();
        }
      };

      if (selectBtn) selectBtn.addEventListener('click', () => fileInput.click());
      if (changeBtn) changeBtn.addEventListener('click', () => fileInput.click());
      if (refreshBtn) refreshBtn.addEventListener('click', () => loadReceiptHistory());

      dropZone.addEventListener('click', () => fileInput.click());
      dropZone.addEventListener('dragover', e => {
        e.preventDefault();
        dropZone.classList.add('border-fuel-orange');
      });
      dropZone.addEventListener('dragleave', () => dropZone.classList.remove('border-fuel-orange'));
      dropZone.addEventListener('drop', e => {
        e.preventDefault();
        dropZone.classList.remove('border-fuel-orange');
        handleFiles(e.dataTransfer.files);
      });

      fileInput.addEventListener('change', e => handleFiles(e.target.files));

      processBtn.addEventListener('click', async () => {
        if (!selectedFile) {
          showToast('Please select a receipt image first.', 'error');
          return;
        }

        processBtn.disabled = true;
        processBtn.textContent = 'Processing...';

        try {
          const formData = new FormData();
          formData.append('receipt', selectedFile);
          
          // Add CSRF token for file upload
          const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
          if (csrfToken) {
            formData.append('csrf_token', csrfToken);
          }
          
          const res = await fetch(`/pump/${pumpId}/receipt/upload`, {
            method: 'POST',
            body: formData,
            credentials: 'same-origin',
            headers: {
              'X-CSRFToken': csrfToken || ''
            }
          });
          const data = await res.json();
          if (res.ok && data.success) {
            showToast('Receipt processed successfully!', 'success');
            renderExtractedData(data.data);
            await loadReceiptHistory();
          } else {
            showToast(data.error || 'Failed to process receipt', 'error');
          }
        } catch (err) {
          console.error(err);
          showToast('Unable to process receipt. Please try again.', 'error');
        } finally {
          processBtn.disabled = false;
          processBtn.textContent = 'Process Receipt';
        }
      });

      loadReceiptHistory();
      renderExtractedData(null);
    }

    async function initDailyComparison() {
      const summary = document.getElementById('comparisonSummary');
      const table = document.getElementById('comparisonTable');
      if (!pumpId) return;
      summary.innerHTML = '<p class="text-gray-400">Loading comparison data...</p>';
      table.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-400">Loading...</td></tr>';

      try {
        const res = await fetch(`/pump/${pumpId}/receipt/comparison`, { credentials: 'same-origin' });
        const data = await res.json();
        if (!res.ok || !data.success || data.message) {
          summary.innerHTML = `<p class="text-gray-400">${data.message || data.error || 'Upload at least two receipts to view comparison.'}</p>`;
          table.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-400">Not enough data.</td></tr>';
          return;
        }

        summary.innerHTML = `
          <div class="bg-fuel-black/40 rounded-xl p-4">
            <p class="text-xs text-gray-400">Latest Receipt</p>
            <p class="text-white font-semibold">${data.latest.print_date || '--'}</p>
            <p class="text-gray-300 text-sm">Total Sales: ‚Çπ${(data.latest.total_sales || 0).toLocaleString()}</p>
          </div>
          <div class="bg-fuel-black/40 rounded-xl p-4">
            <p class="text-xs text-gray-400">Previous Receipt</p>
            <p class="text-white font-semibold">${data.previous.print_date || '--'}</p>
            <p class="text-gray-300 text-sm">Total Sales: ‚Çπ${(data.previous.total_sales || 0).toLocaleString()}</p>
          </div>
          <div class="bg-green-600/30 rounded-xl p-4">
            <p class="text-xs text-gray-200">Net Change</p>
            <p class="text-2xl font-bold text-white">‚Çπ${(data.net_sales || 0).toLocaleString()}</p>
            <p class="text-gray-200 text-sm">Latest - Previous</p>
          </div>`;

        table.innerHTML = data.comparison.map(row => `
          <tr class="border-b border-gray-700">
            <td class="py-3">${row.nozzle}</td>
            <td class="py-3 text-green-300">‚Çπ${(row.current || 0).toLocaleString()}</td>
            <td class="py-3 text-gray-300">‚Çπ${(row.previous || 0).toLocaleString()}</td>
            <td class="py-3 ${row.difference >= 0 ? 'text-green-300' : 'text-red-400'}">‚Çπ${(row.difference || 0).toLocaleString()}</td>
          </tr>
        `).join('');
      } catch (err) {
        console.error(err);
        summary.innerHTML = '<p class="text-red-400">Failed to load comparison data.</p>';
        table.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-red-400">Error</td></tr>';
      }
    }

    function initDensityCalculator() {
      const form = document.getElementById('densityForm');
      const resultEl = document.getElementById('densityResult');
      if (!form) return;

      form.addEventListener('submit', async e => {
        e.preventDefault();
        const formData = new FormData(form);
        const payload = {
          fuel_type: formData.get('fuel_type'),
          density: formData.get('density'),
          temperature: formData.get('temperature')
        };
        resultEl.textContent = 'Calculating...';
        try {
          const res = await fetch(`/pump/${pumpId}/density/calculate`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            },
            credentials: 'same-origin',
            body: JSON.stringify(payload)
          });
          const data = await res.json();
          if (res.ok && data.success) {
            resultEl.textContent = `${data.standard_density} g/cm¬≥`;
            showToast('Standard density calculated.', 'success');
          } else {
            resultEl.textContent = '--';
            showToast(data.error || 'Failed to calculate density', 'error');
          }
        } catch (err) {
          console.error(err);
          resultEl.textContent = '--';
          showToast('Unable to calculate density.', 'error');
        }
      });
    }

    async function unlockFeatures() {
      const pumpId = "{{ pump.id }}";
      if (!pumpId) return;

      try {
        const res = await fetch(`/subscription/current-subscription/${pumpId}`, {
          credentials: 'same-origin'
        });
        if (!res.ok) return;

        const data = await res.json();
        const rawPlan = (data.plan || '').toString().trim();
        const planKey = rawPlan.toLowerCase();
        const displayPlan = rawPlan ? (rawPlan.charAt(0).toUpperCase() + rawPlan.slice(1)) : 'Free Trial';

        document.querySelectorAll('.subscription-info span').forEach(span => {
          span.textContent = displayPlan;
        });

        const baseSelectors = '[data-feature="vehicle-verification"], [data-feature="station-data"]';
        const premiumSelectors = '[data-feature="receipts"], [data-feature="daily-comparison"], [data-feature="density-calculator"]';

        const activateLinks = selector => {
          document.querySelectorAll(selector).forEach(el => {
            el.classList.add('border-fuel-orange');
            el.classList.remove('border-gray-600');
            el.style.pointerEvents = 'auto';
          });
        };

        const basePlans = ['gold', 'diamond'];
        const premiumPlans = ['gold', 'diamond'];

        if (basePlans.includes(planKey)) {
          activateLinks(baseSelectors);
        }
        if (premiumPlans.includes(planKey)) {
          activateLinks(premiumSelectors);
        }

        window.currentSubscriptionPlan = planKey;
      } catch (err) {
        console.error('[unlockFeatures] fetch error', err);
        // Set default text if there was an error
        document.querySelectorAll('.subscription-info span').forEach(span => {
          span.textContent = 'Free Trial';
        });
      }
    }
  </script>

  <!-- Toast -->
  <div id="toast"></div>

  <!-- Header -->
  <header class="bg-fuel-gray p-2 md:p-4 shadow-md">
    <div class="flex justify-between items-center gap-2">
      <div class="flex items-center gap-1 md:gap-2 flex-1 min-w-0">
        <button id="openMobileSidebar" class="lg:hidden text-fuel-orange text-lg md:text-xl font-bold flex-shrink-0">‚ò∞</button>
        <img src="{{ url_for('static', filename='images/logo2.png') }}" 
             alt="Fuel Flux Logo" 
             class="h-6 md:h-10 w-auto flex-shrink-0"
             style="background: none !important; background-color: transparent !important; mix-blend-mode: screen;" />
        <span class="text-fuel-orange font-bold text-xs md:text-xl truncate hidden sm:inline">Dashboard</span>
      </div>
      <a href="/logout" class="bg-fuel-orange hover:bg-orange-600 px-2 py-1.5 md:px-4 md:py-2 rounded-lg font-semibold transition text-xs md:text-base whitespace-nowrap flex-shrink-0">
        Logout
      </a>
    </div>
  </header>

  <!-- Main Dashboard Layout -->
  <div class="flex flex-1 min-h-0 ">

    <!-- Sidebar (Desktop) -->
    <aside id="desktopSidebar" class="w-64 bg-fuel-gray flex flex-col justify-between p-6 hidden lg:flex sidebar">
      <div>
        <!-- Main navigation -->
        <nav class="space-y-4 mb-6">
          <a href="{{ url_for('pump.select_pump') }}" class="block py-2 px-3 rounded-lg border border-fuel-orange hover:bg-fuel-black transition">
            ‚õΩ My Pumps
          </a>
          
          <!-- Employee & Attendance Section -->
          <div class="space-y-2">
            <div class="text-xs text-gray-500 uppercase tracking-wide mb-2 px-3">üë• Employee & Attendance</div>
            <a href="{{ url_for('employee.employee_management', pump_id=pump.id) }}" class="block py-2 px-3 rounded-lg border border-fuel-orange hover:bg-fuel-black transition ml-2">
              üë§ Manage Employees
            </a>
            <a href="{{ url_for('attendance_monitor.monitor_page', pump_id=pump.id) }}" class="block py-2 px-3 rounded-lg border border-fuel-orange hover:bg-fuel-black transition ml-2">
              üìπ Live Monitor
            </a>
          </div>
          
          <a href="#" class="block py-2 px-3 rounded-lg border border-fuel-orange hover:bg-fuel-black transition">üí≥ Subscriptions</a>
          <a href="#" class="block py-2 px-3 rounded-lg border border-fuel-orange hover:bg-fuel-black transition">üí≥ Billing System</a>
          <a href="#" class="block py-2 px-3 rounded-lg border border-fuel-orange hover:bg-fuel-black transition">üë§ Profile</a>
        </nav>

        <hr class="my-6 border-fuel-black">

        <!-- Gold Features -->
        <div class="text-xs text-gray-500 uppercase tracking-wide mb-2 px-3">Gold Features</div>
        <nav class="space-y-4 mb-6">
          <a href="#" data-feature="receipts" class="block py-2 px-3 rounded-lg border border-gray-600 hover:bg-fuel-black transition">üßæ Receipts</a>
          <a href="#" data-feature="daily-comparison" class="block py-2 px-3 rounded-lg border border-gray-600 hover:bg-fuel-black transition">üìà Daily Comparison</a>
          <a href="#" data-feature="density-calculator" class="block py-2 px-3 rounded-lg border border-gray-600 hover:bg-fuel-black transition">üß™ Density Calculator</a>
        </nav>

        <hr class="my-6 border-fuel-black">

        <!-- Silver Features -->
        <div class="text-xs text-gray-500 uppercase tracking-wide mb-2 px-3">Silver Features</div>
        <nav class="space-y-4 mb-6">
          <a href="{{ url_for('vehicle_verification.vehicle_verification_page', pump_id=pump.id) }}" data-feature="vehicle-verification" class="block py-2 px-3 rounded-lg border border-gray-600 hover:bg-fuel-black transition">üïµÔ∏è Vehicle verification</a>
          <a href="{{ url_for('vehicle_count.station_vehicle_data_page', pump_id=pump.id) }}" data-feature="station-data" class="block py-2 px-3 rounded-lg border border-gray-600 hover:bg-fuel-black transition">üìä Station vehicle data</a>
          <a href="{{ url_for('hydrotesting.dashboard', pump_id=pump.id) }}" data-feature="hydrotesting" class="block py-2 px-3 rounded-lg border border-gray-600 hover:bg-fuel-black transition">üíß Hydrotesting</a>
        </nav>

      </div>

      <div class="mt-10">
          <!-- Pump Info -->
      <div class="mb-4">
        <p class="text-sm text-gray-400">Pump Name</p>
        <p class="font-semibold">{{ pump.name }}</p>
        <p class="text-sm text-gray-400">Location</p>
        <p class="font-semibold">{{ pump.location }}</p>
      </div>

      <!-- Subscription Info -->
    <div  class="subscription-info mb-4 text-sm text-gray-400">
      Subscription: <span class="font-semibold text-fuel-orange">Loading...</span>
    </div>


      <!-- Logged in User -->
      <div>
        <p class="text-sm text-gray-400 mb-2">Logged in as</p>
        <p class="font-semibold">{{ user.email }}</p>
      </div>
          </div>
        </aside>

    <!-- Mobile Sidebar -->
<div id="mobileSidebar" class="fixed inset-0 bg-black bg-opacity-70 z-40 lg:hidden opacity-0 invisible transition-opacity duration-300">
  <aside class="w-64 bg-fuel-gray h-full p-6 flex flex-col">
    <button id="closeMobileSidebar" class="mb-4 px-3 py-2 bg-fuel-orange rounded-lg font-semibold">Close</button>

    <!-- Scrollable menu -->
    <div class="flex-1 overflow-y-auto scrollable">
      <!-- Menu -->


      <!-- Main Navigation -->
      <nav class="space-y-4 mb-6">
        <a href="{{ url_for('pump.select_pump') }}" 
          class="block py-2 px-3 rounded-lg border border-fuel-orange hover:bg-fuel-black transition">
          ‚õΩ My Pumps</a>
        <a href="#" class="block py-2 px-3 rounded-lg border border-fuel-orange hover:bg-fuel-black transition">üí≥ Subscriptions</a>
        <a href="#" class="block py-2 px-3 rounded-lg border border-fuel-orange hover:bg-fuel-black transition">üë§ Profile</a>
      </nav>

      <hr class="my-4 border-fuel-black">

      <!-- Premium Features (Gold+) -->
      <div class="text-xs text-gray-500 uppercase tracking-wide mb-2 px-3">Gold Features</div>
      <nav class="space-y-4 mb-6">
        <a href="#" data-feature="receipts" class="block py-2 px-3 rounded-lg border border-gray-600 hover:bg-fuel-black transition">üßæ Receipts</a>
        <a href="#" data-feature="daily-comparison" class="block py-2 px-3 rounded-lg border border-gray-600 hover:bg-fuel-black transition">üìà Daily Comparison</a>
        <a href="#" data-feature="density-calculator" class="block py-2 px-3 rounded-lg border border-gray-600 hover:bg-fuel-black transition">üß™ Density Calculator</a>
      </nav>

      <hr class="my-4 border-fuel-black">

      <!-- Base Paid Features (Silver+) -->
      <div class="text-xs text-gray-500 uppercase tracking-wide mb-2 px-3">Silver Features</div>
      <nav class="space-y-4 mb-6">
        <a href="{{ url_for('vehicle_verification.vehicle_verification_page', pump_id=pump.id) }}" data-feature="vehicle-verification" class="block py-2 px-3 rounded-lg border border-fuel-orange hover:bg-fuel-black transition">üïµÔ∏è Vehicle verification</a>
        <a href="{{ url_for('vehicle_count.station_vehicle_data_page', pump_id=pump.id) }}" data-feature="station-data" class="block py-2 px-3 rounded-lg border border-fuel-orange hover:bg-fuel-black transition">üìä Station vehicle data</a>
        <a href="{{ url_for('hydrotesting.dashboard', pump_id=pump.id) }}" data-feature="hydrotesting" class="block py-2 px-3 rounded-lg border border-fuel-orange hover:bg-fuel-black transition">üíß Hydrotesting</a>
      </nav>

      <hr class="my-6 border-fuel-black">

    </div>

    <!-- Bottom info: Pump + User -->
    <div class="mt-auto border-t border-fuel-black pt-4 px-3">
      <!-- Pump Info -->
      <div class="mb-3">
        <p class="text-sm text-gray-400">Pump Name</p>
        <p class="font-semibold">{{ pump.name }}</p>
        <p class="text-sm text-gray-400 mt-2">Location</p>
        <p class="font-semibold">{{ pump.location }}</p>
      </div>

      <!-- Subscription Info -->
      <div class="subscription-info mb-4 text-sm text-gray-400">
        Subscription: <span class="font-semibold text-fuel-orange">Loading...</span>
      </div>


      <!-- Logged-in User -->
      <div>
        <p class="text-sm text-gray-400">Logged in as</p>
        <p class="font-semibold">{{ user.email }}</p>
      </div>
    </div>
  </aside>
</div>


        <!-- Main Content -->
        <main class="flex-1 bg-fuel-black p-3 md:p-6 flex flex-col overflow-y-auto">
          <header class="flex justify-between items-center mb-4 md:mb-6">
            <h1 class="text-xl md:text-3xl font-bold text-fuel-orange">Welcome, {{ user.full_name }} üéâ</h1>
          </header>

          <div class="flex-1 bg-fuel-gray rounded-xl shadow-lg p-4 md:p-6 flex flex-col overflow-y-auto text-gray-300" 
              id="mainWorkspace"
              data-wallet-balance="{{ user.wallet_balance or 0.00 }}"
              data-add-funds-url="{{ url_for('wallet.add_funds') }}"
              data-balance-url="{{ url_for('wallet.get_balance') }}">
            <!-- Profile content will be loaded here by default -->
          </div>
        </main>



  </div>


  <script>
    // Toast
    function showToast(message, type) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.className = "";
      toast.classList.add("px-6","py-3","rounded-lg","text-white","font-semibold",
        "shadow-lg","fixed","transition-all","duration-500","ease-in-out");
      if(type === "success") toast.classList.add("bg-fuel-green");
      else if(type === "error") toast.classList.add("bg-fuel-red");
      else toast.classList.add("bg-fuel-gray");
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3000);
    }

    const flashedMessages = JSON.parse('{{ get_flashed_messages(with_categories=true)|tojson|safe }}');
    if (Array.isArray(flashedMessages) && flashedMessages.length) {
      flashedMessages.forEach(([category, message]) => showToast(message, category));
    }



    // Mobile Sidebar toggle
    const mobileSidebar = document.getElementById('mobileSidebar');
    const openMobileSidebarBtn = document.getElementById('openMobileSidebar');
    const closeMobileSidebarBtn = document.getElementById('closeMobileSidebar');

    openMobileSidebarBtn.addEventListener('click', () => {
      mobileSidebar.classList.remove('opacity-0','invisible');
      mobileSidebar.classList.add('opacity-100','visible');
    });
    closeMobileSidebarBtn.addEventListener('click', () => {
      mobileSidebar.classList.remove('opacity-100','visible');
      mobileSidebar.classList.add('opacity-0','invisible');
    });

    // Dynamic main content
    const mainContent = document.getElementById('mainWorkspace');
    const menuLinks = document.querySelectorAll('nav a');
    const walletBalance = mainContent.dataset.walletBalance;
    const pumpId = "{{ pump.id }}" || "";

    function getReceiptTemplate() {
      return `
      <div class="animate-fade-in flex flex-col gap-6">
        <div class="flex flex-col lg:flex-row gap-6">
          <div class="flex-1 bg-fuel-gray rounded-2xl p-6 shadow">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
              <div>
                <p class="text-sm uppercase tracking-wide text-gray-400">Receipt Management</p>
                <h2 class="text-2xl font-bold text-white">Upload Receipt</h2>
              </div>
              <button id="selectReceiptBtn" class="mt-4 md:mt-0 px-4 py-2 bg-fuel-orange text-white rounded-lg font-semibold shadow hover:bg-orange-500 transition">
                Select File
              </button>
            </div>
            <div id="receiptDropZone" class="border-2 border-dashed border-gray-600 rounded-2xl p-8 text-center cursor-pointer transition">
              <div class="text-5xl mb-4 text-fuel-orange">‚¨ÜÔ∏è</div>
              <p class="text-gray-200 font-semibold mb-2">Drag and drop your receipt</p>
              <p class="text-sm text-gray-400 mb-4">or click to browse files</p>
              <div class="flex justify-center">
                <div class="bg-fuel-black/40 px-4 py-2 rounded-lg text-sm text-gray-300">Supported: JPG / PNG</div>
              </div>
              <div id="selectedReceiptPreview" class="mt-6 hidden">
                <img id="receiptPreviewImage" src="" class="max-h-72 mx-auto rounded-lg shadow-lg object-contain" alt="Receipt preview">
                <p id="receiptFileName" class="mt-3 text-gray-300 text-sm"></p>
                <button id="changeReceiptBtn" type="button" class="mt-2 text-fuel-orange underline">Change File</button>
              </div>
              <input type="file" id="receiptFileInput" accept="image/*" class="hidden">
            </div>
            <button id="processReceiptBtn" class="mt-6 w-full bg-fuel-orange text-white py-3 rounded-xl font-semibold hover:bg-orange-500 transition disabled:opacity-40" disabled>
              Process Receipt
            </button>
          </div>

          <div class="w-full lg:w-1/3 bg-fuel-gray rounded-2xl p-6 shadow">
            <h3 class="text-xl font-semibold text-white mb-4">Extracted Data</h3>
            <div id="extractedDataContent" class="text-gray-300 text-sm">
              <p>No data yet. Upload a receipt to view details.</p>
            </div>
          </div>
        </div>

        <div class="bg-fuel-gray rounded-2xl p-6 shadow">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold text-white">Receipt History</h3>
            <button id="refreshHistoryBtn" class="text-sm text-fuel-orange underline hover:text-white">Refresh</button>
          </div>
          <div id="receiptHistoryList" class="space-y-3 text-sm text-gray-200">
            <p>No receipts uploaded yet.</p>
          </div>
        </div>
      </div>`;
    }

    function getComparisonTemplate() {
      return `
      <div class="animate-fade-in bg-fuel-gray rounded-2xl p-6 shadow space-y-6">
        <div id="comparisonSummary" class="grid gap-4 md:grid-cols-3 text-gray-200">
          <p>Loading comparison data...</p>
        </div>
        <div class="overflow-auto">
          <table class="w-full text-left text-sm text-gray-200">
            <thead class="text-gray-400 uppercase text-xs border-b border-gray-600">
              <tr>
                <th class="py-2">Nozzle</th>
                <th class="py-2">Latest Sales (‚Çπ)</th>
                <th class="py-2">Previous Sales (‚Çπ)</th>
                <th class="py-2">Net Change (‚Çπ)</th>
              </tr>
            </thead>
            <tbody id="comparisonTable">
              <tr><td colspan="4" class="py-4 text-center text-gray-400">Waiting for data...</td></tr>
            </tbody>
          </table>
        </div>
      </div>`;
    }

    function getDensityTemplate() {
      return `
      <div class="animate-fade-in bg-fuel-gray rounded-2xl p-6 shadow space-y-6">
        <div>
          <p class="text-sm uppercase tracking-wide text-gray-400">Density Conversion</p>
          <h2 class="text-2xl font-bold text-white">Fuel Density Standardization</h2>
          <p class="text-gray-300 text-sm mt-2">Convert recorded density to standard density at 15¬∞C.</p>
        </div>

        <form id="densityForm" class="grid gap-4 md:grid-cols-2">
          <div class="md:col-span-2">
            <label class="block text-gray-400 text-sm mb-1">Fuel Type</label>
            <select name="fuel_type" class="w-full bg-fuel-black text-white rounded-lg p-3 focus:outline-none">
              <option value="Petrol">Petrol</option>
              <option value="Diesel">Diesel</option>
            </select>
          </div>
          <div>
            <label class="block text-gray-400 text-sm mb-1">Current Density (g/cm¬≥)</label>
            <input type="number" step="0.0001" name="density" placeholder="0.82" class="w-full bg-fuel-black text-white rounded-lg p-3 focus:outline-none" required>
          </div>
          <div>
            <label class="block text-gray-400 text-sm mb-1">Current Temperature (¬∞C)</label>
            <input type="number" step="0.1" name="temperature" placeholder="25" class="w-full bg-fuel-black text-white rounded-lg p-3 focus:outline-none" required>
          </div>
          <div class="md:col-span-2">
            <button type="submit" class="w-full bg-fuel-orange hover:bg-orange-500 text-white font-semibold py-3 rounded-xl transition">
              Calculate Standard Density
            </button>
          </div>
        </form>

        <div class="bg-fuel-black/40 rounded-xl p-4 text-center">
          <p class="text-sm text-gray-400">Standard Density at 15¬∞C</p>
          <p id="densityResult" class="text-4xl font-bold text-white mt-2">--</p>
        </div>

        <div class="bg-fuel-black/30 rounded-xl p-4 text-sm text-gray-300 leading-relaxed">
          <h3 class="text-white font-semibold mb-2">How density changes with temperature</h3>
          <p>Petrol density drops by ~0.1% per ¬∞C while diesel by ~0.07% per ¬∞C. The calculator accounts for this to show the equivalent density at the standard reference temperature (15¬∞C).</p>
        </div>
      </div>`;
    }

    function renderExtractedData(data) {
      const container = document.getElementById('extractedDataContent');
      if (!container) return;

      if (!data) {
        container.innerHTML = '<p>No data yet. Upload a receipt to view details.</p>';
        return;
      }

      const nozzleHtml = (data.nozzles || [])
        .map(nozzle => `
          <div class="bg-fuel-black/40 rounded-lg p-3 mb-3">
            <p class="text-white font-semibold">Nozzle ${nozzle.nozzle || ''}</p>
            <p class="text-sm text-gray-300">A: ${nozzle.a || '--'}</p>
            <p class="text-sm text-gray-300">V: ${nozzle.v || '--'}</p>
            <p class="text-sm text-gray-300">Total Sales: ‚Çπ${nozzle.totSales || '--'}</p>
          </div>`).join('');

      container.innerHTML = `
        <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
          <div>
            <p class="text-gray-400">Print Date</p>
            <p class="text-white font-semibold">${data.printDate || '--'}</p>
          </div>
          <div>
            <p class="text-gray-400">Pump Serial Number</p>
            <p class="text-white font-semibold">${data.pumpSerialNumber || '--'}</p>
          </div>
          <div>
            <p class="text-gray-400">Model</p>
            <p class="text-white font-semibold">${data.model || '--'}</p>
          </div>
          <div>
            <p class="text-gray-400">Total Sales</p>
            <p class="text-white font-semibold">‚Çπ${(data.totalSales || 0).toLocaleString()}</p>
          </div>
        </div>
        <div class="space-y-3">${nozzleHtml || '<p class="text-gray-400 text-sm">No nozzle data captured.</p>'}</div>`;
    }

    async function loadReceiptHistory() {
      const list = document.getElementById('receiptHistoryList');
      if (!list || !pumpId) return;
      list.innerHTML = '<p class="text-gray-400">Loading history...</p>';
      try {
        const res = await fetch(`/pump/${pumpId}/receipt/history`, { credentials: 'same-origin' });
        const data = await res.json();
        if (res.ok && data.success && data.receipts.length) {
          list.innerHTML = data.receipts
            .map(record => {
              const encoded = encodeURIComponent(JSON.stringify(record));
              return `
              <div class="bg-fuel-black/40 rounded-lg p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-2">
                <div>
                  <p class="text-white font-semibold">${record.print_date || 'Unknown date'}</p>
                  <p class="text-gray-400 text-xs">Total Sales: ‚Çπ${(record.total_sales || 0).toLocaleString()}</p>
                </div>
                <button data-record='${encoded}' class="px-3 py-1 bg-fuel-orange text-white rounded-lg text-sm history-view-btn">
                  View
                </button>
              </div>
            `;
            })
            .join('');
          list.querySelectorAll('.history-view-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              const payload = JSON.parse(decodeURIComponent(btn.dataset.record || '{}'));
              renderExtractedData(payload.data);
              showToast('Loaded receipt snapshot.', 'success');
            });
          });
        } else {
          list.innerHTML = `<p class="text-gray-400 text-sm">${data.message || 'No receipts uploaded yet.'}</p>`;
        }
      } catch (err) {
        console.error(err);
        list.innerHTML = '<p class="text-red-400 text-sm">Failed to load history.</p>';
      }
    }

    function initReceiptSection() {
      const dropZone = document.getElementById('receiptDropZone');
      const fileInput = document.getElementById('receiptFileInput');
      const selectBtn = document.getElementById('selectReceiptBtn');
      const changeBtn = document.getElementById('changeReceiptBtn');
      const processBtn = document.getElementById('processReceiptBtn');
      const previewWrapper = document.getElementById('selectedReceiptPreview');
      const previewImage = document.getElementById('receiptPreviewImage');
      const previewName = document.getElementById('receiptFileName');
      const refreshBtn = document.getElementById('refreshHistoryBtn');
      let selectedFile = null;

      const setPreview = () => {
        if (selectedFile) {
          previewWrapper.classList.remove('hidden');
          previewImage.src = URL.createObjectURL(selectedFile);
          previewName.textContent = selectedFile.name;
          processBtn.disabled = false;
        } else {
          previewWrapper.classList.add('hidden');
          previewImage.src = '';
          previewName.textContent = '';
          processBtn.disabled = true;
        }
      };

      const handleFiles = files => {
        if (files && files.length) {
          selectedFile = files[0];
          setPreview();
        }
      };

      if (selectBtn) selectBtn.addEventListener('click', () => fileInput.click());
      if (changeBtn) changeBtn.addEventListener('click', () => fileInput.click());
      if (refreshBtn) refreshBtn.addEventListener('click', () => loadReceiptHistory());

      dropZone.addEventListener('click', () => fileInput.click());
      dropZone.addEventListener('dragover', e => {
        e.preventDefault();
        dropZone.classList.add('border-fuel-orange');
      });
      dropZone.addEventListener('dragleave', () => dropZone.classList.remove('border-fuel-orange'));
      dropZone.addEventListener('drop', e => {
        e.preventDefault();
        dropZone.classList.remove('border-fuel-orange');
        handleFiles(e.dataTransfer.files);
      });

      fileInput.addEventListener('change', e => handleFiles(e.target.files));

      processBtn.addEventListener('click', async () => {
        if (!selectedFile) {
          showToast('Please select a receipt image first.', 'error');
          return;
        }

        processBtn.disabled = true;
        processBtn.textContent = 'Processing...';

        try {
          const formData = new FormData();
          formData.append('receipt', selectedFile);
          
          // Add CSRF token for file upload
          const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
          if (csrfToken) {
            formData.append('csrf_token', csrfToken);
          }
          
          const res = await fetch(`/pump/${pumpId}/receipt/upload`, {
            method: 'POST',
            body: formData,
            credentials: 'same-origin',
            headers: {
              'X-CSRFToken': csrfToken || ''
            }
          });
          const data = await res.json();
          if (res.ok && data.success) {
            showToast('Receipt processed successfully!', 'success');
            renderExtractedData(data.data);
            await loadReceiptHistory();
          } else {
            showToast(data.error || 'Failed to process receipt', 'error');
          }
        } catch (err) {
          console.error(err);
          showToast('Unable to process receipt. Please try again.', 'error');
        } finally {
          processBtn.disabled = false;
          processBtn.textContent = 'Process Receipt';
        }
      });

      loadReceiptHistory();
      renderExtractedData(null);
    }

    async function initDailyComparison() {
      const summary = document.getElementById('comparisonSummary');
      const table = document.getElementById('comparisonTable');
      if (!pumpId) return;
      summary.innerHTML = '<p class="text-gray-400">Loading comparison data...</p>';
      table.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-400">Loading...</td></tr>';

      try {
        const res = await fetch(`/pump/${pumpId}/receipt/comparison`, { credentials: 'same-origin' });
        const data = await res.json();
        if (!res.ok || !data.success || data.message) {
          summary.innerHTML = `<p class="text-gray-400">${data.message || data.error || 'Upload at least two receipts to view comparison.'}</p>`;
          table.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-400">Not enough data.</td></tr>';
          return;
        }

        summary.innerHTML = `
          <div class="bg-fuel-black/40 rounded-xl p-4">
            <p class="text-xs text-gray-400">Latest Receipt</p>
            <p class="text-white font-semibold">${data.latest.print_date || '--'}</p>
            <p class="text-gray-300 text-sm">Total Sales: ‚Çπ${(data.latest.total_sales || 0).toLocaleString()}</p>
          </div>
          <div class="bg-fuel-black/40 rounded-xl p-4">
            <p class="text-xs text-gray-400">Previous Receipt</p>
            <p class="text-white font-semibold">${data.previous.print_date || '--'}</p>
            <p class="text-gray-300 text-sm">Total Sales: ‚Çπ${(data.previous.total_sales || 0).toLocaleString()}</p>
          </div>
          <div class="bg-green-600/30 rounded-xl p-4">
            <p class="text-xs text-gray-200">Net Change</p>
            <p class="text-2xl font-bold text-white">‚Çπ${(data.net_sales || 0).toLocaleString()}</p>
            <p class="text-gray-200 text-sm">Latest - Previous</p>
          </div>`;

        table.innerHTML = data.comparison.map(row => `
          <tr class="border-b border-gray-700">
            <td class="py-3">${row.nozzle}</td>
            <td class="py-3 text-green-300">‚Çπ${(row.current || 0).toLocaleString()}</td>
            <td class="py-3 text-gray-300">‚Çπ${(row.previous || 0).toLocaleString()}</td>
            <td class="py-3 ${row.difference >= 0 ? 'text-green-300' : 'text-red-400'}">‚Çπ${(row.difference || 0).toLocaleString()}</td>
          </tr>
        `).join('');
      } catch (err) {
        console.error(err);
        summary.innerHTML = '<p class="text-red-400">Failed to load comparison data.</p>';
        table.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-red-400">Error</td></tr>';
      }
    }

    function initDensityCalculator() {
      const form = document.getElementById('densityForm');
      const resultEl = document.getElementById('densityResult');
      if (!form) return;

      form.addEventListener('submit', async e => {
        e.preventDefault();
        const formData = new FormData(form);
        const payload = {
          fuel_type: formData.get('fuel_type'),
          density: formData.get('density'),
          temperature: formData.get('temperature')
        };
        resultEl.textContent = 'Calculating...';
        try {
          const res = await fetch(`/pump/${pumpId}/density/calculate`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            },
            credentials: 'same-origin',
            body: JSON.stringify(payload)
          });
          const data = await res.json();
          if (res.ok && data.success) {
            resultEl.textContent = `${data.standard_density} g/cm¬≥`;
            showToast('Standard density calculated.', 'success');
          } else {
            resultEl.textContent = '--';
            showToast(data.error || 'Failed to calculate density', 'error');
          }
        } catch (err) {
          console.error(err);
          resultEl.textContent = '--';
          showToast('Unable to calculate density.', 'error');
        }
      });
    }

    function updateMainContent(selected) {
      let content = '';
      switch(selected){
case 'üí≥ Subscriptions':
  mainContent.innerHTML = `
<!-- Pending Payment Notice (will be populated if exists) -->
<div id="pendingPaymentNotice" class="mb-6"></div>

<style>
  /* Animation for fade-in */
  .animate-fade-in { animation: fadeIn 0.8s ease-in-out; }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(15px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Highlight selected duration */
  .selected-duration { background-color: #FFA500; color: black; }

  /* Bouncing emoji */
  .emoji-bounce {
    animation: bounce 1.2s infinite;
  }
  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-15px); }
  }

  /* Responsive Emoji size */
  .emoji-big {
    font-size: 6rem; /* default for medium screens */
    line-height: 1;
  }

  @media (min-width: 768px) {
    .emoji-big { font-size: 8rem; } /* larger screens */
  }
  @media (min-width: 1200px) {
    .emoji-big { font-size: 9rem; } /* extra large screens */
  }

  /* Wrapper for all plans */
  .plans-wrapper {
    display: flex;
    flex-wrap: wrap;       /* wrap to next line if not enough space */
    justify-content: space-between;
    gap: 1.5rem;
  }

  /* Each plan card */
  .plan-card {
    flex: 1 1 300px;       /* grow, shrink, base width */
    min-width: 250px;      /* minimum width before wrapping */
    display: flex;
    flex-direction: column;
    background-color: #2A2A2A; /* bg-fuel-gray */
    border: 2px solid #FF6B35; /* border-fuel-orange */
    border-radius: 1rem;
    padding: 1.5rem;
    transition: all 0.3s ease;
  }

  .plan-card:hover {
    transform: scale(1.05);
    box-shadow: 0 10px 20px rgba(0,0,0,0.25);
  }

  /* Inner content of each card */
  .plan-card-inner {
    display: flex;
    flex-direction: column;
    flex: 1;
    justify-content: space-between;
    text-align: center;
  }

  /* Subscribe button */
  .subscribe-btn {
    background-color: #2A2A2A;   /* dark background */
    color: #FF6B35;               /* fuel-orange text */
    font-weight: bold;
    border-radius: 1rem;
    border: 2px solid #FF6B35;    /* fuel-orange border */
    padding: 0.75rem 0;
    width: 100%;
    font-size: 1.125rem;
    transition: all 0.3s ease;
    cursor: pointer;
    margin-top: auto;
  }

  .subscribe-btn:hover {
    background-color: #FFA500;    /* orange on hover */
    color: black;
    transform: scale(1.05);
    box-shadow: 0 10px 20px rgba(0,0,0,0.25);
  }

  /* Optional: vertical stack on small screens */
  @media (max-width: 600px) {
    .plans-wrapper {
      flex-direction: column;
      align-items: center;
    }
  }
</style>

<div class="w-full max-w-6xl mx-auto px-4">
  <div class="plans-wrapper">

    <!-- Gold Plan (formerly Silver - 5k) -->
    <div class="plan-card">
      <div class="plan-card-inner">
        <div>
          <div class="emoji-big mb-4 emoji-bounce">ü™ô</div>
          <h3 class="text-2xl font-bold text-fuel-orange mb-4">Gold</h3>
          <ul class="flex justify-center flex-wrap gap-2 mb-5 duration-options">
            <li class="cursor-pointer px-3 py-1 rounded-md hover:bg-fuel-orange transition">1 Month</li>
            <li class="cursor-pointer px-3 py-1 rounded-md hover:bg-fuel-orange transition">6 Months</li>
            <li class="cursor-pointer px-3 py-1 rounded-md hover:bg-fuel-orange transition">Annual</li>
          </ul>
          <div class="text-gray-300 mb-5" data-base-price="5000">
            <h1 class="font-bold text-3xl price-display">‚Çπ5,000</h1>
            <h2 class="text-sm duration-display">or volume</h2>
          </div>
          <ul class="space-y-2 text-base text-white text-left mb-6">
            <li class="flex items-start gap-2"><span>üî∏</span><span>Vehicle verification</span></li>
            <li class="flex items-start gap-2"><span>üî∏</span><span>Station vehicle data</span></li>
            <li class="flex items-start gap-2"><span>üî∏</span><span>Basic billing system</span></li>
            <li class="flex items-start gap-2"><span>üî∏</span><span>Smoke and fire detection</span></li>
            <li class="flex items-start gap-2"><span>üî∏</span><span>Number plate detection</span></li>
            <li class="flex items-start gap-2"><span>üî∏</span><span><del>Work monitoring</del></span></li>
            <li class="flex items-start gap-2"><span>üî∏</span><span><del>Hydrotesting system</del></span></li>
          </ul>
        </div>
        <button class="subscribe-btn" data-plan="Gold">Subscribe</button>
      </div>
    </div>

    <!-- Diamond Plan -->
    <div class="plan-card">
      <div class="plan-card-inner">
        <div>
          <div class="emoji-big mb-4 emoji-bounce">üíé</div>
          <h3 class="text-2xl font-bold text-fuel-orange mb-4">Diamond</h3>
          <ul class="flex justify-center flex-wrap gap-2 mb-5 duration-options">
            <li class="cursor-pointer px-3 py-1 rounded-md hover:bg-fuel-orange transition">1 Month</li>
            <li class="cursor-pointer px-3 py-1 rounded-md hover:bg-fuel-orange transition">6 Months</li>
            <li class="cursor-pointer px-3 py-1 rounded-md hover:bg-fuel-orange transition">Annual</li>
          </ul>
          <div class="text-gray-300 mb-5" data-base-price="15000">
            <h1 class="font-bold text-3xl price-display">‚Çπ15,000</h1>
            <h2 class="text-sm duration-display">per month</h2>
          </div>
          <ul class="space-y-2 text-base text-white text-left mb-6">
            <li class="flex items-start gap-2"><span>üî∏</span><span>Vehicle verification</span></li>
            <li class="flex items-start gap-2"><span>üî∏</span><span>Station vehicle data</span></li>
            <li class="flex items-start gap-2"><span>üî∏</span><span>Basic billing system</span></li>
            <li class="flex items-start gap-2"><span>üî∏</span><span>Smoke and fire detection</span></li>
            <li class="flex items-start gap-2"><span>üî∏</span><span>Number plate detection</span></li>
            <li class="flex items-start gap-2"><span>üî∏</span><span>Work monitoring</span></li>
            <li class="flex items-start gap-2"><span>üî∏</span><span>Hydrotesting system</span></li>
          </ul>
        </div>
        <button class="subscribe-btn" data-plan="Diamond">Subscribe</button>
      </div>
    </div>

  </div>
</div>

`;
  // ---- Duration Selection Logic ----
  document.querySelectorAll('.plan-card').forEach(card => {
    const durationOptions = card.querySelectorAll('.duration-options li');
    const priceContainer = card.querySelector('[data-base-price]');
    const priceDisplay = priceContainer.querySelector('.price-display');
    const durationDisplay = priceContainer.querySelector('.duration-display');
    const basePrice = parseInt(priceContainer.getAttribute('data-base-price'), 10);

    durationOptions.forEach(option => {
      option.addEventListener('click', function () {
        durationOptions.forEach(li => li.classList.remove('selected-duration'));
        this.classList.add('selected-duration');

        let multiplier = 1;
        const duration = this.textContent.trim();
        if (duration === '6 Months') multiplier = 6;
        else if (duration === 'Annual') multiplier = 12;

        const totalPrice = basePrice * multiplier;
        priceDisplay.textContent = '‚Çπ' + totalPrice.toLocaleString();
        // Check if this is Gold plan (5k) - show "or volume" instead of duration
        const planName = card.querySelector('h3').textContent.trim();
        if (planName === 'Gold' && basePrice === 5000) {
          durationDisplay.textContent = 'or volume';
        } else {
          durationDisplay.textContent = duration === '1 Month' ? 'per month' : 'for ' + duration;
        }
      });
    });
  });

  document.querySelectorAll('.subscribe-btn').forEach(button => {
    button.addEventListener('click', async function () {
      const card = this.closest('.plan-card');
      const priceContainer = card.querySelector('[data-base-price]');
      const basePrice = parseInt(priceContainer.getAttribute('data-base-price'), 10);
      const durationText = priceContainer.querySelector('.duration-display').textContent.trim();
      
      // Determine duration string
      let duration = "1 Month";
      if (durationText.includes('6 Months')) duration = "6 Months";
      else if (durationText.includes('Annual')) duration = "Annual";
      
      const planName = this.dataset.plan || card.querySelector('h3').textContent.trim();
      const pumpId = "{{ pump.id }}";
      
      if (!pumpId) {
        showToast("Pump ID not found", "error");
        return;
      }

      // Calculate total price
      let multiplier = 1;
      if (duration === '6 Months') multiplier = 6;
      else if (duration === 'Annual') multiplier = 12;
      const totalPrice = basePrice * multiplier;

      // SHOW QR CODE PAYMENT MODAL (Manual Payment)
      showQRPaymentModal(planName, duration, totalPrice, pumpId);
      return;

      // OLD CODE: Razorpay integration (commented out for now)
      /* 
      // Disable button during processing
      this.disabled = true;
      this.textContent = "Processing...";

      try {
        // Step 1: Create Razorpay order via backend
        const orderResponse = await fetch("/subscription/create-order", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": document.querySelector('meta[name="csrf-token"]')?.content || ""
          },
          credentials: 'same-origin',
          body: JSON.stringify({
            plan_type: planName,
            duration: duration,
            pump_id: parseInt(pumpId)
          })
        });

        const orderData = await orderResponse.json();

        if (!orderData.success) {
          throw new Error(orderData.error || "Failed to create order");
        }

        // Step 2: Open Razorpay checkout
        const options = {
          key: orderData.key_id || "rzp_test_RLoVxeTmO0idx0",
          amount: orderData.amount,
          currency: orderData.currency || "INR",
          name: "Fuel Flux",
          description: `${planName} Subscription - ${duration}`,
          order_id: orderData.order_id,
          image: "{{ url_for('static', filename='images/logo2.png') }}",
          handler: async function (response) {
            // Step 3: Handle payment success
            try {
              const successResponse = await fetch("/subscription/payment-success", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "X-CSRFToken": document.querySelector('meta[name="csrf-token"]')?.content || ""
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                  razorpay_payment_id: response.razorpay_payment_id,
                  razorpay_order_id: response.razorpay_order_id,
                  razorpay_signature: response.razorpay_signature,
                  plan_type: planName,
                  duration: duration,
                  pump_id: parseInt(pumpId)
                })
              });

              const result = await successResponse.json();

              if (result.success) {
                showToast(result.message || "‚úÖ Subscription activated successfully!", "success");
                
                // Step 4: Refresh subscription status and unlock features
                try {
                  await unlockFeatures();
                } catch (unlockErr) {
                  console.warn("unlockFeatures error (non-critical):", unlockErr);
                }
                
                // Reload the subscription section to show updated status
                setTimeout(() => {
                  updateMainContent('üí≥ Subscriptions');
                  // Refresh features again after view change
                  setTimeout(() => unlockFeatures(), 500);
                }, 800);
              } else {
                showToast(result.error || "Payment succeeded but subscription activation failed", "error");
              }
            } catch (err) {
              console.error("Payment success handler error:", err);
              // Still try to unlock features even if there was an error
              try {
                await unlockFeatures();
                showToast("Payment completed. Refreshing subscription status...", "success");
                setTimeout(() => {
                  updateMainContent('üí≥ Subscriptions');
                  setTimeout(() => unlockFeatures(), 500);
                }, 800);
              } catch (unlockErr) {
                showToast("Payment successful but page refresh needed. Please reload the page.", "error");
              }
            }
          },
          prefill: {
            name: "{{ user.full_name }}",
            email: "{{ user.email }}",
            contact: ""
          },
          theme: { color: "#FF6B35" },
          modal: {
            ondismiss: function() {
              // Re-enable button if user closes payment modal
              button.disabled = false;
              button.textContent = "Subscribe";
            }
          }
        };

        const rzp = new Razorpay(options);
        rzp.on('payment.failed', function (response) {
          showToast("Payment failed: " + (response.error.description || "Unknown error"), "error");
          button.disabled = false;
          button.textContent = "Subscribe";
        });
        
        rzp.open();

      } catch (err) {
        console.error("Subscription error:", err);
        showToast(err.message || "Failed to initiate payment", "error");
        this.disabled = false;
        this.textContent = "Subscribe";
      }
      */
      // END OF OLD RAZORPAY CODE
    });
  });

  break;

case 'üí≥ Billing System':
  mainContent.innerHTML = `
    <h2 class="text-2xl font-bold text-fuel-orange mb-4">Billing System</h2>

    <!-- Record Fuel Sale -->
    <div class="bg-fuel-black p-4 rounded-lg shadow flex flex-col mb-6">
      <h3 class="text-lg font-semibold text-gray-200 mb-3">‚õΩ Record Fuel Sale</h3>
      <form id="fuelBillingForm" class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-sm text-gray-300 mb-1 block">Vehicle Number</label>
          <input type="text" id="billingVehicleNumber" class="w-full p-2 rounded bg-fuel-gray text-white focus:outline-none uppercase" placeholder="GJ01AB1234" required>
        </div>
        <div>
          <label class="text-sm text-gray-300 mb-1 block">Fuel Type</label>
          <select id="billingFuelType" class="w-full p-2 rounded bg-fuel-gray text-white focus:outline-none" required>
            <option value="">Select</option>
            <option value="Petrol">Petrol</option>
            <option value="Diesel">Diesel</option>
            <option value="CNG">CNG</option>
          </select>
        </div>
        <div>
          <label class="text-sm text-gray-300 mb-1 block">Quantity (Litres)</label>
          <input type="number" step="0.01" id="billingQuantity" class="w-full p-2 rounded bg-fuel-gray text-white focus:outline-none" required>
        </div>
        <div>
          <label class="text-sm text-gray-300 mb-1 block">Unit Price (‚Çπ/Litre)</label>
          <input type="number" step="0.01" id="billingUnitPrice" class="w-full p-2 rounded bg-fuel-gray text-white focus:outline-none" required>
        </div>
        <div class="md:col-span-2 flex items-center justify-between mt-2">
          <div class="text-gray-300 text-sm">Total Amount: <span id="billingTotal" class="font-bold text-fuel-orange">‚Çπ0.00</span></div>
          <button type="submit" class="px-4 py-2 bg-fuel-green hover:bg-green-600 rounded-lg font-semibold">Create Transaction</button>
        </div>
      </form>
      <p id="billingError" class="text-sm text-red-400 mt-2 hidden"></p>
    </div>

    <!-- Pending Verifications -->
    <div class="bg-fuel-black p-4 rounded-lg shadow flex flex-col mb-6">
      <div class="flex justify-between items-center mb-3">
        <h3 class="text-lg font-semibold text-gray-200">‚è≥ Pending Verifications</h3>
        <button id="refreshPendingBtn" class="text-sm text-fuel-orange hover:text-orange-400">Refresh</button>
      </div>
      <div id="pendingVerificationsList" class="space-y-2 max-h-64 overflow-y-auto pr-2">
        <p class="text-gray-400 text-sm">Loading pending verifications...</p>
      </div>
    </div>

    <!-- Ready to Settle -->
    <div class="bg-fuel-black p-4 rounded-lg shadow flex flex-col mb-6">
      <div class="flex justify-between items-center mb-3">
        <h3 class="text-lg font-semibold text-gray-200">üí∏ Ready to Settle</h3>
        <button id="refreshVerifiedBtn" class="text-sm text-fuel-orange hover:text-orange-400">Refresh</button>
      </div>
      <div id="verifiedTransactionsList" class="space-y-2 max-h-64 overflow-y-auto pr-2">
        <p class="text-gray-400 text-sm">Loading verified transactions...</p>
      </div>
    </div>

    <!-- Today's Sales Summary -->
    <div class="bg-fuel-black p-4 rounded-lg shadow flex flex-col mb-6">
      <div class="flex justify-between items-center mb-3">
        <h3 class="text-lg font-semibold text-gray-200">üìà Today's Sales</h3>
        <span id="todayDate" class="text-sm text-gray-400"></span>
      </div>
      <div id="todaySalesSummary" class="grid grid-cols-3 gap-4 text-center">
        <div class="bg-fuel-gray p-3 rounded">
          <div class="text-2xl font-bold text-fuel-orange" id="todayTransactions">0</div>
          <div class="text-xs text-gray-400">Transactions</div>
        </div>
        <div class="bg-fuel-gray p-3 rounded">
          <div class="text-2xl font-bold text-green-400" id="todayAmount">‚Çπ0</div>
          <div class="text-xs text-gray-400">Total Amount</div>
        </div>
        <div class="bg-fuel-gray p-3 rounded">
          <div class="text-2xl font-bold text-blue-400" id="todayQuantity">0L</div>
          <div class="text-xs text-gray-400">Total Litres</div>
        </div>
      </div>
    </div>

    <!-- Recent Fuel Sales -->
    <div class="bg-fuel-black p-4 rounded-lg shadow flex flex-col mb-6">
      <div class="flex justify-between items-center mb-3">
        <h3 class="text-lg font-semibold text-gray-200">üìä Recent Fuel Sales</h3>
        <button id="refreshSalesBtn" class="text-sm text-fuel-orange hover:text-orange-400">Refresh</button>
      </div>
      <div id="fuelSalesList" class="space-y-2 max-h-64 overflow-y-auto pr-2">
        <p class="text-gray-400 text-sm">Loading sales...</p>
      </div>
    </div>
  `;

  (function(){
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    const pumpIdVal = "{{ pump.id }}";
    const form = document.getElementById('fuelBillingForm');
    const qtyInput = document.getElementById('billingQuantity');
    const priceInput = document.getElementById('billingUnitPrice');
    const totalEl = document.getElementById('billingTotal');
    const errorEl = document.getElementById('billingError');
    const salesList = document.getElementById('fuelSalesList');
    const refreshBtn = document.getElementById('refreshSalesBtn');
    const pendingList = document.getElementById('pendingVerificationsList');
    const refreshPendingBtn = document.getElementById('refreshPendingBtn');

    // Set today's date
    document.getElementById('todayDate').textContent = new Date().toLocaleDateString('en-IN', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });

    function updateTotal() {
      const q = parseFloat(qtyInput.value || '0');
      const p = parseFloat(priceInput.value || '0');
      const total = q * p;
      totalEl.textContent = '‚Çπ' + (isNaN(total) ? '0.00' : total.toFixed(2));
    }

    qtyInput.addEventListener('input', updateTotal);
    priceInput.addEventListener('input', updateTotal);

    // Load today's sales summary
    async function loadTodaySales() {
      try {
        const today = new Date().toISOString().split('T')[0];
        const res = await fetch(`/escrow/sales/daily?pump_id=${pumpIdVal}&date=${today}`, { credentials: 'include' });
        const data = await res.json();
        if (data.success && data.summary) {
          const s = data.summary;
          document.getElementById('todayTransactions').textContent = s.total_transactions || 0;
          document.getElementById('todayAmount').textContent = '‚Çπ' + (s.total_amount || 0);
          document.getElementById('todayQuantity').textContent = (s.total_quantity || 0) + 'L';
        }
      } catch (err) {
        console.error('Failed to load today sales:', err);
      }
    }

    // Load pending verifications
    async function loadPendingVerifications() {
      if (!pendingList) return;
      pendingList.innerHTML = '<p class="text-gray-400 text-sm">Loading pending verifications...</p>';
      try {
        const res = await fetch(`/escrow/fuel-transactions/pump?pump_id=${pumpIdVal}&status=pending_verification`, { credentials: 'include' });
        const data = await res.json();
        if (!data.success || !Array.isArray(data.transactions) || data.transactions.length === 0) {
          pendingList.innerHTML = '<p class="text-gray-400 text-sm">No pending verifications.</p>';
          return;
        }
        pendingList.innerHTML = data.transactions.map(t => `
          <div class="bg-fuel-gray p-3 rounded text-sm">
            <div class="flex justify-between items-start mb-2">
              <div>
                <div class="font-semibold text-gray-200">${t.vehicle_number}</div>
                <div class="text-gray-400 text-xs">${t.fuel_type} ‚Ä¢ ${t.quantity_litres} L</div>
              </div>
              <div class="text-right text-fuel-orange font-bold">‚Çπ${t.amount.toFixed(2)}</div>
            </div>
            <div class="flex gap-2">
              <button onclick="verifyTransaction(${t.id})" class="px-2 py-1 bg-green-600 hover:bg-green-700 rounded text-xs">Verify</button>
              <button onclick="viewTransaction(${t.id})" class="px-2 py-1 bg-gray-600 hover:bg-gray-700 rounded text-xs">View</button>
            </div>
          </div>`).join('');
      } catch (err) {
        console.error(err);
        pendingList.innerHTML = '<p class="text-gray-400 text-sm">Failed to load pending verifications.</p>';
      }
    }

    // Load verified transactions (ready to settle)
    async function loadVerifiedTransactions() {
      const verifiedList = document.getElementById('verifiedTransactionsList');
      if (!verifiedList) return;
      verifiedList.innerHTML = '<p class="text-gray-400 text-sm">Loading verified transactions...</p>';
      try {
        const res = await fetch(`/escrow/fuel-transactions/pump?pump_id=${pumpIdVal}&status=verified`, { credentials: 'include' });
        const data = await res.json();
        if (!data.success || !Array.isArray(data.transactions) || data.transactions.length === 0) {
          verifiedList.innerHTML = '<p class="text-gray-400 text-sm">No verified transactions ready to settle.</p>';
          return;
        }
        verifiedList.innerHTML = data.transactions.map(t => `
          <div class="bg-fuel-gray p-3 rounded text-sm">
            <div class="flex justify-between items-start mb-2">
              <div>
                <div class="font-semibold text-gray-200">${t.vehicle_number}</div>
                <div class="text-gray-400 text-xs">${t.fuel_type} ‚Ä¢ ${t.quantity_litres} L</div>
              </div>
              <div class="text-right text-fuel-orange font-bold">‚Çπ${t.amount.toFixed(2)}</div>
            </div>
            <div class="flex gap-2">
              <button onclick="settleTransaction(${t.id})" class="px-2 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs">Settle</button>
              <button onclick="viewTransaction(${t.id})" class="px-2 py-1 bg-gray-600 hover:bg-gray-700 rounded text-xs">View</button>
            </div>
          </div>`).join('');
      } catch (err) {
        console.error(err);
        verifiedList.innerHTML = '<p class="text-gray-400 text-sm">Failed to load verified transactions.</p>';
      }
    }

    // Load recent sales (all transactions)
    async function loadSales() {
      if (!salesList) return;
      salesList.innerHTML = '<p class="text-gray-400 text-sm">Loading sales...</p>';
      try {
        const res = await fetch(`/escrow/fuel-transactions/pump?pump_id=${pumpIdVal}`, { credentials: 'include' });
        const data = await res.json();
        if (!data.success || !Array.isArray(data.transactions) || data.transactions.length === 0) {
          salesList.innerHTML = '<p class="text-gray-400 text-sm">No transactions yet.</p>';
          return;
        }
        salesList.innerHTML = data.transactions.map(t => {
          const statusColor = t.status === 'settled' ? 'text-green-400' : t.status === 'verified' ? 'text-blue-400' : t.status === 'failed' ? 'text-red-400' : 'text-yellow-400';
          const statusText = t.status.charAt(0).toUpperCase() + t.status.slice(1);
          return `
          <div class="flex justify-between items-center bg-fuel-gray p-2 rounded text-sm">
            <div>
              <div class="font-semibold text-gray-200">${t.vehicle_number}</div>
              <div class="text-gray-400 text-xs">${t.fuel_type} ‚Ä¢ ${t.quantity_litres} L</div>
              <div class="text-gray-500 text-xs">${statusText}</div>
            </div>
            <div class="text-right ${statusColor} font-bold">‚Çπ${t.amount.toFixed(2)}</div>
          </div>`}).join('');
      } catch (err) {
        console.error(err);
        salesList.innerHTML = '<p class="text-gray-400 text-sm">Failed to load sales.</p>';
      }
    }

    // Verify a transaction
    window.verifyTransaction = async function(transactionId) {
      try {
        const res = await fetch(`/escrow/fuel-transaction/${transactionId}/verify`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
          },
          credentials: 'include',
          body: JSON.stringify({})
        });
        const data = await res.json();
        if (data.success) {
          showToast('Transaction verified successfully.', 'success');
          loadPendingVerifications();
          loadVerifiedTransactions();
          loadSales();
        } else {
          showToast(data.message || 'Verification failed', 'error');
        }
      } catch (err) {
        console.error(err);
        showToast('Server error during verification', 'error');
      }
    };

    // View transaction details
    window.viewTransaction = async function(transactionId) {
      try {
        const res = await fetch(`/escrow/fuel-transaction/${transactionId}/receipt`, { credentials: 'include' });
        const data = await res.json();
        if (data.success && data.receipt) {
          const r = data.receipt;
          alert(`Transaction Details:\n\nID: ${r.transaction_id}\nVehicle: ${r.vehicle_number}\nFuel: ${r.fuel_type}\nQuantity: ${r.quantity_litres} L\nAmount: ‚Çπ${r.amount}\nStatus: ${r.status}\nCreated: ${new Date(r.created_at).toLocaleString('en-IN')}`);
        }
      } catch (err) {
        console.error(err);
        showToast('Failed to load transaction details', 'error');
      }
    };

    // Settle a verified transaction (atomic escrow release)
    window.settleTransaction = async function(transactionId) {
      try {
        const res = await fetch(`/escrow/fuel-transaction/${transactionId}/settle`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
          },
          credentials: 'include'
        });
        const data = await res.json();
        if (data.success) {
          showToast('Transaction settled. Funds transferred.', 'success');
          loadPendingVerifications();
          loadVerifiedTransactions();
          loadSales();
          loadTodaySales();
        } else {
          // Show detailed failure reason
          const reason = data.failure_reason || data.message || 'Settlement failed';
          showToast(`Settlement failed: ${reason}`, 'error');
          // Still refresh lists to show updated status
          loadPendingVerifications();
          loadVerifiedTransactions();
          loadSales();
          loadTodaySales();
        }
      } catch (err) {
        console.error(err);
        showToast('Server error during settlement', 'error');
      }
    };

    // Form submission: create fuel transaction (Step 3)
    form.addEventListener('submit', async function(e){
      e.preventDefault();
      errorEl.classList.add('hidden');
      const vehicleNumber = document.getElementById('billingVehicleNumber').value.trim();
      const fuelType = document.getElementById('billingFuelType').value;
      const qty = parseFloat(qtyInput.value || '0');
      const price = parseFloat(priceInput.value || '0');

      if (!vehicleNumber || !fuelType || !qty || !price) {
        errorEl.textContent = 'Please fill all fields with valid values.';
        errorEl.classList.remove('hidden');
        return;
      }

      try {
        const res = await fetch('/escrow/fuel-transaction', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
          },
          credentials: 'include',
          body: JSON.stringify({
            pump_id: parseInt(pumpIdVal),
            vehicle_number: vehicleNumber,
            fuel_type: fuelType,
            quantity_litres: qty,
            unit_price: price
          })
        });
        const data = await res.json();
        if (!data.success) {
          errorEl.textContent = data.message || 'Failed to create transaction.';
          errorEl.classList.remove('hidden');
          return;
        }
        showToast('Fuel transaction created. Pending verification.', 'success');
        form.reset();
        updateTotal();
        loadPendingVerifications();
      } catch (err) {
        console.error(err);
        errorEl.textContent = 'Server error. Please try again.';
        errorEl.classList.remove('hidden');
      }
    });

    // Wire refresh buttons
    if (refreshBtn) refreshBtn.addEventListener('click', loadSales);
    if (refreshPendingBtn) refreshPendingBtn.addEventListener('click', loadPendingVerifications);
    const refreshVerifiedBtn = document.getElementById('refreshVerifiedBtn');
    if (refreshVerifiedBtn) refreshVerifiedBtn.addEventListener('click', loadVerifiedTransactions);

    // Initial loads
    loadPendingVerifications();
    loadVerifiedTransactions();
    loadSales();
    loadTodaySales();
  })();

  break;





        case 'üßæ Receipts':
          mainContent.innerHTML = getReceiptTemplate();
          initReceiptSection();
          break;

        case 'üí∞ Settlements':
          mainContent.innerHTML = `
            <h2 class="text-2xl font-bold text-fuel-orange mb-4">Settlements</h2>

            <!-- Settlement Summary -->
            <div class="bg-fuel-black p-4 rounded-lg shadow flex flex-col mb-6">
              <h3 class="text-lg font-semibold text-gray-200 mb-3">üìä Settlement Summary</h3>
              <div id="settlementSummary" class="grid grid-cols-3 gap-4 text-center">
                <div class="bg-fuel-gray p-3 rounded">
                  <div class="text-2xl font-bold text-fuel-orange" id="availableBalance">‚Çπ0</div>
                  <div class="text-xs text-gray-400">Available Balance</div>
                </div>
                <div class="bg-fuel-gray p-3 rounded">
                  <div class="text-2xl font-bold text-yellow-400" id="pendingSettlements">‚Çπ0</div>
                  <div class="text-xs text-gray-400">Pending Settlements</div>
                </div>
                <div class="bg-fuel-gray p-3 rounded">
                  <div class="text-2xl font-bold text-green-400" id="todaySales">‚Çπ0</div>
                  <div class="text-xs text-gray-400">Today's Sales</div>
                </div>
              </div>
            </div>

            <!-- Request Settlement -->
            <div class="bg-fuel-black p-4 rounded-lg shadow flex flex-col mb-6">
              <h3 class="text-lg font-semibold text-gray-200 mb-3">üí∏ Request Settlement</h3>
              <form id="settlementForm" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                  <label class="text-sm text-gray-300 mb-1 block">Amount (‚Çπ)</label>
                  <input type="number" step="0.01" id="settlementAmount" class="w-full p-2 rounded bg-fuel-gray text-white focus:outline-none" required>
                </div>
                <div>
                  <label class="text-sm text-gray-300 mb-1 block">Bank Reference (Optional)</label>
                  <input type="text" id="bankReference" class="w-full p-2 rounded bg-fuel-gray text-white focus:outline-none" placeholder="Bank A/C Number, UPI, etc.">
                </div>
                <div class="md:col-span-2">
                  <button type="submit" class="px-4 py-2 bg-fuel-green hover:bg-green-600 rounded-lg font-semibold">Request Settlement</button>
                </div>
              </form>
              <p id="settlementError" class="text-sm text-red-400 mt-2 hidden"></p>
            </div>

            <!-- Settlement History -->
            <div class="bg-fuel-black p-4 rounded-lg shadow flex flex-col mb-6">
              <div class="flex justify-between items-center mb-3">
                <h3 class="text-lg font-semibold text-gray-200">üìú Settlement History</h3>
                <button id="refreshSettlementBtn" class="text-sm text-fuel-orange hover:text-orange-400">Refresh</button>
              </div>
              <div id="settlementHistoryList" class="space-y-2 max-h-64 overflow-y-auto pr-2">
                <p class="text-gray-400 text-sm">Loading settlement history...</p>
              </div>
            </div>
          `;
          initSettlementSection();
          break;

        case 'üìà Daily Comparison':
          mainContent.innerHTML = getComparisonTemplate();
          initDailyComparison();
          break;

        case 'üß™ Density Calculator':
          mainContent.innerHTML = getDensityTemplate();
          initDensityCalculator();
          break;

        case 'üë§ Profile':
          content = `
            <h2 class="text-2xl font-bold text-fuel-orange mb-4">Profile</h2>
            <div class="space-y-6">

              <!-- User Info -->
              <div class="bg-fuel-black p-4 rounded-lg shadow mb-6">
                <h3 class="text-lg font-semibold text-gray-200 mb-2">Your Information</h3>
                <p><span class="font-semibold">Full Name:</span> {{ user.full_name }}</p>
                <p><span class="font-semibold">Email:</span> {{ user.email }}</p>
              </div>

              <!-- Update Profile Form -->
              <div class="bg-fuel-black p-4 rounded-lg shadow mb-6">
                <h3 class="text-lg font-semibold text-gray-200 mb-3">Update Profile</h3>
                <form method="POST" action="{{ url_for('pump_dashboard.update_profile') }}" class="space-y-3">
                    
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                  <input type="text" name="full_name" value="{{ user.full_name }}" 
                         class="w-full p-2 rounded bg-fuel-gray text-white focus:outline-none" required>
                  <button type="submit" 
                          class="px-4 py-2 bg-fuel-orange hover:bg-orange-600 rounded-lg font-semibold">
                    Save Changes
                  </button>
                </form>
              </div>

              <!-- Change Password -->
              {% if user.password_hash %}
              <div class="bg-fuel-black p-4 rounded-lg shadow">
                <h3 class="text-lg font-semibold text-gray-200 mb-3">Change Password</h3>
                <form method="POST" action="{{ url_for('pump_dashboard.change_password') }}" class="space-y-3">
                  
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                  <input type="password" name="old_password" placeholder="Current Password" 
                         class="w-full p-2 rounded bg-fuel-gray text-white focus:outline-none" required>
                  <input type="password" name="new_password" placeholder="New Password" 
                         class="w-full p-2 rounded bg-fuel-gray text-white focus:outline-none" required>
                  <input type="password" name="confirm_password" placeholder="Confirm New Password" 
                         class="w-full p-2 rounded bg-fuel-gray text-white focus:outline-none" required>
                  <button type="submit" 
                          class="px-4 py-2 bg-fuel-orange hover:bg-orange-600 rounded-lg font-semibold">
                    Update Password
                  </button>
                </form>
              </div>
              {% else %}
                <p class="bg-yellow-500 bg-opacity-20 text-yellow-400 px-3 py-2 rounded text-sm">
                  Password change not available for OAuth users.</p>
              {% endif %}

            `;
          mainContent.innerHTML = content;
          break;
          
case 'üìä Station vehicle data':
  content = `
    <style>
      .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .btn {
        background-color: #FF6B35;
        color: white;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        transition: 0.3s;
      }
      .btn:hover { background-color: #E65A24; }
      .input-field {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
        margin-bottom: 10px;
        color: black;
      }
      .stat-card {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        padding: 20px;
        text-align: center;
        transition: all 0.25s ease-in-out;
      }
      .stat-card:hover {
        background: #fff7f3;
        border-color: #FF6B35;
        box-shadow: 0 2px 10px rgba(255,107,53,0.15);
        transform: translateY(-3px);
      }
      .stat-title { font-size: 1rem; color: #555; font-weight: 600; }
      .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #333;
        margin-top: 6px;
        transition: color 0.25s ease-in-out;
      }
      .stat-card:hover .stat-value { color: #FF6B35; }
      .stat-status {
        font-weight: 600;
        font-size: 1rem;
        margin-top: 8px;
        color: #666;
        transition: color 0.25s ease-in-out;
      }
      .stat-card:hover .stat-status { color: #E65A24; }
    </style>

    <div class="animate-fade-in bg-white p-6 rounded-2xl shadow-md w-full md:w-2/3 mx-auto mt-6">
      <h2 class="text-2xl font-semibold mb-4 text-gray-800">üì° Station Vehicle Data</h2>
      <p class="text-gray-600 mb-6">Add or update the RTSP stream URL for your CCTV camera feed.</p>

      <div id="rtspForm">
        <label class="block mb-2 text-gray-700 font-medium">RTSP Stream URL:</label>
        <input id="rtspUrl" type="text" class="input-field" placeholder="rtsp://username:password@ip_address:port/stream" />
        <button class="btn w-full" id="saveRtspBtn">üíæ Save RTSP URL</button>
      </div>

      <div id="currentRtspSection" class="hidden mt-6">
        <h3 class="text-lg font-semibold text-gray-700 mb-2">Current RTSP URL:</h3>
        <p id="currentRtspValue" class="bg-gray-100 p-3 rounded-lg font-bold text-gray-800 break-all border" style="border-color:#FF6B35;"></p>
        <button class="btn mt-4 w-full" id="editRtspBtn">‚úèÔ∏è Modify RTSP URL</button>
      </div>
    </div>

    <div id="vehicleCountSection" class="mt-10 bg-white p-6 rounded-2xl shadow-lg">
      <h3 class="text-2xl font-semibold text-gray-800 mb-6">üìà Live Vehicle Statistics</h3>

      <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-8">
        <div class="stat-card">
          <div class="stat-title">üöó Current Vehicles</div>
          <div id="liveVehicleCount" class="stat-value">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">üì∂ Station Status</div>
          <div id="liveStatus" class="stat-status">Loading...</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">‚è± Last Updated</div>
          <div id="lastUpdated" class="stat-status">--:--:--</div>
        </div>
      </div>

      <div class="bg-gradient-to-br from-orange-50 to-white p-4 rounded-xl shadow-inner mb-6">
        <h4 class="text-lg font-semibold text-gray-700 mb-2">üö¶ Vehicle Count Trend</h4>
        <canvas id="vehicleLineChart" height="180"></canvas>
      </div>

      <!-- Detected Vehicles List -->
      <div class="bg-white p-4 rounded-xl border border-gray-200">
        <h4 class="text-lg font-semibold text-gray-700 mb-4">üöó Recently Detected Vehicles</h4>
        <div id="detectedVehiclesList" class="space-y-2 max-h-64 overflow-y-auto">
          <p class="text-gray-500 text-center py-4">Loading detected vehicles...</p>
        </div>
      </div>
    </div>
  `;

  mainContent.innerHTML = content;

  (() => {
    const lineCtx = document.getElementById('vehicleLineChart').getContext('2d');
    const vehicleCountEl = document.getElementById('liveVehicleCount');
    const statusEl = document.getElementById('liveStatus');
    const lastUpdatedEl = document.getElementById('lastUpdated');

    const lineData = {
      labels: [],
      datasets: [{
        label: 'Vehicle Count',
        data: [],
        fill: true,
        backgroundColor: 'rgba(255,107,53,0.2)',
        borderColor: 'rgba(255,107,53,1)',
        borderWidth: 2,
        tension: 0.4,
        pointRadius: 3
      }]
    };

    const lineChart = new Chart(lineCtx, {
      type: 'line',
      data: lineData,
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { display: false },
          y: { title: { display: true, text: 'Vehicle Count' }, beginAtZero: true }
        }
      }
    });

    function getStatusFromCount(count) {
      if (count > 15) return { text: 'üö® Busy', color: 'red' };
      if (count > 7) return { text: '‚ö° Moderate', color: 'orange' };
      return { text: 'üü¢ Idle', color: 'green' };
    }

    async function fetchVehicleCount() {
      try {
        const res = await fetch(`/vehicle-count?pump_id={{ pump.id }}`, { credentials: 'same-origin' });
        if (!res.ok) {
          console.error('Vehicle count fetch failed:', res.status);
          vehicleCountEl.textContent = '0';
          statusEl.textContent = '‚ùå Error';
          statusEl.style.color = 'red';
          return;
        }
        const json = await res.json();
        const count = json.vehicle_count || 0;

        lineData.labels.push('');
        lineData.datasets[0].data.push(count);
        if (lineData.labels.length > 15) {
          lineData.labels.shift();
          lineData.datasets[0].data.shift();
        }
        lineChart.update();

        vehicleCountEl.textContent = count;
        const status = getStatusFromCount(count);
        statusEl.textContent = status.text;
        statusEl.style.color = status.color;
        lastUpdatedEl.textContent = new Date().toLocaleTimeString();
      } catch (err) {
        console.error('Error fetching vehicle count:', err);
      }
    }

    // Fetch detected vehicles
    async function fetchDetectedVehicles() {
      try {
        const res = await fetch("/vehicle_verification/vehicle-details", { credentials: 'same-origin' });
        if (!res.ok) return;
        const data = await res.json();
        if (data.success && Array.isArray(data.plates)) {
          const container = document.getElementById('detectedVehiclesList');
          if (data.plates.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-4">No vehicles detected yet.</p>';
            return;
          }
          container.innerHTML = data.plates.map(p => `
            <div class="flex justify-between items-center p-2 bg-gray-50 rounded border border-gray-200">
              <span class="font-semibold text-gray-800">${p.plate}</span>
              <span class="text-sm text-gray-500">${new Date(p.detected_at).toLocaleString()}</span>
            </div>
          `).join('');
        }
      } catch (err) {
        console.error('Error fetching detected vehicles:', err);
      }
    }

    // Start immediately and then every 5 seconds
    fetchVehicleCount();
    fetchDetectedVehicles();
    setInterval(fetchVehicleCount, 5000);
    setInterval(fetchDetectedVehicles, 3000);
  })();

  (() => {
    const rtspInput = document.getElementById('rtspUrl');
    const saveBtn = document.getElementById('saveRtspBtn');
    const formDiv = document.getElementById('rtspForm');
    const currentDiv = document.getElementById('currentRtspSection');
    const currentValue = document.getElementById('currentRtspValue');
    const editBtn = document.getElementById('editRtspBtn');

    const pumpId = "{{ pump.id if pump else '' }}";
    const stationName = "{{ pump.name if pump else '' }}";
    const location = "{{ pump.location if pump else '' }}";
    const getRtspUrl = "{{ url_for('pump_dashboard.get_rtsp_streams') }}";
    const saveRtspUrl = "{{ url_for('pump_dashboard.save_rtsp') }}";
    const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

    let stationId = null;

    async function fetchCurrentRtsp() {
      try {
        const res = await fetch(getRtspUrl, { credentials: 'same-origin' });
        if (!res.ok) return;
        const data = await res.json();
        if (!data.success || !Array.isArray(data.stations)) return;

        const matched = data.stations.find(s =>
          (s.station_name || '').trim() === (stationName || '').trim() &&
          (s.location || '').trim() === (location || '').trim()
        );

        if (matched) {
          stationId = matched.station_id;
          if (matched.rtsp_url) {
            currentValue.textContent = matched.rtsp_url;
            formDiv.classList.add('hidden');
            currentDiv.classList.remove('hidden');
            // Auto-start vehicle counting when RTSP is configured
            setTimeout(() => fetchVehicleCount(), 1000);
          }
        }
      } catch (err) {
        console.error('Error fetching RTSP streams:', err);
      }
    }

    async function saveRtsp() {
      const rtsp = rtspInput.value.trim();
      if (!rtsp.startsWith('rtsp://')) {
        alert('Please enter a valid RTSP URL.');
        return;
      }

      const payload = { station_name: stationName, location: location, rtsp_url: rtsp };
      if (stationId) payload.station_id = stationId;

      try {
        const res = await fetch(saveRtspUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
          body: JSON.stringify(payload),
          credentials: 'same-origin'
        });

        const data = await res.json();
        if (data.success) {
          if (data.station_id) stationId = data.station_id;
          currentValue.textContent = data.rtsp_url || rtsp;
          formDiv.classList.add('hidden');
          currentDiv.classList.remove('hidden');
          showToast(data.message || 'RTSP saved', 'success');
        } else {
          showToast(data.message || 'Failed to save RTSP', 'error');
        }
      } catch (err) {
        console.error('Error saving RTSP:', err);
        showToast('Something went wrong', 'error');
      }
    }

    saveBtn.addEventListener('click', e => {
      e.preventDefault();
      saveRtsp();
    });

    editBtn.addEventListener('click', () => {
      rtspInput.value = currentValue.textContent;
      formDiv.classList.remove('hidden');
      currentDiv.classList.add('hidden');
    });

    fetchCurrentRtsp();
  })();
  break;


case 'üïµÔ∏è Vehicle verification':
  content = `
    <style>
      .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .btn {
        background-color: #FF6B35;
        color: white;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        transition: 0.3s;
      }
      .btn:hover { background-color: #E65A24; }
      .input-field {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
        margin-bottom: 10px;
        color: black;
      }
    </style>

    <div class="animate-fade-in bg-white p-6 rounded-2xl shadow-md w-full md:w-2/3 mx-auto mt-6">
      <h2 class="text-2xl font-semibold mb-4 text-gray-800">üïµÔ∏è Vehicle Verification</h2>
      <p class="text-gray-600 mb-6">
        Add or update your vehicle verification video feed (RTSP URL for vehicle camera).
      </p>

      <div id="verificationForm">
        <label class="block mb-2 text-gray-700 font-medium">Vehicle Verification RTSP URL:</label>
        <input id="verificationRtspUrl" type="text" class="input-field" placeholder="rtsp://username:password@ip_address:port/vehicle_stream" />
        <button class="btn w-full" id="saveVerificationBtn">üíæ Save Verification RTSP</button>
      </div>

      <div id="currentVerificationSection" class="hidden mt-6">
        <h3 class="text-lg font-semibold text-gray-700 mb-2">Current Verification RTSP:</h3>
        <p id="currentVerificationValue" class="bg-gray-100 p-3 rounded-lg font-bold text-gray-800 break-all border" style="border-color:#FF6B35;"></p>
        <button class="btn mt-4 w-full" id="editVerificationBtn">‚úèÔ∏è Modify Verification RTSP</button>
      </div>

    </div>

<!-- --- Vehicle Detection Log --- -->
<div id="vehicleLogSection" class="mt-6 bg-gray-50 p-4 rounded-lg border border-gray-300 flex-1 overflow-y-auto">
  <h3 class="text-lg font-semibold text-gray-700 mb-2">Detected Number Plates:</h3>
  <ul id="vehicleLogList" class="text-gray-800 text-sm"></ul>
</div>


  `;

  mainContent.innerHTML = content;

  (() => {
  const rtspInput = document.getElementById('verificationRtspUrl');
  const saveBtn = document.getElementById('saveVerificationBtn');
  const formDiv = document.getElementById('verificationForm');
  const currentDiv = document.getElementById('currentVerificationSection');
  const currentValue = document.getElementById('currentVerificationValue');
  const editBtn = document.getElementById('editVerificationBtn');

  const getVerificationUrl = "{{ url_for('pump_dashboard.get_vehicle_verifications') }}";
  const saveVerificationUrl = "{{ url_for('pump_dashboard.save_vehicle_verification') }}";
  const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

  let verificationId = null;

  // Fetch current RTSP URL from server
  async function fetchCurrentVerification() {
    try {
      const res = await fetch(getVerificationUrl, { credentials: 'same-origin' });
      if (!res.ok) return console.error('Failed to fetch vehicle verifications:', res.status);

      const data = await res.json();
      if (!data.success || !Array.isArray(data.verifications)) return;

      const latest = data.verifications[0]; // pick the first station
      if (latest) {
        verificationId = latest.id; // store database id
        if (latest.rtsp_url) {
          currentValue.textContent = latest.rtsp_url;
          formDiv.classList.add('hidden');
          currentDiv.classList.remove('hidden');
        }
      }
    } catch (err) {
      console.error("Error fetching verification RTSP:", err);
    }
  }

  // Save or update RTSP URL
  async function saveVerification() {
    const rtsp = rtspInput.value.trim();
    if (!rtsp.startsWith('rtsp://')) return alert('Please enter a valid RTSP URL.');

    const payload = { rtsp_url: rtsp };
    if (verificationId) payload.id = verificationId; // include id for update

    try {
      const res = await fetch(saveVerificationUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(payload),
        credentials: 'same-origin'
      });

      const text = await res.text();
      try {
        const data = JSON.parse(text);
        if (!res.ok) {
          console.error('Server error response:', data);
          return showToast(data.message || 'Server error saving verification RTSP', 'error');
        }

        if (data.success) {
          verificationId = data.id || verificationId;
          currentValue.textContent = data.rtsp_url || rtsp;
          formDiv.classList.add('hidden');
          currentDiv.classList.remove('hidden');
          showToast(data.message || 'Verification RTSP saved', 'success');
        } else {
          showToast(data.message || 'Failed to save verification RTSP', 'error');
        }
      } catch (jsonErr) {
        console.error('Non-JSON server response:', text);
        showToast('Failed to save verification RTSP (server error)', 'error');
      }
    } catch (err) {
      console.error('Error saving verification RTSP:', err);
      showToast('Something went wrong', 'error');
    }
  }

  saveBtn.addEventListener('click', (e) => {
    e.preventDefault();
    saveVerification();
  });

  editBtn.addEventListener('click', () => {
    rtspInput.value = currentValue.textContent;
    formDiv.classList.remove('hidden');
    currentDiv.classList.add('hidden');
  });

  // Initial fetch
  fetchCurrentVerification();

  // ------------------------------
  // Vehicle detection log handling
  // ------------------------------
  const vehicleLogList = document.getElementById('vehicleLogList');

  function logDetectedPlate(plate) {
    if (!vehicleLogList) return;

    const li = document.createElement('li');
    li.textContent = `${new Date().toLocaleTimeString()} - ${plate}`;
    vehicleLogList.prepend(li);

    // Limit log entries to 50
    if (vehicleLogList.children.length > 50) {
      vehicleLogList.removeChild(vehicleLogList.lastChild);
    }
  }

  // Polling endpoint for latest detected plates every 3 seconds
  let lastPlateCount = 0;
  setInterval(async () => {
    try {
      const res = await fetch("/vehicle_verification/vehicle-details", { credentials: "same-origin" });
      if (!res.ok) return;
      const data = await res.json();
      if (data.success && Array.isArray(data.plates)) {
        // Only log new plates
        if (data.plates.length > lastPlateCount) {
          const newPlates = data.plates.slice(0, data.plates.length - lastPlateCount);
          newPlates.forEach(plate => logDetectedPlate(plate.plate || plate));
          lastPlateCount = data.plates.length;
        }
      }
    } catch (err) {
      console.error("Error fetching vehicle details:", err);
    }
  }, 3000);
  
  // Initial fetch
  fetch("/vehicle_verification/vehicle-details", { credentials: "same-origin" })
    .then(res => res.json())
    .then(data => {
      if (data.success && Array.isArray(data.plates)) {
        lastPlateCount = data.plates.length;
        data.plates.slice(0, 10).reverse().forEach(plate => logDetectedPlate(plate.plate || plate));
      }
    })
    .catch(err => console.error("Error fetching initial vehicle details:", err));

})();

  break;



        default:
      }
    }

     menuLinks.forEach(link => {
  link.addEventListener('click', (e) => {
    const selected = e.target.textContent.trim();


          // If it's one of the dynamic sections, load it in main
          if (["üí≥ Subscriptions", "üí≥ Billing System", "üí∞ Settlements", "üë§ Profile", "üìä Station vehicle data","üïµÔ∏è Vehicle verification","üßæ Receipts","üìà Daily Comparison","üß™ Density Calculator"].includes(selected)) {
            e.preventDefault();
            updateMainContent(selected);
            localStorage.setItem('selectedSection', selected);

            // Close mobile sidebar if needed
            if (!link.closest('.lg\\:flex')) {
              mobileSidebar.classList.remove('opacity-100', 'visible');
              mobileSidebar.classList.add('opacity-0', 'invisible');
            }
          } 
          // Otherwise, allow normal navigation (like My Pumps)
          else {
            localStorage.removeItem('selectedSection');
            window.location.href = link.href;
          }
        });
      });




    // Default content
    const lastSection = localStorage.getItem('selectedSection') || 'üë§ Profile';
    updateMainContent(lastSection);
    unlockFeatures();
  </script>

<!-- QR Code Payment Modal -->
<div id="qrPaymentModal" class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden flex items-center justify-center p-3 overflow-y-auto">
  <div class="bg-fuel-gray rounded-2xl max-w-3xl w-full my-4">
    <div class="p-4 md:p-6 max-h-[95vh] overflow-y-auto">
      <!-- Header -->
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg md:text-2xl font-bold text-fuel-orange">Complete Payment</h2>
        <button onclick="closeQRModal()" class="text-white text-3xl hover:text-fuel-orange leading-none">&times;</button>
      </div>

      <!-- Plan Details -->
      <div class="bg-fuel-black p-3 md:p-4 rounded-xl mb-4">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
          <div>
            <div class="text-gray-400 text-xs md:text-sm">Selected Plan</div>
            <div id="modalPlanName" class="text-base md:text-xl font-bold text-fuel-orange">Gold Plan</div>
            <div id="modalDuration" class="text-gray-300 text-xs md:text-sm">1 Month</div>
          </div>
          <div class="text-left sm:text-right">
            <div class="text-gray-400 text-xs md:text-sm">Amount to Pay</div>
            <div id="modalAmount" class="text-2xl md:text-3xl font-bold text-green-500">‚Çπ10,000</div>
          </div>
        </div>
      </div>

      <!-- Payment Method Tabs -->
      <div class="flex gap-2 mb-4">
        <button onclick="showPaymentTab('qr')" id="qrTab" class="flex-1 py-2 px-3 text-sm md:text-base rounded-lg font-semibold bg-fuel-orange text-white">
          Scan QR Code
        </button>
        <button onclick="showPaymentTab('upi')" id="upiTab" class="flex-1 py-2 px-3 text-sm md:text-base rounded-lg font-semibold bg-fuel-black text-white hover:bg-gray-700">
          Pay via UPI ID
        </button>
      </div>

      <!-- QR Code Tab -->
      <div id="qrTabContent" class="space-y-3 md:space-y-4 mb-4">
        <div class="flex items-start gap-2 md:gap-3">
          <div class="flex-shrink-0 w-7 h-7 md:w-8 md:h-8 bg-fuel-orange rounded-full flex items-center justify-center font-bold text-sm md:text-base">1</div>
          <div class="flex-1">
            <h3 class="font-bold text-white mb-2 text-sm md:text-base">Scan QR Code</h3>
            <div class="bg-white p-4 md:p-5 rounded-lg text-center flex flex-col items-center">
              <div class="w-[200px] md:w-[250px] h-[200px] md:h-[250px] flex items-center justify-center mb-3">
                <img src="{{ url_for('static', filename='images/payment_qr.png') }}" 
                     alt="Payment QR Code" 
                     class="w-full h-full object-contain"
                     style="max-width: 100%; max-height: 100%;">
              </div>
              <div class="text-black font-bold text-sm md:text-base">UPI ID:</div>
              <div class="flex flex-col sm:flex-row items-center justify-center gap-2 mt-2">
                <span id="upiId" class="text-black font-mono text-xs md:text-sm break-all">Loading...</span>
                <button onclick="copyUPI()" class="bg-fuel-orange text-white px-3 py-1 rounded text-xs hover:bg-orange-600 whitespace-nowrap">
                  Copy
                </button>
              </div>
              <div class="text-gray-600 text-xs mt-2">Fuel Flux</div>
            </div>
          </div>
        </div>

        <div class="flex items-start gap-2 md:gap-3">
          <div class="flex-shrink-0 w-7 h-7 md:w-8 md:h-8 bg-fuel-orange rounded-full flex items-center justify-center font-bold text-sm md:text-base">2</div>
          <div class="flex-1">
            <h3 class="font-bold text-white mb-2 text-sm md:text-base">Upload Payment Screenshot</h3>
            <input type="file" 
                   id="paymentScreenshot" 
                   accept="image/*,.pdf" 
                   class="w-full text-xs md:text-sm text-white file:mr-2 file:py-2 file:px-3 md:file:px-4 file:rounded file:border-0 file:text-white file:bg-fuel-orange hover:file:bg-orange-600 file:cursor-pointer file:text-xs md:file:text-sm">
            <div id="screenshotPreview" class="mt-3 hidden">
              <img id="previewImage" src="" class="max-h-32 md:max-h-40 rounded-lg mx-auto">
            </div>
          </div>
        </div>

        <div class="flex items-start gap-2 md:gap-3">
          <div class="flex-shrink-0 w-7 h-7 md:w-8 md:h-8 bg-fuel-orange rounded-full flex items-center justify-center font-bold text-sm md:text-base">3</div>
          <div class="flex-1">
            <h3 class="font-bold text-white mb-2 text-sm md:text-base">Transaction ID (Optional)</h3>
            <input type="text" 
                   id="transactionId" 
                   placeholder="Enter UTR/Transaction ID (optional)"
                   class="w-full p-2 md:p-3 rounded-lg bg-fuel-black text-white border border-gray-600 focus:border-fuel-orange focus:outline-none text-xs md:text-sm">
          </div>
        </div>

        <button id="submitPaymentProof" 
                onclick="submitQRPayment()" 
                class="w-full bg-fuel-orange hover:bg-orange-600 text-white py-2.5 md:py-3 rounded-xl font-bold text-sm md:text-lg transition disabled:opacity-50">
          Submit for Verification
        </button>
      </div>

      <!-- UPI ID Tab -->
      <div id="upiTabContent" class="hidden space-y-3 md:space-y-4 mb-4">
        <div class="bg-fuel-black p-4 rounded-xl">
          <h3 class="font-bold text-white mb-3 text-sm md:text-base">Enter Your UPI ID to Pay</h3>
          <div class="space-y-3">
            <div>
              <label class="text-gray-300 text-xs md:text-sm mb-1 block">Your UPI ID</label>
              <input type="text" 
                     id="userUpiId" 
                     placeholder="yourname@upi"
                     class="w-full p-2 md:p-3 rounded-lg bg-fuel-gray text-white border border-gray-600 focus:border-fuel-orange focus:outline-none text-sm">
              <p class="text-gray-400 text-xs mt-1">Example: 9876543210@paytm, username@oksbi</p>
            </div>
            
            <button onclick="payWithUserUPI()" 
                    class="w-full bg-green-600 hover:bg-green-700 text-white py-2.5 md:py-3 rounded-xl font-bold text-sm md:text-base transition">
              üí≥ Pay ‚Çπ<span id="upiAmount">10000</span> Now
            </button>

            <div class="border-t border-gray-600 pt-3">
              <h4 class="font-semibold text-white mb-2 text-xs md:text-sm">After Payment:</h4>
              <div class="space-y-2">
                <div>
                  <label class="text-gray-300 text-xs mb-1 block">Upload Payment Screenshot</label>
                  <input type="file" 
                         id="upiPaymentScreenshot" 
                         accept="image/*,.pdf" 
                         class="w-full text-xs text-white file:mr-2 file:py-2 file:px-3 file:rounded file:border-0 file:text-white file:bg-fuel-orange hover:file:bg-orange-600 file:cursor-pointer file:text-xs">
                </div>
                <div>
                  <label class="text-gray-300 text-xs mb-1 block">Transaction ID (Optional)</label>
                  <input type="text" 
                         id="upiTransactionId" 
                         placeholder="Enter UTR/Transaction ID"
                         class="w-full p-2 rounded-lg bg-fuel-gray text-white border border-gray-600 focus:border-fuel-orange focus:outline-none text-xs">
                </div>
                <button onclick="submitUPIPayment()" 
                        class="w-full bg-fuel-orange hover:bg-orange-600 text-white py-2.5 rounded-xl font-bold text-sm transition disabled:opacity-50">
                  Submit for Verification
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <p class="text-center text-gray-400 text-xs mt-3">
        ‚è±Ô∏è Your payment will be verified by admin within 24 hours
      </p>
    </div>
  </div>
</div>

<script>
  // QR Payment Modal Functions
  let currentPaymentData = {};

  async function showQRPaymentModal(planName, duration, totalPrice, pumpId) {
    currentPaymentData = { planName, duration, totalPrice, pumpId };
    
    document.getElementById('modalPlanName').textContent = planName + ' Plan';
    document.getElementById('modalDuration').textContent = duration;
    document.getElementById('modalAmount').textContent = '‚Çπ' + totalPrice.toLocaleString();
    document.getElementById('qrPaymentModal').classList.remove('hidden');
    document.getElementById('qrPaymentModal').classList.add('flex');
    
    // Load payment details (UPI ID, QR code) from backend
    try {
      const response = await fetch('/subscription/payment-details', {
        credentials: 'same-origin'
      });
      if (response.ok) {
        const data = await response.json();
        if (data.upi_id) {
          document.getElementById('upiId').textContent = data.upi_id;
        }
      }
    } catch (err) {
      console.error('Error loading payment details:', err);
    }
  }

  function closeQRModal() {
    document.getElementById('qrPaymentModal').classList.add('hidden');
    document.getElementById('qrPaymentModal').classList.remove('flex');
    document.getElementById('paymentScreenshot').value = '';
    document.getElementById('transactionId').value = '';
    document.getElementById('screenshotPreview').classList.add('hidden');
    document.getElementById('userUpiId').value = '';
    document.getElementById('upiPaymentScreenshot').value = '';
    document.getElementById('upiTransactionId').value = '';
    showPaymentTab('qr'); // Reset to QR tab
  }

  function copyUPI() {
    const upiId = document.getElementById('upiId').textContent;
    navigator.clipboard.writeText(upiId).then(() => {
      showToast('UPI ID copied to clipboard!', 'success');
    });
  }

  // Tab switching
  function showPaymentTab(tab) {
    const qrTab = document.getElementById('qrTab');
    const upiTab = document.getElementById('upiTab');
    const qrContent = document.getElementById('qrTabContent');
    const upiContent = document.getElementById('upiTabContent');
    
    if (tab === 'qr') {
      qrTab.classList.add('bg-fuel-orange');
      qrTab.classList.remove('bg-fuel-black', 'hover:bg-gray-700');
      upiTab.classList.remove('bg-fuel-orange');
      upiTab.classList.add('bg-fuel-black', 'hover:bg-gray-700');
      qrContent.classList.remove('hidden');
      upiContent.classList.add('hidden');
    } else {
      upiTab.classList.add('bg-fuel-orange');
      upiTab.classList.remove('bg-fuel-black', 'hover:bg-gray-700');
      qrTab.classList.remove('bg-fuel-orange');
      qrTab.classList.add('bg-fuel-black', 'hover:bg-gray-700');
      upiContent.classList.remove('hidden');
      qrContent.classList.add('hidden');
      // Update UPI amount
      document.getElementById('upiAmount').textContent = currentPaymentData.totalPrice;
    }
  }

  // Pay with user's UPI ID
  function payWithUserUPI() {
    const userUpiId = document.getElementById('userUpiId').value.trim();
    
    if (!userUpiId) {
      showToast('Please enter your UPI ID', 'error');
      return;
    }

    // Validate UPI ID format
    const upiRegex = /^[\w.\-]+@[\w]+$/;
    if (!upiRegex.test(userUpiId)) {
      showToast('Invalid UPI ID format', 'error');
      return;
    }

    // Generate UPI payment link
    const merchantUPI = document.getElementById('upiId').textContent.trim();
    const amount = currentPaymentData.totalPrice;
    const merchantName = 'Fuel Flux';
    const note = `${currentPaymentData.planName} Plan - ${currentPaymentData.duration}`;
    
    // UPI intent link (opens UPI apps on mobile)
    const upiLink = `upi://pay?pa=${merchantUPI}&pn=${encodeURIComponent(merchantName)}&am=${amount}&cu=INR&tn=${encodeURIComponent(note)}`;
    
    // Try to open UPI app
    window.location.href = upiLink;
    
    showToast('Opening UPI app... Complete payment and upload screenshot', 'success');
  }

  // Submit UPI payment proof
  async function submitUPIPayment() {
    const screenshot = document.getElementById('upiPaymentScreenshot').files[0];
    const transactionId = document.getElementById('upiTransactionId').value.trim();
    
    if (!screenshot) {
      showToast('Please upload payment screenshot', 'error');
      return;
    }

    try {
      const formData = new FormData();
      formData.append('screenshot', screenshot);
      formData.append('plan_type', currentPaymentData.planName);
      formData.append('duration', currentPaymentData.duration);
      formData.append('pump_id', currentPaymentData.pumpId);
      if (transactionId) formData.append('transaction_id', transactionId);

      const response = await fetch('/subscription/submit-qr-payment', {
        method: 'POST',
        headers: {
          'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ""
        },
        credentials: 'same-origin',
        body: formData
      });

      const result = await response.json();

      if (result.success) {
        showToast(result.message, 'success');
        closeQRModal();
        setTimeout(() => {
          showToast('Check back in 24 hours for subscription activation', 'success');
        }, 3000);
      } else {
        showToast(result.error || 'Failed to submit payment', 'error');
      }
    } catch (error) {
      console.error(error);
      showToast('Network error. Please try again.', 'error');
    }
  }

  // Preview screenshot
  document.getElementById('paymentScreenshot').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file && file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = function(event) {
        document.getElementById('previewImage').src = event.target.result;
        document.getElementById('screenshotPreview').classList.remove('hidden');
      };
      reader.readAsDataURL(file);
    }
  });

  async function submitQRPayment() {
    const screenshot = document.getElementById('paymentScreenshot').files[0];
    const transactionId = document.getElementById('transactionId').value.trim();
    
    if (!screenshot) {
      showToast('Please upload payment screenshot', 'error');
      return;
    }

    const submitBtn = document.getElementById('submitPaymentProof');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';

    try {
      const formData = new FormData();
      formData.append('screenshot', screenshot);
      formData.append('plan_type', currentPaymentData.planName);
      formData.append('duration', currentPaymentData.duration);
      formData.append('pump_id', currentPaymentData.pumpId);
      if (transactionId) formData.append('transaction_id', transactionId);

      const response = await fetch('/subscription/submit-qr-payment', {
        method: 'POST',
        headers: {
          'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ""
        },
        credentials: 'same-origin',
        body: formData
      });

      const result = await response.json();

      if (result.success) {
        showToast(result.message, 'success');
        closeQRModal();
        
        // Show verification pending message
        setTimeout(() => {
          showToast('Check back in 24 hours for subscription activation', 'success');
        }, 3000);
      } else {
        showToast(result.error || 'Failed to submit payment', 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit for Verification';
      }
    } catch (error) {
      console.error(error);
      showToast('Network error. Please try again.', 'error');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit for Verification';
    }
  }

  // Settlement Section Functions
  function initSettlementSection() {
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    const form = document.getElementById('settlementForm');
    const errorEl = document.getElementById('settlementError');
    const historyList = document.getElementById('settlementHistoryList');
    const refreshBtn = document.getElementById('refreshSettlementBtn');

    async function loadSettlementSummary() {
      try {
        const res = await fetch('/settlement/summary', { credentials: 'include' });
        const data = await res.json();
        if (data.success && data.summary) {
          const s = data.summary;
          document.getElementById('availableBalance').textContent = '‚Çπ' + s.available_balance;
          document.getElementById('pendingSettlements').textContent = '‚Çπ' + s.pending_settlements;
          document.getElementById('todaySales').textContent = '‚Çπ' + s.today_sales;
        }
      } catch (err) {
        console.error('Failed to load settlement summary:', err);
      }
    }

    async function loadSettlementHistory() {
      if (!historyList) return;
      historyList.innerHTML = '<p class="text-gray-400 text-sm">Loading settlement history...</p>';
      try {
        const res = await fetch('/settlement/history', { credentials: 'include' });
        const data = await res.json();
        if (!data.success || !Array.isArray(data.settlements) || data.settlements.length === 0) {
          historyList.innerHTML = '<p class="text-gray-400 text-sm">No settlement history yet.</p>';
          return;
        }
        historyList.innerHTML = data.settlements.map(s => `
          <div class="bg-fuel-gray p-3 rounded text-sm">
            <div class="flex justify-between items-start mb-2">
              <div>
                <div class="font-semibold text-gray-200">‚Çπ${s.amount.toFixed(2)}</div>
                <div class="text-gray-400 text-xs">Status: ${s.status}</div>
                ${s.bank_reference ? `<div class="text-gray-500 text-xs">Ref: ${s.bank_reference}</div>` : ''}
              </div>
              <div class="text-right">
                <div class="text-gray-400 text-xs">${new Date(s.requested_at).toLocaleDateString('en-IN')}</div>
                ${s.processed_at ? `<div class="text-gray-500 text-xs">Processed: ${new Date(s.processed_at).toLocaleDateString('en-IN')}</div>` : ''}
              </div>
            </div>
            <div class="text-xs ${s.status === 'pending' ? 'text-yellow-400' : s.status === 'approved' ? 'text-green-400' : 'text-red-400'} capitalize">${s.status}</div>
          </div>`).join('');
      } catch (err) {
        console.error(err);
        historyList.innerHTML = '<p class="text-gray-400 text-sm">Failed to load settlement history.</p>';
      }
    }

    // Form submission: request settlement
    form.addEventListener('submit', async function(e){
      e.preventDefault();
      errorEl.classList.add('hidden');
      const amount = parseFloat(document.getElementById('settlementAmount').value || '0');
      const bankRef = document.getElementById('bankReference').value.trim();

      if (!amount || amount <= 0) {
        errorEl.textContent = 'Please enter a valid amount.';
        errorEl.classList.remove('hidden');
        return;
      }

      try {
        const res = await fetch('/settlement/request', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
          },
          credentials: 'include',
          body: JSON.stringify({
            amount: amount,
            bank_reference: bankRef
          })
        });
        const data = await res.json();
        if (!data.success) {
          errorEl.textContent = data.message || 'Failed to request settlement.';
          errorEl.classList.remove('hidden');
          return;
        }
        showToast('Settlement request submitted successfully.', 'success');
        form.reset();
        loadSettlementSummary();
        loadSettlementHistory();
      } catch (err) {
        console.error(err);
        errorEl.textContent = 'Server error. Please try again.';
        errorEl.classList.remove('hidden');
      }
    });

    // Wire refresh button
    if (refreshBtn) refreshBtn.addEventListener('click', () => { loadSettlementSummary(); loadSettlementHistory(); });

    // Initial loads
    loadSettlementSummary();
    loadSettlementHistory();
  }
</script>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</body>
</html>