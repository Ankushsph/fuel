<!-- templates/Pump-Owner/select-pump.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <title>Select Pump - Fuel Flux</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/tailwind.css') }}">
  <style>
      #toast {
    position: fixed;
    top: -100px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 50;
    padding: 1rem 1.5rem;
    border-radius: 0.5rem;
    font-weight: 500;
    color: white;
    opacity: 0;
    transition: all 0.5s ease-in-out;
    min-width: 250px;
    text-align: center;
  }

  #toast.show {
    top: 2rem;
    opacity: 1;
  }

  #toast.success {
    background-color: #16a34a; /* green */
  }

  #toast.error {
    background-color: #dc2626; /* red */
  }
  </style>
</head>
<body class="bg-fuel-black text-white min-h-screen flex flex-col">

  <!-- Toast -->
  <div id="toast"></div>

  <!-- Header / Navigation -->
  <nav class="bg-fuel-gray p-4 flex justify-between items-center shadow-lg">
    <div class="flex items-center space-x-4">
      <img src="{{ url_for('static', filename='images/logo2.png') }}" alt="Fuel Flux Logo" class="h-10 w-auto" />
      <span class="text-fuel-orange font-bold text-xl">Pump Owner</span>
    </div>
    <div class="flex items-center space-x-4">
      <a href="/" class="text-fuel-orange hover:text-white transition-colors">Home</a>
      <a href="{{ url_for('auth.logout') }}" class="bg-fuel-orange hover:bg-orange-600 px-4 py-2 rounded-lg font-semibold transition">Logout</a>
    </div>
  </nav>

  <!-- Main Container -->
<div class="flex-1 flex justify-center items-start p-6">
  <div class="bg-fuel-gray w-full max-w-4xl rounded-2xl shadow-lg p-6 flex flex-col space-y-6 h-[550px]">



      <!-- Header -->
      <div class="flex justify-between items-center mb-4">
        <h1 class="text-2xl font-bold text-fuel-orange">Your Pumps</h1>
        <button id="addPumpBtn" class="bg-fuel-orange hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-semibold transition" onclick="document.getElementById('pumpModal').classList.remove('hidden')">
          + Add Pump
        </button>
      </div>

      <!-- Add Pump Form (toggle visibility) -->
      <form id="addPumpForm" class="flex flex-col md:flex-row gap-4 mb-4 hidden">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="text" name="pump_name" placeholder="Pump Name" required
               class="flex-1 p-3 rounded-lg bg-fuel-black text-white border border-gray-600"/>
        <input type="text" name="location" placeholder="Location" required
               class="flex-1 p-3 rounded-lg bg-fuel-black text-white border border-gray-600"/>
        <button type="submit" class="bg-fuel-orange text-white px-4 py-2 rounded-lg hover:bg-orange-600 font-semibold transition">
          Add Pump
        </button>
      </form>

      <!-- Pumps Grid -->
      <div id="pumpsList" class="flex flex-col gap-3 overflow-y-auto flex-1">
        {% for pump in pumps %}
        <div class="pump-item bg-fuel-black rounded-xl p-4 flex justify-between items-center hover:bg-fuel-gray cursor-pointer transition mb-3"
            data-pump-id="{{ pump.id }}">
          <div>
            <h3 class="text-lg font-semibold text-fuel-orange">{{ pump.name }}</h3>
            <p class="text-gray-400">{{ pump.location }}</p>
          </div>
          <button data-pump-id="{{ pump.id }}" 
                  class="bg-red-600 text-white px-3 py-2 rounded-lg hover:bg-red-700 font-semibold transition delete-pump">
            Remove
          </button>
        </div>
        {% else %}
        <div class="text-gray-400 text-center py-6">No pumps added yet.</div>
        {% endfor %}
      </div>


    </div>
  </div>
<script>
  const toast = document.getElementById('toast');

  // Toast helper: messageType can be 'success' or 'error'
  function showToast(message, messageType = 'success') {
    toast.textContent = message;
    toast.className = 'show ' + messageType; // add class for background color
    setTimeout(() => toast.className = '', 3000);
  }

  // Toggle Add Pump Form
  const addPumpBtn = document.getElementById('addPumpBtn');
  const addPumpForm = document.getElementById('addPumpForm');
  addPumpBtn.addEventListener('click', () => addPumpForm.classList.toggle('hidden'));

  // CSRF token
  const csrfMeta = document.querySelector('meta[name="csrf-token"]');
  const csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : '';

  const pumpsList = document.getElementById('pumpsList');

  // Event delegation for Remove & Select
  pumpsList.addEventListener('click', async (event) => {
    const deleteBtn = event.target.closest('.delete-pump');
    if (deleteBtn) {
      event.stopPropagation(); // prevent parent click
      const pumpId = deleteBtn.dataset.pumpId;

      if (!confirm("Are you sure you want to remove this pump?")) return;

      try {
        const res = await fetch(`/pump/remove/${pumpId}`, {
          method: 'DELETE',
          headers: {
            'X-CSRFToken': csrfToken
          }
        });
        const result = await res.json();
        if (res.ok && result.success) {
          showToast(result.message, 'success');
          setTimeout(() => location.reload(), 800);
        } else {
          showToast(result.message || "Failed to remove pump.", 'error');
        }
      } catch (err) {
        console.error(err);
        showToast("Network error. Try again.", 'error');
      }
      return;
    }

    const pumpItem = event.target.closest('.pump-item');
    if (pumpItem) {
      document.querySelectorAll('.pump-item').forEach(i => i.classList.remove('ring-2', 'ring-fuel-orange'));
      pumpItem.classList.add('ring-2', 'ring-fuel-orange');

      const pumpId = pumpItem.dataset.pumpId;
      window.location.href = `/pump/${pumpId}/dashboard`;
    }
  });

  // Add Pump via AJAX
  addPumpForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = Object.fromEntries(new FormData(addPumpForm).entries());

    try {
      const res = await fetch('/pump/add', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(formData)
      });

      const text = await res.text();
      try {
        const result = JSON.parse(text);
        if (res.ok && result.success) {
          showToast(result.message, 'success');
          setTimeout(() => location.reload(), 1000);
        } else {
          showToast(result.message || "Failed to add pump.", 'error');
        }
      } catch {
        console.error("Non-JSON response:", text);
        showToast("Server error: Invalid response.", 'error');
      }
    } catch (err) {
      console.error(err);
      showToast("Network error. Try again.", 'error');
    }
  });
</script>


<!--PUMP REGISTRATION FORM-->

<!-- Trigger Button -->
  <!-- Modal -->
 <div id="pumpModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 px-4 overflow-y-auto">
  <div class="bg-fuel-gray text-fuel-orange font-bold rounded-xl w-full max-w-md p-4 relative">

    <!-- Close Button -->
    <button onclick="document.getElementById('pumpModal').classList.add('hidden')"
            class="absolute top-2 right-2 text-black text-2xl font-bold" aria-label="Close Modal">
      &times;
    </button>

    <h1 class="text-orange-500 text-center text-2xl mb-4">Pump Registration Form</h1>

    <form action="/submit" method="POST" enctype="multipart/form-data" class="space-y-3">
      <div>
        <label for="ownerName" class="text-orange-500 block mb-1 text-sm">Pump Owner Name:</label>
        <input type="text" id="ownerName" name="ownerName"
               class="rounded-md w-full border p-1.5 text-sm text-orange-500 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-orange-500 "
               placeholder="Enter owner's name" required>
      </div>

      <div>
        <label for="address" class="text-orange-500 block mb-1 text-sm">Pump Address:</label>
        <textarea id="address" name="address" rows="2"
                  class="w-full rounded-sm border p-1.5 text-sm text-black placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-orange-500"
                  placeholder="Enter pump address" required></textarea>
      </div>

      <div>
        <label for="contact" class="text-orange-500 block mb-1 text-sm">Owner Contact Number:</label>
        <input type="tel" id="contact" name="contact" pattern="[0-9]{10}"
               class="rounded-sm w-full border p-1.5 text-sm text-black placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-orange-500"
               placeholder="10-digit mobile number" required>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div>
          <label for="openTime" class="text-orange-500 block mb-1 text-sm">Opening Time:</label>
          <input type="time" id="openTime" name="openTime"
                 class="rounded-sm w-full border p-1.5 text-sm text-black focus:outline-none focus:ring-2 focus:ring-orange-500" required>
        </div>

        <div>
          <label for="closeTime" class="text-orange-500 block mb-1 text-sm">Closing Time:</label>
          <input type="time" id="closeTime" name="closeTime"
                 class="rounded-sm w-full border p-1.5 text-sm text-black focus:outline-none focus:ring-2 focus:ring-orange-500" required>
        </div>
      </div>

      <div>
        <label for="documents" class="text-orange-500 block mb-1 text-sm">Upload Documents:</label>
        <input type="file" id="documents" name="documents[]" multiple
               accept=".pdf,.doc,.docx,image/*"
               class="w-full text-sm text-black file:mr-2 file:py-1 file:px-3 file:rounded file:border-0 file:text-white file:bg-orange-500 hover:file:bg-orange-600">
      </div>

      <div class="text-center">
        <input type="submit" value="Submit"
               class="bg-fuel-orange text-white px-4 py-2 w-full rounded-xl hover:scale-105 transition-transform focus:outline-none focus:ring-2 focus:ring-white cursor-pointer text-sm">
      </div>
    </form>
  </div>
</div>



</body>
</html>
