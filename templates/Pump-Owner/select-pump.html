<!-- templates/Pump-Owner/select-pump.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <title>Select Pump - Fuel Flux</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/tailwind.css') }}">
  <style>
    #toast {
      position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
      z-index: 50; padding: 1rem 1.5rem; border-radius: 0.5rem;
      font-weight: 500; color: white; opacity: 0;
      transition: all 0.5s ease-in-out; min-width: 250px; text-align: center;
    }
    #toast.show { top: 2rem; opacity: 1; }
  </style>
</head>
<body class="bg-fuel-black text-white min-h-screen flex flex-col">

  <!-- Toast -->
  <div id="toast"></div>

  <!-- Header / Navigation -->
  <nav class="bg-fuel-gray p-4 flex justify-between items-center shadow-lg">
    <div class="flex items-center space-x-4">
      <img src="{{ url_for('static', filename='images/logo2.png') }}" alt="Fuel Flux Logo" class="h-10 w-auto" />
      <span class="text-fuel-orange font-bold text-xl">Pump Owner</span>
    </div>
    <div class="flex items-center space-x-4">
      <a href="/" class="text-fuel-orange hover:text-white transition-colors">Home</a>
      <a href="{{ url_for('auth.logout') }}" class="bg-fuel-orange hover:bg-orange-600 px-4 py-2 rounded-lg font-semibold transition">Logout</a>
    </div>
  </nav>

  <!-- Main Container -->
<div class="flex-1 flex justify-center items-start p-6">
  <div class="bg-fuel-gray w-full max-w-4xl rounded-2xl shadow-lg p-6 flex flex-col space-y-6 h-[550px]">



      <!-- Header -->
      <div class="flex justify-between items-center mb-4">
        <h1 class="text-2xl font-bold text-fuel-orange">Your Pumps</h1>
        <button id="addPumpBtn" class="bg-fuel-orange hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-semibold transition">
          + Add Pump
        </button>
      </div>

      <!-- Add Pump Form (toggle visibility) -->
      <form id="addPumpForm" class="flex flex-col md:flex-row gap-4 mb-4 hidden">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="text" name="pump_name" placeholder="Pump Name" required
               class="flex-1 p-3 rounded-lg bg-fuel-black text-white border border-gray-600"/>
        <input type="text" name="location" placeholder="Location" required
               class="flex-1 p-3 rounded-lg bg-fuel-black text-white border border-gray-600"/>
        <button type="submit" class="bg-fuel-orange text-white px-4 py-2 rounded-lg hover:bg-orange-600 font-semibold transition">
          Add Pump
        </button>
      </form>

      <!-- Pumps Grid -->
      <div id="pumpsList" class="flex flex-col gap-3 overflow-y-auto flex-1">
        {% for pump in pumps %}
        <div class="pump-item bg-fuel-black rounded-xl p-4 flex justify-between items-center hover:bg-fuel-gray cursor-pointer transition mb-3"
            data-pump-id="{{ pump.id }}">
          <div>
            <h3 class="text-lg font-semibold text-fuel-orange">{{ pump.name }}</h3>
            <p class="text-gray-400">{{ pump.location }}</p>
          </div>
          <button data-pump-id="{{ pump.id }}" 
                  class="bg-red-600 text-white px-3 py-2 rounded-lg hover:bg-red-700 font-semibold transition delete-pump">
            Remove
          </button>
        </div>
        {% else %}
        <div class="text-gray-400 text-center py-6">No pumps added yet.</div>
        {% endfor %}
      </div>


    </div>
  </div>

<script>
  const toast = document.getElementById('toast');
  function showToast(message) {
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 3000);
  }

  // Toggle Add Pump Form
  const addPumpBtn = document.getElementById('addPumpBtn');
  const addPumpForm = document.getElementById('addPumpForm');
  addPumpBtn.addEventListener('click', () => {
    addPumpForm.classList.toggle('hidden');
  });

  // Handle pump deletion
  document.querySelectorAll('.delete-pump').forEach(btn => {
    btn.addEventListener('click', async () => {
      const pumpId = btn.dataset.pumpId;
      if (confirm("Are you sure you want to remove this pump?")) {
        const res = await fetch(`/pump/remove/${pumpId}`, { method: 'DELETE' });
        if (res.ok) location.reload();
        else showToast("Failed to remove pump.");
      }
    });
  });

  // ✅ Fetch CSRF token safely
  const csrfMeta = document.querySelector('meta[name="csrf-token"]');
  const csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : '';

  // Handle adding new pump via AJAX
  addPumpForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = Object.fromEntries(new FormData(addPumpForm).entries());

    try {
      const res = await fetch('/pump/add', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken   // ✅ Send CSRF token properly
        },
        body: JSON.stringify(formData)
      });

      const text = await res.text(); // read as text (for debugging)
      try {
        const result = JSON.parse(text);
        if (res.ok && result.success) {
          showToast(result.message);
          setTimeout(() => location.reload(), 1000);
        } else {
          showToast(result.message || "Failed to add pump.");
        }
      } catch {
        console.error("Non-JSON response:", text);
        showToast("Server error: Invalid response.");
      }
    } catch (err) {
      console.error(err);
      showToast("Network error. Try again.");
    }
  });


  // Handle selecting a pump (highlight)
document.querySelectorAll('.pump-item').forEach(item => {
  item.addEventListener('click', () => {
    // Remove highlight from all
    document.querySelectorAll('.pump-item').forEach(i => i.classList.remove('ring-2', 'ring-fuel-orange'));
    // Highlight clicked one
    item.classList.add('ring-2', 'ring-fuel-orange');
    
    // Optional: redirect to dashboard on click
    const pumpId = item.dataset.pumpId;
    window.location.href = `/pump/${pumpId}/dashboard`;
  });
});

</script>

</body>
</html>
