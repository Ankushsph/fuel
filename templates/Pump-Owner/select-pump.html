<!-- templates/Pump-Owner/select-pump.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <title>Select Pump - Fuel Flux</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/tailwind.css') }}">
  <style>
      #toast {
    position: fixed;
    top: -100px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 50;
    padding: 1rem 1.5rem;
    border-radius: 0.5rem;
    font-weight: 500;
    color: white;
    opacity: 0;
    transition: all 0.5s ease-in-out;
    min-width: 250px;
    text-align: center;
  }

  #toast.show {
    top: 2rem;
    opacity: 1;
  }

  #toast.success {
    background-color: #16a34a; /* green */
  }

  #toast.error {
    background-color: #dc2626; /* red */
  }
  </style>
</head>
<body class="bg-fuel-black text-white min-h-screen flex flex-col">

  <!-- Toast -->
  <div id="toast"></div>

  <div id="flashedMessagesData" data-messages='{{ get_flashed_messages(with_categories=true) | tojson | e }}' hidden></div>

  <!-- Header / Navigation -->
  <nav class="bg-fuel-gray p-2 md:p-4 shadow-lg">
    <div class="flex justify-between items-center gap-2">
      <div class="flex items-center gap-1 md:gap-3 flex-1 min-w-0">
        <img src="{{ url_for('static', filename='images/logo2.png') }}" 
             alt="Fuel Flux Logo" 
             class="h-6 md:h-10 w-auto flex-shrink-0"
             style="background: none !important; background-color: transparent !important; mix-blend-mode: screen;" />
        <span class="text-fuel-orange font-bold text-xs md:text-xl truncate hidden sm:inline">Pump Owner</span>
      </div>
      
      <!-- Desktop Menu -->
      <div class="hidden md:flex items-center space-x-4 flex-shrink-0">
        <a href="/" class="text-fuel-orange hover:text-white transition-colors">Home</a>
        <a href="{{ url_for('auth.logout') }}" class="bg-fuel-orange hover:bg-orange-600 px-4 py-2 rounded-lg font-semibold transition">Logout</a>
      </div>
      
      <!-- Mobile Menu Button -->
      <button id="mobile-menu-btn" class="md:hidden text-white text-lg focus:outline-none flex-shrink-0">☰</button>
    </div>
    
    <!-- Mobile Menu -->
    <div id="mobile-menu" class="hidden md:hidden mt-3 space-y-2 pb-2">
      <a href="/" class="block text-fuel-orange hover:text-white transition-colors py-2">Home</a>
      <a href="{{ url_for('auth.logout') }}" class="block bg-fuel-orange hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-semibold transition text-center">Logout</a>
    </div>
  </nav>

  <!-- Main Container -->
<div class="flex-1 flex justify-center items-start p-4 md:p-6">
  <div class="bg-fuel-gray w-full max-w-4xl rounded-2xl shadow-lg p-4 md:p-6 flex flex-col space-y-4 md:space-y-6 min-h-[500px] md:h-[550px]">



      <!-- Header -->
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4">
        <h1 class="text-xl md:text-2xl font-bold text-fuel-orange">Your Pumps</h1>
        <button id="addPumpBtn" class="bg-fuel-orange hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-semibold transition w-full sm:w-auto text-sm md:text-base" onclick="document.getElementById('pumpModal').classList.remove('hidden')">
          + Add Pump
        </button>
      </div>

      <!-- Pumps Grid -->
      <div id="pumpsList" class="flex flex-col gap-3 overflow-y-auto flex-1">
        <!-- Approved Pumps -->
        {% if approved_pumps %}
          <div class="mb-6">
            <h2 class="text-lg font-semibold text-green-400 mb-3">✅ Approved Pumps</h2>
            {% for pump in approved_pumps %}
              <div class="pump-item bg-fuel-black rounded-xl p-3 md:p-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 hover:bg-fuel-gray cursor-pointer transition mb-3"
                    data-pump-id="{{ pump.id }}">
                <div class="flex-1">
                  <h3 class="text-base md:text-lg font-semibold text-fuel-orange">{{ pump.name }}</h3>
                  <p class="text-sm text-gray-400">{{ pump.location }}</p>
                  <p class="text-xs text-green-400 mt-1">✅ Verified - Click to access dashboard</p>
                </div>
                <a href="{{ url_for('pump_dashboard.pump_dashboard', pump_id=pump.id) }}?show_subscription=true"
                   class="bg-fuel-orange text-white px-3 py-2 rounded-lg hover:bg-orange-600 font-semibold transition text-sm w-full sm:w-auto text-center">
                  Open
                </a>
              </div>
            {% endfor %}
          </div>
        {% endif %}

        <!-- Pending Pumps -->
        {% if pending_requests %}
          <div class="mb-6">
            <h2 class="text-lg font-semibold text-yellow-400 mb-3">⏳ Pending Verification</h2>
            {% for reg_request in pending_requests %}
              <div class="pump-item bg-fuel-black rounded-xl p-3 md:p-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 hover:bg-fuel-gray cursor-pointer transition mb-3 border border-yellow-600">
                <div class="flex-1">
                  <h3 class="text-base md:text-lg font-semibold text-fuel-orange">{{ reg_request.pump.name }}</h3>
                  <p class="text-sm text-gray-400">{{ reg_request.pump_address }}</p>
                  <p class="text-xs text-yellow-400 mt-1">⏳ Pending Admin Verification</p>
                  <p class="text-xs text-gray-500">Submitted: {{ reg_request.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                </div>
                <div class="flex flex-col gap-2">
                  <a href="{{ url_for('pump_dashboard.pump_dashboard', pump_id=reg_request.pump.id) }}?show_subscription=true"
                     class="bg-yellow-600 text-white px-3 py-2 rounded-lg hover:bg-yellow-700 font-semibold transition text-sm w-full sm:w-auto text-center">
                    Complete Subscription
                  </a>
                  <button data-pump-id="{{ reg_request.pump.id }}" 
                          class="bg-red-600 text-white px-3 py-2 rounded-lg hover:bg-red-700 font-semibold transition delete-pump text-sm w-full sm:w-auto">
                    Remove
                  </button>
                </div>
              </div>
            {% endfor %}
          </div>
        {% endif %}

        <!-- No pumps message -->
        {% if not approved_pumps and not pending_requests %}
          <div class="text-gray-400 text-center py-6 text-sm md:text-base">No pumps added yet.</div>
        {% endif %}
      </div>


    </div>
  </div>
<script>
  // Mobile menu toggle
  document.getElementById('mobile-menu-btn').addEventListener('click', function() {
    const menu = document.getElementById('mobile-menu');
    menu.classList.toggle('hidden');
  });

  const toast = document.getElementById('toast');

  // Toast helper: messageType can be 'success' or 'error'
  function showToast(message, messageType = 'success') {
    toast.textContent = message;
    toast.className = 'show ' + messageType; // add class for background color
    setTimeout(() => toast.className = '', 3000);
  }

  // Show Flask flash messages (if any) using the same toast UI
  document.addEventListener('DOMContentLoaded', () => {
    const flashedMessagesEl = document.getElementById('flashedMessagesData');
    const rawMessages = flashedMessagesEl ? flashedMessagesEl.getAttribute('data-messages') : '[]';
    let flashedMessages = [];
    try {
      flashedMessages = JSON.parse(rawMessages || '[]');
    } catch (e) {
      flashedMessages = [];
    }
    if (Array.isArray(flashedMessages)) {
      flashedMessages.forEach((item) => {
        if (Array.isArray(item) && item.length >= 2) {
          const category = item[0];
          const message = item[1];
          showToast(message, category);
        }
      });
    }
  });

  // CSRF token
  const csrfMeta = document.querySelector('meta[name="csrf-token"]');
  const csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : '';

  const pumpsList = document.getElementById('pumpsList');

  // Event delegation for Remove & Select
  pumpsList.addEventListener('click', async (event) => {
    const deleteBtn = event.target.closest('.delete-pump');
    if (deleteBtn) {
      event.stopPropagation(); // prevent parent click
      const pumpId = deleteBtn.dataset.pumpId;

      if (!confirm("Are you sure you want to remove this pump?")) return;

      try {
        const res = await fetch(`/pump/remove/${pumpId}`, {
          method: 'DELETE',
          headers: {
            'X-CSRFToken': csrfToken
          }
        });
        const result = await res.json();
        if (res.ok && result.success) {
          showToast(result.message, 'success');
          setTimeout(() => location.reload(), 800);
        } else {
          showToast(result.message || "Failed to remove pump.", 'error');
        }
      } catch (err) {
        console.error(err);
        showToast("Network error. Try again.", 'error');
      }
      return;
    }

    const pumpItem = event.target.closest('.pump-item');
    if (pumpItem) {
      document.querySelectorAll('.pump-item').forEach(i => i.classList.remove('ring-2', 'ring-fuel-orange'));
      pumpItem.classList.add('ring-2', 'ring-fuel-orange');

      const pumpId = pumpItem.dataset.pumpId;
      if (!pumpId) return;
      window.location.href = `/pump/${pumpId}/dashboard?show_subscription=true`;
    }
  });

  // Employee management in registration form
  let employeeCount = 0;
  function addEmployeeField() {
    employeeCount++;
    const div = document.createElement('div');
    div.className = 'employee-field bg-fuel-black p-2 rounded flex flex-col gap-2';
    div.innerHTML = `
      <div class="grid grid-cols-2 gap-2">
        <input type="text" name="employee_name_${employeeCount}" placeholder="Employee Name" 
               class="rounded p-1.5 text-sm text-black" required>
        <input type="tel" name="employee_phone_${employeeCount}" placeholder="Phone" 
               class="rounded p-1.5 text-sm text-black">
      </div>
      <div class="grid grid-cols-2 gap-2">
        <input type="text" name="employee_designation_${employeeCount}" placeholder="Designation" 
               class="rounded p-1.5 text-sm text-black">
        <input type="file" name="employee_photo_${employeeCount}" accept="image/*" 
               class="text-xs text-black file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-white file:bg-orange-500" required>
      </div>
      <button type="button" onclick="this.parentElement.remove()" class="text-red-500 text-xs">Remove</button>
    `;
    document.getElementById('employeeList').appendChild(div);
  }
</script>


<!--PUMP REGISTRATION FORM-->

<!-- Trigger Button -->
  <!-- Modal -->
 <div id="pumpModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4 overflow-y-auto">
  <div class="bg-fuel-gray text-fuel-orange font-bold rounded-xl w-full max-w-md p-4 md:p-6 relative my-auto max-h-[90vh] overflow-y-auto">

    <!-- Close Button -->
    <button onclick="document.getElementById('pumpModal').classList.add('hidden')"
            class="absolute top-2 right-2 text-black text-2xl font-bold" aria-label="Close Modal">
      &times;
    </button>

    <h1 class="text-orange-500 text-center text-xl md:text-2xl mb-4">Pump Registration Form</h1>

    <form action="{{ url_for('pump.submit_pump_registration') }}" method="POST" enctype="multipart/form-data" class="space-y-3 text-sm md:text-base">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      <div>
        <label for="pumpName" class="text-orange-500 block mb-1 text-sm">Pump Name:</label>
        <input type="text" id="pumpName" name="pumpName"
               class="rounded-md w-full border p-1.5 text-sm text-orange-500 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-orange-500 "
               placeholder="Enter pump name" required>
      </div>

      <div>
        <label for="ownerName" class="text-orange-500 block mb-1 text-sm">Pump Owner Name:</label>
        <input type="text" id="ownerName" name="ownerName"
               class="rounded-md w-full border p-1.5 text-sm text-orange-500 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-orange-500 "
               placeholder="Enter owner's name" required>
      </div>

      <div>
        <label for="address" class="text-orange-500 block mb-1 text-sm">Pump Address:</label>
        <textarea id="address" name="address" rows="2"
                  class="w-full rounded-sm border p-1.5 text-sm text-black placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-orange-500"
                  placeholder="Enter pump address" required></textarea>
      </div>

      <div>
        <label for="contact" class="text-orange-500 block mb-1 text-sm">Owner Contact Number:</label>
        <input type="tel" id="contact" name="contact" pattern="[0-9]{10}"
               class="rounded-sm w-full border p-1.5 text-sm text-black placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-orange-500"
               placeholder="10-digit mobile number" required>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div>
          <label for="openTime" class="text-orange-500 block mb-1 text-sm">Opening Time:</label>
          <input type="time" id="openTime" name="openTime"
                 class="rounded-sm w-full border p-1.5 text-sm text-black focus:outline-none focus:ring-2 focus:ring-orange-500" required>
        </div>

        <div>
          <label for="closeTime" class="text-orange-500 block mb-1 text-sm">Closing Time:</label>
          <input type="time" id="closeTime" name="closeTime"
                 class="rounded-sm w-full border p-1.5 text-sm text-black focus:outline-none focus:ring-2 focus:ring-orange-500" required>
        </div>
      </div>

      <div>
        <label for="documents" class="text-orange-500 block mb-1 text-sm">Upload Documents:</label>
        <input type="file" id="documents" name="documents[]" multiple
               accept=".pdf,.doc,.docx,image/*"
               class="w-full text-sm text-black file:mr-2 file:py-1 file:px-3 file:rounded file:border-0 file:text-white file:bg-orange-500 hover:file:bg-orange-600">
      </div>

      <div class="border-t border-orange-500 pt-3 mt-3">
        <p class="text-orange-500 text-sm font-semibold mb-2">Add Employees (Optional - Can add later)</p>
        <div id="employeeList" class="space-y-2 mb-2 max-h-40 overflow-y-auto"></div>
        <button type="button" onclick="addEmployeeField()" class="bg-orange-400 text-white px-3 py-1 rounded text-xs hover:bg-orange-500">
          + Add Employee
        </button>
      </div>

      <div class="text-center">
        <input type="submit" value="Submit"
               class="bg-fuel-orange text-white px-4 py-2 w-full rounded-xl hover:scale-105 transition-transform focus:outline-none focus:ring-2 focus:ring-white cursor-pointer text-sm">
      </div>
    </form>
  </div>
</div>



</body>
</html>
