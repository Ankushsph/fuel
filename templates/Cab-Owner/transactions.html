<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="csrf-token" content="{{ csrf_token() }}">

  <title>Transactions - Fuel Flux</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/tailwind.css') }}">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <style>
    #toast {
      position: fixed;
      top: -100px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 50;
      padding: 1rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 500;
      color: white;
      opacity: 0;
      transition: all 0.5s ease-in-out;
      min-width: 250px;
      text-align: center;
    }
    #toast.show { top: 2rem; opacity: 1; }
    
    .transaction-row:hover {
      background-color: rgba(251, 146, 60, 0.1);
      cursor: pointer;
    }
    
    .status-pending { background-color: rgba(251, 191, 36, 0.2); }
    .status-verified { background-color: rgba(34, 197, 94, 0.2); }
    .status-settled { background-color: rgba(59, 130, 246, 0.2); }
    .status-failed { background-color: rgba(239, 68, 68, 0.2); }
  </style>
</head>
<body class="bg-fuel-black text-white min-h-screen flex flex-col">

  <!-- Toast -->
  <div id="toast"></div>

  <!-- Header -->
  <header class="bg-fuel-gray p-2 md:p-4 shadow-md">
    <div class="flex justify-between items-center gap-2">
      <div class="flex items-center gap-1 md:gap-2 flex-1 min-w-0">
        <button id="openMobileSidebar" class="lg:hidden text-fuel-orange text-lg md:text-xl font-bold flex-shrink-0">‚ò∞</button>
        <img src="{{ url_for('static', filename='images/logo2.png') }}" 
             alt="Fuel Flux Logo" 
             class="h-6 md:h-10 w-auto flex-shrink-0"
             style="background: none !important; background-color: transparent !important; mix-blend-mode: screen;" />
        <span class="text-fuel-orange font-bold text-xs md:text-xl truncate hidden sm:inline">Transactions</span>
      </div>
      <div class="flex gap-2">
        <button onclick="exportTransactions('csv')" 
                class="bg-green-600 hover:bg-green-700 px-2 py-1.5 md:px-4 md:py-2 rounded-lg font-semibold transition text-xs md:text-base whitespace-nowrap flex-shrink-0 flex items-center gap-1">
          üìä Export CSV
        </button>
        <button onclick="exportTransactions('pdf')" 
                class="bg-blue-600 hover:bg-blue-700 px-2 py-1.5 md:px-4 md:py-2 rounded-lg font-semibold transition text-xs md:text-base whitespace-nowrap flex-shrink-0 flex items-center gap-1">
          üìÑ Export PDF
        </button>
        <button onclick="printTransactions()" 
                class="bg-gray-600 hover:bg-gray-700 px-2 py-1.5 md:px-4 md:py-2 rounded-lg font-semibold transition text-xs md:text-base whitespace-nowrap flex-shrink-0 flex items-center gap-1">
          üñ®Ô∏è Print
        </button>
        <a href="/logout" class="bg-fuel-orange hover:bg-orange-600 px-2 py-1.5 md:px-4 md:py-2 rounded-lg font-semibold transition text-xs md:text-base whitespace-nowrap flex-shrink-0">Logout</a>
      </div>
    </div>
  </header>

  <!-- Main Dashboard Layout -->
  <div class="flex flex-1 min-h-0">
    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 bg-fuel-gray flex-shrink-0 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out fixed lg:relative h-full z-40">
      <div class="p-4 h-full overflow-y-auto">
        <!-- User Info -->
        <div class="mb-6">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 bg-fuel-orange rounded-full flex items-center justify-center">
              <span class="text-white font-bold">{{ user.full_name[0] if user.full_name else 'U' }}</span>
            </div>
            <div>
              <h3 class="font-semibold">{{ user.full_name or 'User' }}</h3>
              <p class="text-xs text-gray-400">Cab Owner</p>
            </div>
          </div>
        </div>

        <!-- Navigation -->
        <nav class="space-y-2">
          <a href="{{ url_for('dashboard.dashboard') }}" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-fuel-black transition">
            <span>üè†</span>
            <span>Dashboard</span>
          </a>
          <a href="{{ url_for('dashboard.transactions') }}" class="flex items-center gap-3 px-3 py-2 rounded-lg bg-fuel-black transition">
            <span>üí≥</span>
            <span>Transactions</span>
          </a>
        </nav>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-4 md:p-6 overflow-y-auto">
      <!-- Page Header -->
      <div class="mb-6">
        <h1 class="text-2xl font-bold mb-2">Transaction History</h1>
        <p class="text-gray-400">View detailed information about all your fuel transactions</p>
      </div>

      <!-- Wallet Balance -->
      <div class="bg-fuel-gray p-4 rounded-lg mb-6">
        <div class="flex justify-between items-center">
          <span class="text-gray-300">Current Wallet Balance</span>
          <span class="text-2xl font-bold text-fuel-orange">‚Çπ{{ "%.2f"|format(wallet_balance) }}</span>
        </div>
      </div>

      <!-- Transactions Table -->
      <div class="bg-fuel-gray rounded-lg overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-fuel-black">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Date & Time</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Vehicle</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Pump Details</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Fuel</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Qty (L)</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Price/L</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Amount</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Status</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-700">
              {% if transactions %}
                {% for transaction in transactions %}
                <tr class="transaction-row hover:bg-fuel-black transition-colors" 
                    onclick="showTransactionDetails({{ transaction.id }})">
                  <td class="px-4 py-3 whitespace-nowrap text-sm">
                    {{ transaction.created_at.strftime('%d-%m-%Y %H:%M') if transaction.created_at else 'N/A' }}
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm">
                    <div>
                      <span class="font-medium">{{ transaction.vehicle_number }}</span>
                      <span class="text-xs text-gray-400 block">{{ transaction.vehicle_type }}</span>
                    </div>
                  </td>
                  <td class="px-4 py-3 text-sm">
                    <div>
                      <span class="font-medium">{{ transaction.pump_name }}</span>
                      <span class="text-xs text-gray-400 block">{{ transaction.pump_location }}</span>
                    </div>
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm">
                    <span class="px-2 py-1 rounded text-xs font-medium
                      {% if transaction.fuel_type == 'Petrol' %}bg-red-900 text-red-200
                      {% elif transaction.fuel_type == 'Diesel' %}bg-blue-900 text-blue-200
                      {% else %}bg-gray-700 text-gray-300{% endif %}">
                      {{ transaction.fuel_type }}
                    </span>
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm">{{ "%.2f"|format(transaction.quantity_litres) }}</td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm">‚Çπ{{ "%.2f"|format(transaction.unit_price) }}</td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-fuel-orange">‚Çπ{{ "%.2f"|format(transaction.amount) }}</td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm">
                    <span class="px-2 py-1 rounded text-xs font-medium
                      status-{{ transaction.status.replace('_', '-') }}">
                      {{ transaction.status.replace('_', ' ').title() }}
                    </span>
                  </td>
                </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="8" class="px-4 py-8 text-center text-gray-400">
                    <div class="flex flex-col items-center">
                      <svg class="w-12 h-12 mb-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 002 2h2a2 2 0 002-2"/>
                      </svg>
                      <span>No transactions found</span>
                      <p class="text-sm mt-1">Your fuel transactions will appear here once you start fueling at our partner pumps</p>
                    </div>
                  </td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Transaction Details Modal -->
      <div id="transactionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-fuel-gray rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">Transaction Details</h2>
            <button onclick="closeModal()" class="text-gray-400 hover:text-white">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          
          <div id="modalContent" class="space-y-4">
            <!-- Content will be loaded here -->
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `show ${type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500'}`;
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    function showTransactionDetails(transactionId) {
      fetch(`/dashboard/transaction/${transactionId}`)
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            showToast(data.error, 'error');
            return;
          }
          
          const modal = document.getElementById('transactionModal');
          const content = document.getElementById('modalContent');
          
          content.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="space-y-3">
                <h3 class="font-semibold text-fuel-orange mb-3">Basic Information</h3>
                
                <div class="flex justify-between">
                  <span class="text-gray-400">Transaction ID:</span>
                  <span class="font-medium">#${data.id}</span>
                </div>
                
                <div class="flex justify-between">
                  <span class="text-gray-400">Date & Time:</span>
                  <span class="font-medium">${data.created_at ? new Date(data.created_at).toLocaleString() : 'N/A'}</span>
                </div>
                
                <div class="flex justify-between">
                  <span class="text-gray-400">Status:</span>
                  <span class="px-2 py-1 rounded text-xs font-medium status-${data.status.replace('_', '-')}">
                    ${data.status.replace('_', ' ').title()}
                  </span>
                </div>
                
                <div class="flex justify-between">
                  <span class="text-gray-400">Verification Level:</span>
                  <span class="font-medium">${data.verification_level || 'N/A'}</span>
                </div>
              </div>
              
              <div class="space-y-3">
                <h3 class="font-semibold text-fuel-orange mb-3">Vehicle Details</h3>
                
                <div class="flex justify-between">
                  <span class="text-gray-400">Vehicle Number:</span>
                  <span class="font-medium">${data.vehicle_number}</span>
                </div>
                
                <div class="flex justify-between">
                  <span class="text-gray-400">Vehicle Type:</span>
                  <span class="font-medium">${data.vehicle_type}</span>
                </div>
              </div>
              
              <div class="space-y-3">
                <h3 class="font-semibold text-fuel-orange mb-3">Pump Information</h3>
                
                <div class="flex justify-between">
                  <span class="text-gray-400">Pump Name:</span>
                  <span class="font-medium">${data.pump_name}</span>
                </div>
                
                <div class="flex justify-between">
                  <span class="text-gray-400">Location:</span>
                  <span class="font-medium">${data.pump_location}</span>
                </div>
                
                <div class="flex justify-between">
                  <span class="text-gray-400">Address:</span>
                  <span class="font-medium">${data.pump_address || 'N/A'}</span>
                </div>
                
                <div class="flex justify-between">
                  <span class="text-gray-400">Phone:</span>
                  <span class="font-medium">${data.pump_phone || 'N/A'}</span>
                </div>
              </div>
              
              <div class="space-y-3">
                <h3 class="font-semibold text-fuel-orange mb-3">Fuel Details</h3>
                
                <div class="flex justify-between">
                  <span class="text-gray-400">Fuel Type:</span>
                  <span class="font-medium">${data.fuel_type}</span>
                </div>
                
                <div class="flex justify-between">
                  <span class="text-gray-400">Quantity:</span>
                  <span class="font-medium">${data.quantity_litres} Litres</span>
                </div>
                
                <div class="flex justify-between">
                  <span class="text-gray-400">Unit Price:</span>
                  <span class="font-medium">‚Çπ${data.unit_price}</span>
                </div>
                
                <div class="flex justify-between">
                  <span class="text-gray-400">Total Amount:</span>
                  <span class="font-bold text-fuel-orange text-lg">‚Çπ${data.amount}</span>
                </div>
              </div>
              
              <div class="space-y-3">
                <h3 class="font-semibold text-fuel-orange mb-3">Verification Details</h3>
                
                <div class="flex justify-between">
                  <span class="text-gray-400">Attendant:</span>
                  <span class="font-medium">${data.attendant}</span>
                </div>
                
                <div class="flex justify-between">
                  <span class="text-gray-400">Verifier:</span>
                  <span class="font-medium">${data.verifier}</span>
                </div>
                
                <div class="flex justify-between">
                  <span class="text-gray-400">Verified At:</span>
                  <span class="font-medium">${data.verified_at ? new Date(data.verified_at).toLocaleString() : 'Not verified'}</span>
                </div>
                
                <div class="flex justify-between">
                  <span class="text-gray-400">Settled At:</span>
                  <span class="font-medium">${data.settled_at ? new Date(data.settled_at).toLocaleString() : 'Not settled'}</span>
                </div>
              </div>
            </div>
          `;
          
          modal.classList.remove('hidden');
        })
        .catch(error => {
          console.error('Error fetching transaction details:', error);
          showToast('Error loading transaction details', 'error');
        });
    }

    function closeModal() {
      document.getElementById('transactionModal').classList.add('hidden');
    }

    // Export Functions
    function exportTransactions(format) {
      const transactions = {{ transactions|tojson }};
      
      if (format === 'csv') {
        exportTransactionsToCSV(transactions);
      } else if (format === 'pdf') {
        exportTransactionsToPDF(transactions);
      }
    }

    function exportTransactionsToCSV(transactions) {
      let csv = 'Fuel Flux Transaction History\n';
      csv += `Export Date: ${new Date().toISOString()}\n`;
      csv += `Wallet Balance: ‚Çπ{{ "%.2f"|format(wallet_balance) }}\n\n`;
      
      csv += 'Date & Time,Vehicle Number,Vehicle Type,Pump Name,Pump Location,Fuel Type,Quantity (L),Price/L,Amount,Status\n';
      
      transactions.forEach(transaction => {
        const date = transaction.created_at ? new Date(transaction.created_at).toLocaleString() : 'N/A';
        csv += `"${date}","${transaction.vehicle_number}","${transaction.vehicle_type}","${transaction.pump_name}","${transaction.pump_location}","${transaction.fuel_type}","${transaction.quantity_litres}","${transaction.unit_price}","${transaction.amount}","${transaction.status}"\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `fuel_flux_transactions_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function exportTransactionsToPDF(transactions) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Title
      doc.setFontSize(20);
      doc.text('Fuel Flux Transaction History', 14, 20);
      doc.setFontSize(10);
      doc.text(`Export Date: ${new Date().toLocaleDateString()}`, 14, 30);
      doc.text(`Wallet Balance: ‚Çπ{{ "%.2f"|format(wallet_balance) }}`, 14, 40);
      
      // Prepare table data
      const tableData = transactions.map(transaction => [
        transaction.created_at ? new Date(transaction.created_at).toLocaleDateString() : 'N/A',
        transaction.vehicle_number || 'N/A',
        transaction.pump_name || 'N/A',
        transaction.fuel_type || 'N/A',
        transaction.quantity_litres || 'N/A',
        `‚Çπ${transaction.unit_price || '0'}`,
        `‚Çπ${transaction.amount || '0'}`,
        transaction.status || 'N/A'
      ]);
      
      // Add table
      doc.autoTable({
        head: [['Date', 'Vehicle', 'Pump', 'Fuel', 'Qty (L)', 'Price/L', 'Amount', 'Status']],
        body: tableData,
        startY: 60,
        theme: 'grid',
        styles: {
          fontSize: 8,
          cellPadding: 2,
          fillColor: [31, 41, 55],
          textColor: [255, 255, 255],
          lineColor: [75, 85, 99]
        },
        headStyles: {
          fillColor: [251, 146, 60],
          textColor: [255, 255, 255],
          fontStyle: 'bold'
        }
      });
      
      doc.save(`fuel_flux_transactions_${new Date().toISOString().split('T')[0]}.pdf`);
    }

    function printTransactions() {
      const transactions = {{ transactions|tojson }};
      
      const printContent = `
        <div style="font-family: Arial, sans-serif; padding: 20px;">
          <h1 style="color: #FB923C; margin-bottom: 20px;">Fuel Flux Transaction History</h1>
          <p style="margin-bottom: 30px;"><strong>Export Date:</strong> ${new Date().toLocaleDateString()}</p>
          <p style="margin-bottom: 20px;"><strong>Wallet Balance:</strong> ‚Çπ{{ "%.2f"|format(wallet_balance) }}</p>
          
          <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
            <thead>
              <tr style="background-color: #1F2937; color: #FB923C;">
                <th style="padding: 10px; border: 1px solid #374151; text-align: left;">Date</th>
                <th style="padding: 10px; border: 1px solid #374151; text-align: left;">Vehicle</th>
                <th style="padding: 10px; border: 1px solid #374151; text-align: left;">Pump</th>
                <th style="padding: 10px; border: 1px solid #374151; text-align: left;">Fuel</th>
                <th style="padding: 10px; border: 1px solid #374151; text-align: left;">Qty (L)</th>
                <th style="padding: 10px; border: 1px solid #374151; text-align: left;">Price/L</th>
                <th style="padding: 10px; border: 1px solid #374151; text-align: left;">Amount</th>
                <th style="padding: 10px; border: 1px solid #374151; text-align: left;">Status</th>
              </tr>
            </thead>
            <tbody>
              ${transactions.map(transaction => `
                <tr>
                  <td style="padding: 10px; border: 1px solid #374151;">${transaction.created_at ? new Date(transaction.created_at).toLocaleDateString() : 'N/A'}</td>
                  <td style="padding: 10px; border: 1px solid #374151;">${transaction.vehicle_number || 'N/A'}</td>
                  <td style="padding: 10px; border: 1px solid #374151;">${transaction.pump_name || 'N/A'}</td>
                  <td style="padding: 10px; border: 1px solid #374151;">${transaction.fuel_type || 'N/A'}</td>
                  <td style="padding: 10px; border: 1px solid #374151;">${transaction.quantity_litres || 'N/A'}</td>
                  <td style="padding: 10px; border: 1px solid #374151;">‚Çπ${transaction.unit_price || '0'}</td>
                  <td style="padding: 10px; border: 1px solid #374151;">‚Çπ${transaction.amount || '0'}</td>
                  <td style="padding: 10px; border: 1px solid #374151;">${transaction.status || 'N/A'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
      
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html>
          <head>
            <title>Fuel Flux Transactions - Print</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
              table { width: 100%; border-collapse: collapse; }
              th, td { padding: 10px; border: 1px solid #374151; text-align: left; }
              th { background-color: #1F2937; color: #FB923C; }
            </style>
          </head>
          <body>${printContent}</body>
        </html>
      `);
      printWindow.document.close();
      printWindow.print();
    }

    // Close modal when clicking outside
    document.getElementById('transactionModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeModal();
      }
    });

    // Mobile sidebar toggle
    document.getElementById('openMobileSidebar').addEventListener('click', function() {
      document.getElementById('sidebar').classList.toggle('-translate-x-full');
    });
  </script>
</body>
</html>
