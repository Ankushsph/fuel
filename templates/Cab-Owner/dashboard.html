<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="csrf-token" content="{{ csrf_token() }}">

  <title>Dashboard - Fuel Flux</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/tailwind.css') }}">
  <style>
    #toast {
      position: fixed;
      top: -100px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 50;
      padding: 1rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 500;
      color: white;
      opacity: 0;
      transition: all 0.5s ease-in-out;
      min-width: 250px;
      text-align: center;
    }
    #toast.show { top: 2rem; opacity: 1; }
  </style>
</head>
<body class="bg-fuel-black text-white min-h-screen flex flex-col">

  <!-- Toast -->
  <div id="toast"></div>

  <!-- Header -->
  <header class="bg-fuel-gray p-2 md:p-4 shadow-md">
    <div class="flex justify-between items-center gap-2">
      <div class="flex items-center gap-1 md:gap-2 flex-1 min-w-0">
        <button id="openMobileSidebar" class="lg:hidden text-fuel-orange text-lg md:text-xl font-bold flex-shrink-0">‚ò∞</button>
        <img src="{{ url_for('static', filename='images/logo2.png') }}" 
             alt="Fuel Flux Logo" 
             class="h-6 md:h-10 w-auto flex-shrink-0"
             style="background: none !important; background-color: transparent !important; mix-blend-mode: screen;" />
        <span class="text-fuel-orange font-bold text-xs md:text-xl truncate hidden sm:inline">Dashboard</span>
      </div>
      <a href="/logout" class="bg-fuel-orange hover:bg-orange-600 px-2 py-1.5 md:px-4 md:py-2 rounded-lg font-semibold transition text-xs md:text-base whitespace-nowrap flex-shrink-0">Logout</a>
    </div>
  </header>

  <!-- Main Dashboard Layout -->
  <div class="flex flex-1 min-h-0">

    <!-- Sidebar (Desktop) -->
    <aside class="w-64 bg-fuel-gray flex flex-col justify-between p-6 hidden lg:flex">
      <div>
        <nav class="space-y-4">
          <a href="{{ url_for('dashboard.dashboard') }}" class="block py-2 px-3 rounded-lg border border-fuel-orange hover:bg-fuel-black transition">üè† Dashboard</a>
          <a href="{{ url_for('dashboard.transactions') }}" class="block py-2 px-3 rounded-lg border border-fuel-orange hover:bg-fuel-black transition">üí≥ Transactions</a>
          <a href="#" onclick="openProfileModal(); return false;" class="block py-2 px-3 rounded-lg border border-fuel-orange hover:bg-fuel-black transition">üë§ Profile</a>
        </nav>

        <hr class="my-6 border-fuel-black">

        <!-- Vehicles Section -->
        <div>
          <div class="flex justify-between items-center mb-3">
            <h3 class="text-sm font-semibold text-gray-300">Your Vehicles</h3>
            <button id="addVehicleBtn" class="text-fuel-orange text-sm font-semibold hover:text-orange-600 transition">+ Add</button>
          </div>
          <ul id="vehicleList" class="space-y-2 text-gray-300">
            {% for v in vehicles %}
              <li class="bg-fuel-black p-2 rounded-lg flex justify-between items-center">
                <span>{{ v.name }} ({{ v.type }})</span>
                <form method="POST" action="{{ url_for('vehicle.remove_vehicle', vehicle_id=v.id) }}" class="ml-2">
                  
                </form>
              </li>
            {% endfor %}
          </ul>
        </div>
      </div>

      <div class="mt-10">
        <p class="text-sm text-gray-400 mb-2">Logged in as</p>
        <p class="font-semibold">{{ user.email }}</p>
      </div>
    </aside>

    <!-- Mobile Sidebar -->
    <div id="mobileSidebar" class="fixed inset-0 bg-black bg-opacity-70 z-40 lg:hidden opacity-0 invisible transition-opacity duration-300">
      <aside class="w-64 bg-fuel-gray h-full p-6 overflow-y-auto">
        <button id="closeMobileSidebar" class="mb-4 px-3 py-2 bg-fuel-orange rounded-lg font-semibold">Close</button>

        <!-- Menu -->
        <nav class="space-y-4 mb-6">
          <a href="{{ url_for('dashboard.dashboard') }}" class="block py-2 px-3 rounded-lg border border-fuel-orange hover:bg-fuel-black transition">üè† Dashboard</a>
          <a href="{{ url_for('dashboard.transactions') }}" class="block py-2 px-3 rounded-lg border border-fuel-orange hover:bg-fuel-black transition">üí≥ Transactions</a>
          <a href="#" onclick="openProfileModal(); return false;" class="block py-2 px-3 rounded-lg border border-fuel-orange hover:bg-fuel-black transition">üë§ Profile</a>
        </nav>

        <hr class="my-4 border-fuel-black">

        <!-- Vehicles Section -->
        <div class="mb-6">
          <div class="flex justify-between items-center mb-3">
            <h3 class="text-sm font-semibold text-gray-300">Your Vehicles</h3>
            <button id="addVehicleBtnMobile" class="text-fuel-orange text-sm font-semibold hover:text-orange-600 transition">+ Add</button>
          </div>
          <ul id="vehicleListMobile" class="space-y-2 text-gray-300">
            {% for v in vehicles %}
              <li class="bg-fuel-black p-2 rounded-lg flex justify-between items-center">
                <span>{{ v.name }} ({{ v.type }})</span>
                <form method="POST" action="{{ url_for('vehicle.remove_vehicle', vehicle_id=v.id) }}" class="ml-2">
                 
                </form>
              </li>
            {% endfor %}
          </ul>
        </div>
      </aside>
    </div>

    <!-- Main Content -->
    <main class="flex-1 p-4 md:p-6 overflow-y-auto">
      <!-- Wallet Balance Display -->
      <div class="bg-fuel-gray p-4 rounded-lg mb-6">
        <div class="flex justify-between items-center">
          <span class="text-gray-300">Current Wallet Balance</span>
          <span class="text-2xl font-bold text-fuel-orange">‚Çπ{{ "%.2f"|format(user.wallet_balance if user.wallet_balance else 0.00) }}</span>
        </div>
      </div>

      <div class="flex-1 bg-fuel-gray rounded-xl shadow-lg p-4 md:p-6 flex flex-col overflow-y-auto text-gray-300" id="mainWorkspace" 
           data-wallet-balance="{{ user.wallet_balance or 0.00 }}"
           data-add-funds-url="{{ url_for('wallet.add_funds') }}"
           data-balance-url="{{ url_for('wallet.get_balance') }}">
        <p>Select an option from the left menu.</p>
      </div>
    </main>
  </div>

  <!-- Vehicle Modal -->
  <div id="vehicleModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center opacity-0 invisible transition-opacity duration-300 z-50">
    <div class="bg-fuel-gray rounded-xl p-6 w-96 relative">
      <h3 class="text-xl font-bold text-fuel-orange mb-4">Add Vehicle</h3>
        <form id="vehicleForm" class="flex flex-col space-y-3" method="POST" action="{{ url_for('vehicle.add_vehicle') }}">
          
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

          <input type="text" name="name" id="vehicleNameInput" placeholder="Vehicle Name" class="p-2 rounded bg-fuel-black text-white focus:outline-none" required>
          
          <input type="text" name="type" id="vehicleTypeInput" placeholder="Vehicle Type" class="p-2 rounded bg-fuel-black text-white focus:outline-none" required>
          
          <input type="text" name="year" id="vehicleYearInput" placeholder="Year of Manufacture" class="p-2 rounded bg-fuel-black text-white focus:outline-none" required>
          
          <input 
            type="text" 
            name="license" 
            id="vehicleLicenseInput" 
            placeholder="Vehicle Number (e.g., GJ01AB1234)" 
            class="p-2 rounded bg-fuel-black text-white focus:outline-none uppercase" 
            pattern="^([A-Z]{2})(\d{1,2})([A-Z]{1,2}|BH)(\d{4})$"
            title="Enter a valid Indian vehicle number (e.g., GJ01AB1234, MH20BH1234)"
            required>

          <div class="flex gap-2">
            <button type="button" id="cancelVehicleBtn" class="flex-1 px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg font-semibold transition">Cancel</button>
            <button type="submit" class="flex-1 px-4 py-2 bg-fuel-orange hover:bg-orange-600 rounded-lg font-semibold transition">Add Vehicle</button>
          </div>
        </form>
    </div>
  </div>

  <!-- Add Funds Modal -->
  <div id="addFundsModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center opacity-0 invisible transition-opacity duration-300 z-50">
    <div class="bg-fuel-gray rounded-xl p-6 w-96 relative">
      <h3 class="text-xl font-bold text-fuel-orange mb-4">Add Funds</h3>
      <div class="bg-fuel-black p-4 rounded-lg mb-6">
        <h3 class="text-lg font-semibold text-gray-200 mb-3">‚ÑπÔ∏è How Add Funds Works</h3>
        <p class="text-gray-300 text-sm mb-2">1. Scan the QR code using your UPI app and pay the amount.</p>
        <p class="text-gray-300 text-sm mb-2">2. Upload the payment screenshot and enter the amount + UTR/transaction ID.</p>
        <p class="text-gray-300 text-sm">3. Admin verifies the payment. Once approved, the amount will be added to your wallet.</p>
      </div>

      <form id="addFundsForm" class="flex flex-col space-y-3" method="POST" action="{{ url_for('wallet.add_funds') }}" enctype="multipart/form-data">
          
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

          <input type="number" id="topupAmountInput" name="amount" placeholder="Enter amount paid" min="1" 
                 class="p-2 rounded bg-fuel-black text-white focus:outline-none" required>
          <input type="text" id="transactionIdInput" name="transaction_id" placeholder="UPI Transaction ID (optional)" 
                 class="p-2 rounded bg-fuel-black text-white focus:outline-none">
          <div>
            <label class="text-sm text-gray-300 mb-1 block">Payment Screenshot</label>
            <input type="file" id="screenshotInput" name="screenshot" accept="image/*" required
                   class="w-full p-2 rounded bg-fuel-black text-white focus:outline-none">
          </div>

          <div class="flex gap-2">
            <button type="button" id="cancelAddFundsBtn" class="flex-1 px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg font-semibold transition">Cancel</button>
            <button type="submit" class="flex-1 px-4 py-2 bg-fuel-orange hover:bg-orange-600 rounded-lg font-semibold transition">Submit</button>
          </div>
        </form>
    </div>
  </div>

  <!-- Profile Modal -->
  <div id="profileModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center opacity-0 invisible transition-opacity duration-300 z-50">
    <div class="bg-fuel-gray rounded-xl p-6 w-96 relative">
      <h3 class="text-xl font-bold text-fuel-orange mb-4">Profile Settings</h3>
      <form id="profileForm" class="flex flex-col space-y-3" method="POST" action="{{ url_for('dashboard.update_profile') }}">
          
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                  <input type="password" name="old_password" placeholder="Current Password" 
                         class="w-full p-2 rounded bg-fuel-gray text-white focus:outline-none" required>
                  <input type="password" name="new_password" placeholder="New Password" 
                         class="w-full p-2 rounded bg-fuel-gray text-white focus:outline-none" required>
                  <input type="password" name="confirm_password" placeholder="Confirm New Password" 
                         class="w-full p-2 rounded bg-fuel-gray text-white focus:outline-none" required>
                  <button type="submit" 
                          class="px-4 py-2 bg-fuel-orange hover:bg-orange-600 rounded-lg font-semibold">
                          Update Password
                  </button>
                </form>
    </div>
  </div>

  <script>
    // Force uppercase input for vehicle number
    const vehicleLicenseInput = document.getElementById('vehicleLicenseInput');
    vehicleLicenseInput.addEventListener('input', () => {
      vehicleLicenseInput.value = vehicleLicenseInput.value.toUpperCase();
    });
  </script>



  <script>
    // Toast
    function showToast(message, type) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.className = "";
      toast.classList.add("px-6","py-3","rounded-lg","text-white","font-semibold",
        "shadow-lg","fixed","transition-all","duration-500","ease-in-out");
      if(type === "success") toast.classList.add("bg-fuel-green");
      else if(type === "error") toast.classList.add("bg-fuel-red");
      else toast.classList.add("bg-fuel-gray");
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3000);
    }

    document.addEventListener("DOMContentLoaded", () => {
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            showToast("{{ message }}", "{{ category }}");
          {% endfor %}
        {% endif %}
      {% endwith %}
    });

    // Vehicle Modal
    const vehicleModal = document.getElementById('vehicleModal');
    const addVehicleBtn = document.getElementById('addVehicleBtn');
    const addVehicleBtnMobile = document.getElementById('addVehicleBtnMobile');
    const cancelVehicleBtn = document.getElementById('cancelVehicleBtn');

    function openModal() {
      vehicleModal.classList.remove('opacity-0','invisible');
      vehicleModal.classList.add('opacity-100','visible');
    }
    addVehicleBtn.addEventListener('click', openModal);
    addVehicleBtnMobile.addEventListener('click', openModal);
    cancelVehicleBtn.addEventListener('click', () => {
      vehicleModal.classList.add('opacity-0','invisible');
      vehicleModal.classList.remove('opacity-100','visible');
    });

    // Add Funds Modal
    const addFundsModal = document.getElementById('addFundsModal');
    const addFundsBtn = document.getElementById('addFundsBtn');
    const cancelAddFundsBtn = document.getElementById('cancelAddFundsBtn');

    function openAddFundsModal() {
      addFundsModal.classList.remove('opacity-0','invisible');
      addFundsModal.classList.add('opacity-100','visible');
    }
    addFundsBtn.addEventListener('click', openAddFundsModal);
    cancelAddFundsBtn.addEventListener('click', () => {
      addFundsModal.classList.add('opacity-0','invisible');
      addFundsModal.classList.remove('opacity-100','visible');
    });

    // Profile Modal
    const profileModal = document.getElementById('profileModal');
    const profileBtn = document.getElementById('profileBtn');
    const cancelProfileBtn = document.getElementById('cancelProfileBtn');

    function openProfileModal() {
      profileModal.classList.remove('opacity-0','invisible');
      profileModal.classList.add('opacity-100','visible');
    }
    profileBtn.addEventListener('click', openProfileModal);
    cancelProfileBtn.addEventListener('click', () => {
      profileModal.classList.add('opacity-0','invisible');
      profileModal.classList.remove('opacity-100','visible');
    });

    // Mobile sidebar toggle
    document.getElementById('openMobileSidebar').addEventListener('click', function() {
      document.getElementById('mobileSidebar').classList.remove('opacity-0','invisible');
      document.getElementById('mobileSidebar').classList.add('opacity-100','visible');
    });
    document.getElementById('closeMobileSidebar').addEventListener('click', function() {
      document.getElementById('mobileSidebar').classList.add('opacity-0','invisible');
      document.getElementById('mobileSidebar').classList.remove('opacity-100','visible');
    });

    // Auto-refresh wallet balance
    const balanceElement = document.getElementById('walletBalance');
    const balanceUrl = document.getElementById('mainWorkspace').dataset.balanceUrl;
    if (balanceUrl && balanceElement) {
      setInterval(() => {
        fetch(balanceUrl)
          .then(response => response.json())
          .then(data => {
            if (data.balance !== undefined) {
              balanceElement.textContent = data.balance.toFixed(2);
            }
          })
          .catch(() => balanceElement.textContent = "0.00");
      }, 30000); // Refresh every 30 seconds
    }
  </script>
</body>
</html>
