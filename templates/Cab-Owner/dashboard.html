<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="csrf-token" content="{{ csrf_token() }}">

  <title>Dashboard - Fuel Flux</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/tailwind.css') }}">
  <style>
    #toast {
      position: fixed;
      top: -100px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 50;
      padding: 1rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 500;
      color: white;
      opacity: 0;
      transition: all 0.5s ease-in-out;
      min-width: 250px;
      text-align: center;
    }
    #toast.show { top: 2rem; opacity: 1; }
  </style>
</head>
<body class="bg-fuel-black text-white min-h-screen flex flex-col">

  <!-- Toast -->
  <div id="toast"></div>

  <!-- Header -->
  <header class="bg-fuel-gray p-2 md:p-4 shadow-md">
    <div class="flex justify-between items-center gap-2">
      <div class="flex items-center gap-1 md:gap-2 flex-1 min-w-0">
        <button id="openMobileSidebar" class="lg:hidden text-fuel-orange text-lg md:text-xl font-bold flex-shrink-0">‚ò∞</button>
        <img src="{{ url_for('static', filename='images/logo2.png') }}" 
             alt="Fuel Flux Logo" 
             class="h-6 md:h-10 w-auto flex-shrink-0"
             style="background: none !important; background-color: transparent !important; mix-blend-mode: screen;" />
        <span class="text-fuel-orange font-bold text-xs md:text-xl truncate hidden sm:inline">Dashboard</span>
      </div>
      <a href="/logout" class="bg-fuel-orange hover:bg-orange-600 px-2 py-1.5 md:px-4 md:py-2 rounded-lg font-semibold transition text-xs md:text-base whitespace-nowrap flex-shrink-0">Logout</a>
    </div>
  </header>

  <!-- Main Dashboard Layout -->
  <div class="flex flex-1 min-h-0">

    <!-- Sidebar (Desktop) -->
    <aside class="w-64 bg-fuel-gray flex flex-col justify-between p-6 hidden lg:flex">
      <div>
        <nav class="space-y-4">
          <a href="{{ url_for('dashboard.dashboard') }}" class="block py-2 px-3 rounded-lg border border-fuel-orange hover:bg-fuel-black transition">üè† Dashboard</a>
          <a href="{{ url_for('dashboard.transactions') }}" class="block py-2 px-3 rounded-lg border border-fuel-orange hover:bg-fuel-black transition">üí≥ Transactions</a>
          <a href="#" onclick="openAddFundsModal(); return false;" class="block py-2 px-3 rounded-lg border border-fuel-orange hover:bg-fuel-black transition">üí∞ Add Funds</a>
          <a href="#" onclick="openProfileModal(); return false;" class="block py-2 px-3 rounded-lg border border-fuel-orange hover:bg-fuel-black transition">üë§ Profile</a>
        </nav>

        <hr class="my-6 border-fuel-black">

        <!-- Vehicles Section -->
        <div>
          <div class="flex justify-between items-center mb-3">
            <h3 class="text-sm font-semibold text-gray-300">Your Vehicles</h3>
            <button id="addVehicleBtn" class="text-fuel-orange text-sm font-semibold hover:text-orange-600 transition">+ Add</button>
          </div>
          <ul id="vehicleList" class="space-y-2 text-gray-300">
            {% for v in vehicles %}
              <li class="bg-fuel-black p-2 rounded-lg flex justify-between items-center">
                <span>{{ v.name }} ({{ v.type }})</span>
                <form method="POST" action="{{ url_for('vehicle.remove_vehicle', vehicle_id=v.id) }}" class="ml-2">
                  
                </form>
              </li>
            {% endfor %}
          </ul>
        </div>
      </div>

      <div class="mt-10">
        <p class="text-sm text-gray-400 mb-2">Logged in as</p>
        <p class="font-semibold">{{ user.email }}</p>
      </div>
    </aside>

    <!-- Mobile Sidebar -->
    <div id="mobileSidebar" class="fixed inset-0 bg-black bg-opacity-70 z-40 lg:hidden opacity-0 invisible transition-opacity duration-300">
      <aside class="w-64 bg-fuel-gray h-full p-6 overflow-y-auto">
        <button id="closeMobileSidebar" class="mb-4 px-3 py-2 bg-fuel-orange rounded-lg font-semibold">Close</button>

        <!-- Menu -->
        <nav class="space-y-4 mb-6">
          <a href="{{ url_for('dashboard.dashboard') }}" class="block py-2 px-3 rounded-lg border border-fuel-orange hover:bg-fuel-black transition">üè† Dashboard</a>
          <a href="{{ url_for('dashboard.transactions') }}" class="block py-2 px-3 rounded-lg border border-fuel-orange hover:bg-fuel-black transition">üí≥ Transactions</a>
          <a href="#" onclick="openAddFundsModal(); return false;" class="block py-2 px-3 rounded-lg border border-fuel-orange hover:bg-fuel-black transition">üí∞ Add Funds</a>
          <a href="#" onclick="openProfileModal(); return false;" class="block py-2 px-3 rounded-lg border border-fuel-orange hover:bg-fuel-black transition">üë§ Profile</a>
        </nav>

        <hr class="my-4 border-fuel-black">

        <!-- Vehicles Section -->
        <div class="mb-6">
          <div class="flex justify-between items-center mb-3">
            <h3 class="text-sm font-semibold text-gray-300">Your Vehicles</h3>
            <button id="addVehicleBtnMobile" class="text-fuel-orange text-sm font-semibold hover:text-orange-600 transition">+ Add</button>
          </div>
          <ul id="vehicleListMobile" class="space-y-2 text-gray-300">
            {% for v in vehicles %}
              <li class="bg-fuel-black p-2 rounded-lg flex justify-between items-center">
                <span>{{ v.name }} ({{ v.type }})</span>
                <form method="POST" action="{{ url_for('vehicle.remove_vehicle', vehicle_id=v.id) }}" class="ml-2">
                 
                </form>
              </li>
            {% endfor %}
          </ul>
        </div>
      </aside>
    </div>

    <!-- Main Content -->
    <main class="flex-1 p-4 md:p-6 overflow-y-auto">
      <!-- Wallet Balance Display -->
      <div class="bg-fuel-gray p-4 rounded-lg mb-6">
        <div class="flex justify-between items-center">
          <span class="text-gray-300">Current Wallet Balance</span>
          <div class="flex items-center gap-4">
            <span class="text-2xl font-bold text-fuel-orange">‚Çπ{{ "%.2f"|format(user.wallet_balance if user.wallet_balance else 0.00) }}</span>
            <button onclick="openAddFundsModal()" class="bg-fuel-orange hover:bg-orange-600 px-4 py-2 rounded-lg font-semibold transition text-sm">Add Funds</button>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="bg-fuel-gray p-4 rounded-lg mb-6">
        <h3 class="text-lg font-semibold text-fuel-orange mb-3">Quick Actions</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <button onclick="openAddFundsModal()" class="bg-fuel-black hover:bg-fuel-black/70 border border-fuel-orange text-fuel-orange px-4 py-3 rounded-lg font-semibold transition flex items-center justify-center gap-2">
            üí∞ Add Funds to Wallet
          </button>
          <a href="{{ url_for('dashboard.transactions') }}" class="bg-fuel-black hover:bg-fuel-black/70 border border-fuel-orange text-fuel-orange px-4 py-3 rounded-lg font-semibold transition flex items-center justify-center gap-2">
            üí≥ View Transactions
          </a>
        </div>
      </div>

      <div class="flex-1 bg-fuel-gray rounded-xl shadow-lg p-4 md:p-6 flex flex-col overflow-y-auto text-gray-300" id="mainWorkspace" 
           data-wallet-balance="{{ user.wallet_balance or 0.00 }}"
           data-add-funds-url="{{ url_for('wallet.add_funds') }}"
           data-balance-url="{{ url_for('wallet.get_balance') }}">
        <p>Select an option from the left menu.</p>
      </div>
    </main>
  </div>

  <!-- Vehicle Modal -->
  <div id="vehicleModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center opacity-0 invisible transition-opacity duration-300 z-50">
    <div class="bg-fuel-gray rounded-xl p-6 w-96 relative">
      <h3 class="text-xl font-bold text-fuel-orange mb-4">Add Vehicle</h3>
        <form id="vehicleForm" class="flex flex-col space-y-3" method="POST" action="{{ url_for('vehicle.add_vehicle') }}">
          
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

          <input type="text" name="name" id="vehicleNameInput" placeholder="Vehicle Name" class="p-2 rounded bg-fuel-black text-white focus:outline-none" required>
          
          <input type="text" name="type" id="vehicleTypeInput" placeholder="Vehicle Type" class="p-2 rounded bg-fuel-black text-white focus:outline-none" required>
          
          <input type="text" name="year" id="vehicleYearInput" placeholder="Year of Manufacture" class="p-2 rounded bg-fuel-black text-white focus:outline-none" required>
          
          <input 
            type="text" 
            name="license" 
            id="vehicleLicenseInput" 
            placeholder="Vehicle Number (e.g., GJ01AB1234)" 
            class="p-2 rounded bg-fuel-black text-white focus:outline-none uppercase" 
            pattern="^([A-Z]{2})(\d{1,2})([A-Z]{1,2}|BH)(\d{4})$"
            title="Enter a valid Indian vehicle number (e.g., GJ01AB1234, MH20BH1234)"
            required>

          <div class="flex gap-2">
            <button type="button" id="cancelVehicleBtn" class="flex-1 px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg font-semibold transition">Cancel</button>
            <button type="submit" class="flex-1 px-4 py-2 bg-fuel-orange hover:bg-orange-600 rounded-lg font-semibold transition">Add Vehicle</button>
          </div>
        </form>
    </div>
  </div>

  <!-- Add Funds Modal -->
  <div id="addFundsModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center opacity-0 invisible transition-opacity duration-300 z-50 p-4">
    <div class="bg-fuel-gray rounded-xl p-4 w-full max-w-md relative max-h-[85vh] overflow-hidden flex flex-col">
      <div class="flex justify-between items-center mb-3">
        <h3 class="text-lg font-bold text-fuel-orange">Add Funds</h3>
        <button id="closeAddFundsBtn" class="text-gray-400 hover:text-white text-xl leading-none">&times;</button>
      </div>
      
      <!-- Scrollable Content Area -->
      <div class="overflow-y-auto flex-1 pr-1 custom-scrollbar" style="max-height: calc(85vh - 120px);">
        <!-- QR Code Section (Compact) -->
        <div class="bg-fuel-black p-3 rounded-lg mb-3">
          <h3 class="text-sm font-semibold text-gray-200 mb-2">üì± Scan QR Code to Pay</h3>
          <div class="flex justify-center mb-2">
            <img src="{{ url_for('static', filename='images/payment_qr.png') }}" alt="UPI QR Code" class="w-32 h-32 bg-white rounded-lg p-1">
          </div>
          <p class="text-center text-gray-300 text-xs mb-1">Scan with any UPI app</p>
          <p class="text-center text-fuel-orange text-xs">UPI ID: fuelflux@paytm</p>
        </div>

        <form id="addFundsForm" class="flex flex-col space-y-3" method="POST" action="{{ url_for('wallet.submit_qr_topup') }}" enctype="multipart/form-data">
          
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

          <!-- Quick Amount Selection (Compact) -->
          <div>
            <label class="text-xs text-gray-300 mb-1 block">Quick Amount</label>
            <div class="grid grid-cols-3 gap-1">
              <button type="button" onclick="setAmount(100)" class="bg-fuel-black hover:bg-fuel-orange border border-fuel-orange text-fuel-orange px-2 py-1 rounded text-xs font-semibold transition">‚Çπ100</button>
              <button type="button" onclick="setAmount(500)" class="bg-fuel-black hover:bg-fuel-orange border border-fuel-orange text-fuel-orange px-2 py-1 rounded text-xs font-semibold transition">‚Çπ500</button>
              <button type="button" onclick="setAmount(1000)" class="bg-fuel-black hover:bg-fuel-orange border border-fuel-orange text-fuel-orange px-2 py-1 rounded text-xs font-semibold transition">‚Çπ1000</button>
              <button type="button" onclick="setAmount(2000)" class="bg-fuel-black hover:bg-fuel-orange border border-fuel-orange text-fuel-orange px-2 py-1 rounded text-xs font-semibold transition">‚Çπ2000</button>
              <button type="button" onclick="setAmount(5000)" class="bg-fuel-black hover:bg-fuel-orange border border-fuel-orange text-fuel-orange px-2 py-1 rounded text-xs font-semibold transition">‚Çπ5000</button>
              <button type="button" onclick="setAmount(10000)" class="bg-fuel-black hover:bg-fuel-orange border border-fuel-orange text-fuel-orange px-2 py-1 rounded text-xs font-semibold transition">‚Çπ10000</button>
            </div>
          </div>

          <div>
            <label class="text-xs text-gray-300 mb-1 block">Amount Paid *</label>
            <input type="number" id="topupAmountInput" name="amount" placeholder="Enter amount" min="1" 
                   class="w-full p-2 rounded bg-fuel-black text-white focus:outline-none border border-gray-600 focus:border-fuel-orange text-sm" required>
          </div>
          
          <div>
            <label class="text-xs text-gray-300 mb-1 block">Transaction ID (optional)</label>
            <input type="text" id="transactionIdInput" name="transaction_id" placeholder="UPI Transaction ID" 
                   class="w-full p-2 rounded bg-fuel-black text-white focus:outline-none border border-gray-600 focus:border-fuel-orange text-sm">
          </div>
          
          <div>
            <label class="text-xs text-gray-300 mb-1 block">Payment Screenshot *</label>
            <input type="file" id="screenshotInput" name="screenshot" accept="image/*" required
                   class="w-full p-2 rounded bg-fuel-black text-white focus:outline-none border border-gray-600 focus:border-fuel-orange text-sm">
          </div>
        </form>
      </div>
      
      <!-- Fixed Footer with Buttons (Always Visible) -->
      <div class="border-t border-gray-700 pt-3 mt-3 flex-shrink-0">
        <div class="flex gap-2">
          <button type="button" id="cancelAddFundsBtn" class="flex-1 px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-semibold transition text-sm">Cancel</button>
          <button type="submit" form="addFundsForm" class="flex-1 px-3 py-2 bg-fuel-orange hover:bg-orange-600 text-white rounded-lg font-semibold transition text-sm font-bold">Submit</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div id="profileModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center opacity-0 invisible transition-opacity duration-300 z-50 p-4">
    <div class="bg-fuel-gray rounded-xl p-4 w-full max-w-md relative max-h-[85vh] overflow-hidden flex flex-col">
      <div class="flex justify-between items-center mb-3">
        <h3 class="text-lg font-bold text-fuel-orange">Profile Settings</h3>
        <button id="closeProfileBtn" class="text-gray-400 hover:text-white text-xl leading-none">&times;</button>
      </div>
      
      <!-- Scrollable Content Area -->
      <div class="overflow-y-auto flex-1 pr-1 custom-scrollbar" style="max-height: calc(85vh - 120px);">
        <!-- User Information Display (Compact) -->
        <div class="bg-fuel-black p-3 rounded-lg mb-3">
          <h4 class="text-sm font-semibold text-gray-200 mb-2 flex items-center">
            <span class="mr-2">üë§</span> Personal Information
          </h4>
          <div class="space-y-2">
            <div class="flex justify-between items-center py-1 border-b border-gray-700">
              <span class="text-gray-400 text-xs">Name:</span>
              <span class="text-white font-medium text-xs">{{ user.name if user.name else 'Not Set' }}</span>
            </div>
            <div class="flex justify-between items-center py-1 border-b border-gray-700">
              <span class="text-gray-400 text-xs">Email:</span>
              <span class="text-white font-medium text-xs">{{ user.email }}</span>
            </div>
            <div class="flex justify-between items-center py-1 border-b border-gray-700">
              <span class="text-gray-400 text-xs">Phone:</span>
              <span class="text-white font-medium text-xs">{{ user.phone if user.phone else 'Not Set' }}</span>
            </div>
            <div class="flex justify-between items-center py-1">
              <span class="text-gray-400 text-xs">Member Since:</span>
              <span class="text-white font-medium text-xs">{{ user.created_at.strftime('%d %b %Y') if user.created_at else 'N/A' }}</span>
            </div>
          </div>
        </div>

        <!-- Vehicle Information (Compact) -->
        <div class="bg-fuel-black p-3 rounded-lg mb-3">
          <h4 class="text-sm font-semibold text-gray-200 mb-2 flex items-center">
            <span class="mr-2">üöó</span> Vehicle Details
          </h4>
          {% if vehicles %}
            <div class="space-y-2">
              {% for vehicle in vehicles %}
              <div class="border border-gray-600 rounded p-2 bg-fuel-gray/50">
                <div class="flex justify-between items-center mb-1">
                  <span class="text-gray-400 font-medium text-xs">{{ vehicle.name }}</span>
                  <span class="text-white font-bold text-fuel-orange text-xs">{{ vehicle.type }}</span>
                </div>
                <div class="text-gray-300 text-xs space-y-1">
                  <div>Year: {{ vehicle.year }}</div>
                  <div>License: {{ vehicle.license_plate }}</div>
                </div>
              </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-center py-3">
              <p class="text-gray-400 text-xs">No vehicles registered</p>
              <button onclick="document.getElementById('addVehicleBtn').click(); document.getElementById('profileModal').classList.add('opacity-0','invisible'); document.getElementById('profileModal').classList.remove('opacity-100','visible');" class="mt-1 text-fuel-orange hover:text-white text-xs font-semibold">Add Vehicle</button>
            </div>
          {% endif %}
        </div>

        <!-- Wallet Information (Compact) -->
        <div class="bg-fuel-black p-3 rounded-lg mb-3">
          <h4 class="text-sm font-semibold text-gray-200 mb-2 flex items-center">
            <span class="mr-2">üí∞</span> Wallet Information
          </h4>
          <div class="flex justify-between items-center">
            <span class="text-gray-400 text-xs">Current Balance:</span>
            <span class="text-lg font-bold text-fuel-orange">‚Çπ{{ "%.2f"|format(user.wallet_balance if user.wallet_balance else 0.00) }}</span>
          </div>
          <button onclick="openAddFundsModal(); document.getElementById('profileModal').classList.add('opacity-0','invisible'); document.getElementById('profileModal').classList.remove('opacity-100','visible');" class="mt-2 w-full bg-fuel-orange hover:bg-orange-600 text-white px-2 py-1 rounded-lg font-semibold transition text-xs">Add Funds</button>
        </div>

        <!-- Change Password Section (Compact) -->
        <div class="bg-fuel-black p-3 rounded-lg">
          <h4 class="text-sm font-semibold text-gray-200 mb-2 flex items-center">
            <span class="mr-2">üîê</span> Change Password
          </h4>
          <form id="profileForm" class="flex flex-col space-y-2" method="POST" action="{{ url_for('dashboard.change_password') }}">
            
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <input type="password" name="old_password" placeholder="Current Password" 
                   class="w-full p-2 rounded bg-fuel-gray text-white focus:outline-none border border-gray-600 focus:border-fuel-orange text-sm" required>
            <input type="password" name="new_password" placeholder="New Password" 
                   class="w-full p-2 rounded bg-fuel-gray text-white focus:outline-none border border-gray-600 focus:border-fuel-orange text-sm" required>
            <input type="password" name="confirm_password" placeholder="Confirm New Password" 
                   class="w-full p-2 rounded bg-fuel-gray text-white focus:outline-none border border-gray-600 focus:border-fuel-orange text-sm" required>
          </form>
        </div>
      </div>
      
      <!-- Fixed Footer with Buttons (Always Visible) -->
      <div class="border-t border-gray-700 pt-3 mt-3 flex-shrink-0">
        <div class="flex gap-2">
          <button type="button" id="cancelProfileBtn" class="flex-1 px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-semibold transition text-sm">Cancel</button>
          <button type="submit" form="profileForm" class="flex-1 px-3 py-2 bg-fuel-orange hover:bg-orange-600 text-white rounded-lg font-semibold transition text-sm font-bold">Update Password</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Custom Scrollbar Styles -->
  <style>
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: #1f2937;
      border-radius: 3px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #f97316;
      border-radius: 3px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #ea580c;
    }
  </style>

  <script>
    // Force uppercase input for vehicle number
    const vehicleLicenseInput = document.getElementById('vehicleLicenseInput');
    vehicleLicenseInput.addEventListener('input', () => {
      vehicleLicenseInput.value = vehicleLicenseInput.value.toUpperCase();
    });
  </script>



  <script>
    // Toast
    function showToast(message, type) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.className = "";
      toast.classList.add("px-6","py-3","rounded-lg","text-white","font-semibold",
        "shadow-lg","fixed","transition-all","duration-500","ease-in-out");
      if(type === "success") toast.classList.add("bg-fuel-green");
      else if(type === "error") toast.classList.add("bg-fuel-red");
      else toast.classList.add("bg-fuel-gray");
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3000);
    }

    document.addEventListener("DOMContentLoaded", () => {
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            showToast("{{ message }}", "{{ category }}");
          {% endfor %}
        {% endif %}
      {% endwith %}
    });

    // Vehicle Modal
    const vehicleModal = document.getElementById('vehicleModal');
    const addVehicleBtn = document.getElementById('addVehicleBtn');
    const addVehicleBtnMobile = document.getElementById('addVehicleBtnMobile');
    const cancelVehicleBtn = document.getElementById('cancelVehicleBtn');

    function openModal() {
      vehicleModal.classList.remove('opacity-0','invisible');
      vehicleModal.classList.add('opacity-100','visible');
    }
    addVehicleBtn.addEventListener('click', openModal);
    addVehicleBtnMobile.addEventListener('click', openModal);
    cancelVehicleBtn.addEventListener('click', () => {
      vehicleModal.classList.add('opacity-0','invisible');
      vehicleModal.classList.remove('opacity-100','visible');
    });

    // Add Funds Modal
    const addFundsModal = document.getElementById('addFundsModal');
    const cancelAddFundsBtn = document.getElementById('cancelAddFundsBtn');
    const closeAddFundsBtn = document.getElementById('closeAddFundsBtn');

    function openAddFundsModal() {
      addFundsModal.classList.remove('opacity-0','invisible');
      addFundsModal.classList.add('opacity-100','visible');
    }
    
    // Add event listeners for add funds buttons
    document.querySelectorAll('button[onclick*="openAddFundsModal"], a[onclick*="openAddFundsModal"]').forEach(element => {
      element.addEventListener('click', (e) => {
        e.preventDefault();
        openAddFundsModal();
      });
    });
    
    cancelAddFundsBtn.addEventListener('click', () => {
      addFundsModal.classList.add('opacity-0','invisible');
      addFundsModal.classList.remove('opacity-100','visible');
    });
    
    closeAddFundsBtn.addEventListener('click', () => {
      addFundsModal.classList.add('opacity-0','invisible');
      addFundsModal.classList.remove('opacity-100','visible');
    });

    // Quick Amount Selection Function
    function setAmount(amount) {
      const amountInput = document.getElementById('topupAmountInput');
      if (amountInput) {
        amountInput.value = amount;
        // Trigger change event for any listeners
        amountInput.dispatchEvent(new Event('input', { bubbles: true }));
        amountInput.dispatchEvent(new Event('change', { bubbles: true }));
      }
    }

    // Add Funds Form Validation
    const addFundsForm = document.getElementById('addFundsForm');
    if (addFundsForm) {
      addFundsForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const amountInput = document.getElementById('topupAmountInput');
        const amount = parseFloat(amountInput.value) || 0;
        const screenshot = document.getElementById('screenshotInput').files[0];
        const transactionId = document.getElementById('transactionIdInput').value;
        
        console.log('Form validation - Amount:', amount, 'Type:', typeof amount);
        
        // Validation
        if (!amount || amount <= 0 || isNaN(amount)) {
          showToast('Please enter a valid amount greater than 0', 'error');
          amountInput.focus();
          return;
        }
        
        if (!screenshot) {
          showToast('Please upload payment screenshot', 'error');
          return;
        }
        
        if (screenshot.size > 5 * 1024 * 1024) { // 5MB limit
          showToast('Screenshot size should be less than 5MB', 'error');
          return;
        }
        
        if (!screenshot.type.match('image.*')) {
          showToast('Please upload a valid image file', 'error');
          return;
        }
        
        // Create FormData for submission
        const formData = new FormData();
        formData.append('csrf_token', document.querySelector('input[name="csrf_token"]').value);
        formData.append('amount', amount.toString());
        formData.append('transaction_id', transactionId);
        formData.append('screenshot', screenshot);
        
        console.log('Submitting form with amount:', amount);
        
        // Submit form
        fetch(this.action, {
          method: 'POST',
          body: formData
        })
        .then(response => {
          console.log('Response received:', response);
          return response.json();
        })
        .then(data => {
          console.log('Data received:', data);
          if (data.success) {
            showToast('Payment details submitted successfully! Admin will verify and add funds to your wallet.', 'success');
            addFundsForm.reset();
            addFundsModal.classList.add('opacity-0','invisible');
            addFundsModal.classList.remove('opacity-100','visible');
            
            // Refresh wallet balance after 2 seconds
            setTimeout(() => {
              location.reload();
            }, 2000);
          } else {
            showToast(data.message || 'Error submitting payment details', 'error');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showToast('Error submitting payment details. Please try again.', 'error');
        });
      });
    }

    // Profile Modal
    const profileModal = document.getElementById('profileModal');
    const cancelProfileBtn = document.getElementById('cancelProfileBtn');
    const closeProfileBtn = document.getElementById('closeProfileBtn');

    function openProfileModal() {
      profileModal.classList.remove('opacity-0','invisible');
      profileModal.classList.add('opacity-100','visible');
    }
    
    // Add event listeners for profile buttons
    document.querySelectorAll('a[onclick*="openProfileModal"]').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        openProfileModal();
      });
    });
    
    cancelProfileBtn.addEventListener('click', () => {
      profileModal.classList.add('opacity-0','invisible');
      profileModal.classList.remove('opacity-100','visible');
    });
    
    closeProfileBtn.addEventListener('click', () => {
      profileModal.classList.add('opacity-0','invisible');
      profileModal.classList.remove('opacity-100','visible');
    });

    // Profile Form Validation
    const profileForm = document.getElementById('profileForm');
    if (profileForm) {
      profileForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const oldPassword = document.querySelector('input[name="old_password"]').value;
        const newPassword = document.querySelector('input[name="new_password"]').value;
        const confirmPassword = document.querySelector('input[name="confirm_password"]').value;
        
        // Validation
        if (!oldPassword || !newPassword || !confirmPassword) {
          showToast('Please fill all password fields', 'error');
          return;
        }
        
        if (newPassword.length < 6) {
          showToast('New password must be at least 6 characters long', 'error');
          return;
        }
        
        if (newPassword !== confirmPassword) {
          showToast('New password and confirm password do not match', 'error');
          return;
        }
        
        // Create FormData for submission
        const formData = new FormData();
        formData.append('csrf_token', document.querySelector('#profileForm input[name="csrf_token"]').value);
        formData.append('old_password', oldPassword);
        formData.append('new_password', newPassword);
        formData.append('confirm_password', confirmPassword);
        
        // Submit form
        fetch(this.action, {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showToast('Password updated successfully!', 'success');
            profileForm.reset();
            profileModal.classList.add('opacity-0','invisible');
            profileModal.classList.remove('opacity-100','visible');
          } else {
            showToast(data.message || 'Error updating password', 'error');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showToast('Error updating password. Please try again.', 'error');
        });
      });
    }

    // Mobile sidebar toggle
    document.getElementById('openMobileSidebar').addEventListener('click', function() {
      document.getElementById('mobileSidebar').classList.remove('opacity-0','invisible');
      document.getElementById('mobileSidebar').classList.add('opacity-100','visible');
    });
    document.getElementById('closeMobileSidebar').addEventListener('click', function() {
      document.getElementById('mobileSidebar').classList.add('opacity-0','invisible');
      document.getElementById('mobileSidebar').classList.remove('opacity-100','visible');
    });

    // Auto-refresh wallet balance
    const balanceElement = document.getElementById('walletBalance');
    const balanceUrl = document.getElementById('mainWorkspace').dataset.balanceUrl;
    if (balanceUrl && balanceElement) {
      setInterval(() => {
        fetch(balanceUrl)
          .then(response => response.json())
          .then(data => {
            if (data.balance !== undefined) {
              balanceElement.textContent = data.balance.toFixed(2);
            }
          })
          .catch(() => balanceElement.textContent = "0.00");
      }, 30000); // Refresh every 30 seconds
    }
  </script>
</body>
</html>
