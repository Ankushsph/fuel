<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="csrf-token" content="{{ csrf_token() }}">

  <title>Dashboard - Fuel Flux</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/tailwind.css') }}">
  <style>
    #toast {
      position: fixed;
      top: -100px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 50;
      padding: 1rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 500;
      color: white;
      opacity: 0;
      transition: all 0.5s ease-in-out;
      min-width: 250px;
      text-align: center;
    }
    #toast.show { top: 2rem; opacity: 1; }
  </style>
</head>
<body class="bg-fuel-black text-white min-h-screen flex flex-col">

  <!-- Toast -->
  <div id="toast"></div>

  <!-- Header -->
  <header class="bg-fuel-gray p-4 flex justify-between items-center shadow-md">
    <div class="flex items-center space-x-2">
      <button id="openMobileSidebar" class="lg:hidden text-fuel-orange text-2xl font-bold">â˜°</button>
      <img src="{{ url_for('static', filename='images/logo2.png') }}" alt="Fuel Flux Logo" class="h-10 w-auto" />
      <span class="text-fuel-orange font-bold text-xl">Dashboard</span>
    </div>
    <div class="flex items-center space-x-4">
      <a href="/logout" class="bg-fuel-orange hover:bg-orange-600 px-4 py-2 rounded-lg font-semibold transition">Logout</a>
    </div>
  </header>

  <!-- Main Dashboard Layout -->
  <div class="flex flex-1 min-h-0">

    <!-- Sidebar (Desktop) -->
    <aside class="w-64 bg-fuel-gray flex flex-col justify-between p-6 hidden lg:flex">
      <div>
        <nav class="space-y-4">
          <a href="#" class="block py-2 px-3 rounded-lg hover:bg-fuel-black transition">ðŸ’³ Billing System</a>
          <a href="#" class="block py-2 px-3 rounded-lg hover:bg-fuel-black transition">ðŸ‘¤ Profile</a>
        </nav>

        <hr class="my-6 border-fuel-black">

        <!-- Vehicles Section -->
        <div>
          <div class="flex justify-between items-center mb-3">
            <h3 class="text-sm font-semibold text-gray-300">Your Vehicles</h3>
            <button id="addVehicleBtn" class="text-fuel-orange text-sm font-semibold hover:text-orange-600 transition">+ Add</button>
          </div>
          <ul id="vehicleList" class="space-y-2 text-gray-300">
            {% for v in vehicles %}
              <li class="bg-fuel-black p-2 rounded-lg flex justify-between items-center">
                <span>{{ v.name }} ({{ v.type }})</span>
                <form method="POST" action="{{ url_for('vehicle.remove_vehicle', vehicle_id=v.id) }}" class="ml-2">
                  
                </form>
              </li>
            {% endfor %}
          </ul>
        </div>
      </div>

      <div class="mt-10">
        <p class="text-sm text-gray-400 mb-2">Logged in as</p>
        <p class="font-semibold">{{ user.email }}</p>
      </div>
    </aside>

    <!-- Mobile Sidebar -->
    <div id="mobileSidebar" class="fixed inset-0 bg-black bg-opacity-70 z-40 lg:hidden opacity-0 invisible transition-opacity duration-300">
      <aside class="w-64 bg-fuel-gray h-full p-6 overflow-y-auto">
        <button id="closeMobileSidebar" class="mb-4 px-3 py-2 bg-fuel-orange rounded-lg font-semibold">Close</button>

        <!-- Menu -->
        <nav class="space-y-4 mb-6">
          <a href="#" class="block py-2 px-3 rounded-lg hover:bg-fuel-black transition">ðŸ’³ Billing System</a>
          <a href="#" class="block py-2 px-3 rounded-lg hover:bg-fuel-black transition">ðŸ‘¤ Profile</a>
        </nav>

        <hr class="my-4 border-fuel-black">

        <!-- Vehicles Section -->
        <div class="mb-6">
          <div class="flex justify-between items-center mb-3">
            <h3 class="text-sm font-semibold text-gray-300">Your Vehicles</h3>
            <button id="addVehicleBtnMobile" class="text-fuel-orange text-sm font-semibold hover:text-orange-600 transition">+ Add</button>
          </div>
          <ul id="vehicleListMobile" class="space-y-2 text-gray-300">
            {% for v in vehicles %}
              <li class="bg-fuel-black p-2 rounded-lg flex justify-between items-center">
                <span>{{ v.name }} ({{ v.type }})</span>
                <form method="POST" action="{{ url_for('vehicle.remove_vehicle', vehicle_id=v.id) }}" class="ml-2">
                 
                </form>
              </li>
            {% endfor %}
          </ul>
        </div>

        <hr class="my-4 border-fuel-black">

        <!-- Recent Bookings Section -->
        <div>
          <h3 class="text-sm font-semibold text-gray-300 mb-3">ðŸ•’ Recent Bookings</h3>
          <ul class="space-y-2 text-gray-300">
            <li class="bg-fuel-black p-2 rounded-lg text-sm">Cab #3 â†’ Pump C (Yesterday, 4:00 PM)</li>
            <li class="bg-fuel-black p-2 rounded-lg text-sm">Cab #8 â†’ Pump A (Today, 8:30 AM)</li>
            <li class="bg-fuel-black p-2 rounded-lg text-sm">Cab #5 â†’ Pump B (Today, 9:15 AM)</li>
          </ul>
        </div>
      </aside>
    </div>

    <!-- Main Content -->
    <main class="flex-1 bg-fuel-black p-6 flex flex-col overflow-y-auto">
      <header class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-fuel-orange">Welcome, {{ user.full_name }} ðŸŽ‰</h1>
      </header>

      <div class="flex-1 bg-fuel-gray rounded-xl shadow-lg p-6 flex flex-col overflow-y-auto text-gray-300" id="mainWorkspace" 
           data-wallet-balance="{{ user.wallet_balance or 0.00 }}"
           data-add-funds-url="{{ url_for('wallet.add_funds') }}"
           data-balance-url="{{ url_for('wallet.get_balance') }}">
        <p>Select an option from the left menu.</p>
      </div>
    </main>

    <!-- Right Panel (Desktop Recent Bookings) -->
    <aside class="w-72 bg-fuel-gray p-6 hidden lg:block">
      <h2 class="text-xl font-bold text-fuel-orange mb-4">ðŸ•’ Recent Bookings</h2>
      <ul class="space-y-3 text-gray-300">
        <li class="bg-fuel-black p-3 rounded-lg">Cab #3 â†’ Pump C (Yesterday, 4:00 PM)</li>
        <li class="bg-fuel-black p-3 rounded-lg">Cab #8 â†’ Pump A (Today, 8:30 AM)</li>
        <li class="bg-fuel-black p-3 rounded-lg">Cab #5 â†’ Pump B (Today, 9:15 AM)</li>
      </ul>
    </aside>

  </div>

 <!-- Vehicle Modal -->
    <div id="vehicleModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center opacity-0 invisible transition-opacity duration-300 z-50">
      <div class="bg-fuel-gray rounded-xl p-6 w-96 relative">
        <h3 class="text-xl font-bold text-fuel-orange mb-4">Add Vehicle</h3>
        <form id="vehicleForm" class="flex flex-col space-y-3" method="POST" action="{{ url_for('vehicle.add_vehicle') }}">
          
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

          <input type="text" name="name" id="vehicleNameInput" placeholder="Vehicle Name" class="p-2 rounded bg-fuel-black text-white focus:outline-none" required>
          
          <input type="text" name="type" id="vehicleTypeInput" placeholder="Vehicle Type" class="p-2 rounded bg-fuel-black text-white focus:outline-none" required>
          

          <input type="text" name="year" id="vehicleYearInput" placeholder="Year of Manufacture" class="p-2 rounded bg-fuel-black text-white focus:outline-none" required>
          
          <input 
            type="text" 
            name="license" 
            id="vehicleLicenseInput" 
            placeholder="Vehicle Number (e.g., GJ01AB1234)" 
            class="p-2 rounded bg-fuel-black text-white focus:outline-none uppercase" 
            pattern="^([A-Z]{2})(\d{1,2})([A-Z]{1,2}|BH)(\d{4})$"
            title="Enter a valid Indian vehicle number (e.g., GJ01AB1234, MH20BH1234)"
            required
          >

          <select name="fuel_type" id="vehicleFuelType" class="p-2 rounded bg-fuel-black text-white focus:outline-none" required>
            <option value="" disabled selected>Fuel Type</option>
            <option value="Petrol">Petrol</option>
            <option value="Diesel">Diesel</option>
            <option value="CNG">CNG</option>
            <option value="Electric">Electric</option>
          </select>

          <div class="flex justify-end space-x-2">
            <button type="button" id="cancelVehicleBtn" class="px-4 py-2 rounded bg-gray-700 hover:bg-gray-600">Cancel</button>
            <button type="submit" class="px-4 py-2 rounded bg-fuel-orange hover:bg-orange-600 text-white">Add</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // Force uppercase input for vehicle number
      const vehicleLicenseInput = document.getElementById('vehicleLicenseInput');
      vehicleLicenseInput.addEventListener('input', () => {
        vehicleLicenseInput.value = vehicleLicenseInput.value.toUpperCase();
      });
    </script>



  <script>
    // Toast
    function showToast(message, type) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.className = "";
      toast.classList.add("px-6","py-3","rounded-lg","text-white","font-semibold",
        "shadow-lg","fixed","transition-all","duration-500","ease-in-out");
      if(type === "success") toast.classList.add("bg-fuel-green");
      else if(type === "error") toast.classList.add("bg-fuel-red");
      else toast.classList.add("bg-fuel-gray");
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3000);
    }

    document.addEventListener("DOMContentLoaded", () => {
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            showToast("{{ message }}", "{{ category }}");
          {% endfor %}
        {% endif %}
      {% endwith %}
    });

    // Vehicle Modal
    const vehicleModal = document.getElementById('vehicleModal');
    const addVehicleBtn = document.getElementById('addVehicleBtn');
    const addVehicleBtnMobile = document.getElementById('addVehicleBtnMobile');
    const cancelVehicleBtn = document.getElementById('cancelVehicleBtn');

    function openModal() {
      vehicleModal.classList.remove('opacity-0','invisible');
      vehicleModal.classList.add('opacity-100','visible');
    }
    addVehicleBtn.addEventListener('click', openModal);
    addVehicleBtnMobile.addEventListener('click', openModal);
    cancelVehicleBtn.addEventListener('click', () => {
      vehicleModal.classList.remove('opacity-100','visible');
      vehicleModal.classList.add('opacity-0','invisible');
      document.getElementById('vehicleForm').reset();
    });
    vehicleModal.addEventListener('click', (e) => {
      if(e.target === vehicleModal) {
        vehicleModal.classList.remove('opacity-100','visible');
        vehicleModal.classList.add('opacity-0','invisible');
        document.getElementById('vehicleForm').reset();
      }
    });

    // Mobile Sidebar toggle
    const mobileSidebar = document.getElementById('mobileSidebar');
    const openMobileSidebarBtn = document.getElementById('openMobileSidebar');
    const closeMobileSidebarBtn = document.getElementById('closeMobileSidebar');

    openMobileSidebarBtn.addEventListener('click', () => {
      mobileSidebar.classList.remove('opacity-0','invisible');
      mobileSidebar.classList.add('opacity-100','visible');
    });
    closeMobileSidebarBtn.addEventListener('click', () => {
      mobileSidebar.classList.remove('opacity-100','visible');
      mobileSidebar.classList.add('opacity-0','invisible');
    });

    // Dynamic main content
    const mainContent = document.getElementById('mainWorkspace');
    const menuLinks = document.querySelectorAll('nav a');
    const walletBalance = mainContent.dataset.walletBalance;

    function updateMainContent(selected) {
      let content = '';
      switch(selected){
case 'ðŸ’³ Billing System':
  mainContent.innerHTML = `
    <h2 class="text-2xl font-bold text-fuel-orange mb-4">Billing System</h2>

    <!-- Wallet Card -->
    <div class="bg-fuel-black p-4 rounded-lg shadow flex flex-col mb-6">
      <h3 class="text-lg font-semibold text-gray-200 mb-2">ðŸ’° Wallet</h3>
      <div class="flex items-center justify-between space-x-4">
        <div>
          <p class="text-gray-300">Current Balance:</p>
          <p class="text-3xl font-bold text-fuel-orange mt-1">â‚¹<span id="walletBalance">Loading...</span></p>
        </div>
        <button id="addFundsBtn" class="px-4 py-2 bg-fuel-green hover:bg-green-600 rounded-lg font-semibold">
          Add Funds
        </button>
      </div>
    </div>

    <!-- Transaction History Card -->
      <div class="bg-fuel-black p-4 rounded-lg shadow flex flex-col mb-6">
        <h3 class="text-lg font-semibold text-gray-200 mb-3">ðŸ“œ Transaction History</h3>
        <div id="transactionList" class="space-y-3 max-h-64 overflow-y-auto pr-2 terms-content">
          <p class="text-gray-400 text-sm">Loading transactions...</p>
        </div>
      </div>


    <!-- Add Funds Modal -->
    <div id="addFundsModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center opacity-0 invisible transition-opacity duration-300 z-50">
      <div class="bg-fuel-gray rounded-xl p-6 w-96 relative">
        <h3 class="text-xl font-bold text-fuel-orange mb-4">Add Funds</h3>
        <form id="addFundsForm" class="flex flex-col space-y-3">

          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

          <input type="number" name="amount" placeholder="Enter amount" min="1" 
                 class="p-2 rounded bg-fuel-black text-white focus:outline-none" required>
          <div class="flex justify-end space-x-2">
            <button type="button" id="cancelAddFundsBtn" class="px-4 py-2 rounded bg-gray-700 hover:bg-gray-600">Cancel</button>
            <button type="submit" class="px-4 py-2 rounded bg-fuel-green hover:bg-green-600 text-white">Add</button>
          </div>
        </form>
      </div>
    </div>
  `;

  const addFundsBtn = document.getElementById('addFundsBtn');
  const addFundsModal = document.getElementById('addFundsModal');
  const cancelAddFundsBtn = document.getElementById('cancelAddFundsBtn');
  const addFundsForm = document.getElementById('addFundsForm');
  const balanceElement = document.getElementById('walletBalance');
  const addFundsUrl = mainContent.dataset.addFundsUrl;
  const balanceUrl = mainContent.dataset.balanceUrl;
  // Read CSRF token from meta tag
  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute("content");

  // Fetch current balance immediately
    fetch(balanceUrl, {
        method: "GET",
        credentials: "include" 
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            balanceElement.textContent = parseFloat(data.balance).toFixed(2);
        } else {
            balanceElement.textContent = "0.00";
        }
    })
    .catch(() => balanceElement.textContent = "0.00");


  // Modal open
  addFundsBtn.addEventListener('click', () => {
    addFundsModal.classList.remove('opacity-0','invisible');
    addFundsModal.classList.add('opacity-100','visible');
  });

  // Modal close
  cancelAddFundsBtn.addEventListener('click', () => {
    addFundsModal.classList.remove('opacity-100','visible');
    addFundsModal.classList.add('opacity-0','invisible');
    addFundsForm.reset();
  });

  addFundsModal.addEventListener('click', e => {
    if(e.target === addFundsModal){
      addFundsModal.classList.remove('opacity-100','visible');
      addFundsModal.classList.add('opacity-0','invisible');
      addFundsForm.reset();
    }
  });

  // Add Funds submission
  addFundsForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(addFundsForm);
    const amount = parseFloat(formData.get("amount"));

    try {
      const res = await fetch(addFundsUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json","X-CSRFToken": csrfToken  },
        body: JSON.stringify({ amount }),
        credentials: "include"
      });

      const data = await res.json();

      if(data.success){
        balanceElement.textContent = data.new_balance.toFixed(2);
        mainContent.dataset.walletBalance = data.new_balance.toFixed(2);
        showToast(data.message, "success");
        addFundsModal.classList.remove("opacity-100","visible");
        addFundsModal.classList.add("opacity-0","invisible");
        addFundsForm.reset();
      } else {
        showToast(data.message, "error");
      }

    } catch(err){
      console.error(err);
      showToast("Server error. Try again.", "error");
    }
  });
  break;

        case 'ðŸ‘¤ Profile':
          content = `
            <h2 class="text-2xl font-bold text-fuel-orange mb-4">Profile</h2>
            <div class="space-y-6">

              <!-- User Info -->
              <div class="bg-fuel-black p-4 rounded-lg shadow mb-6">
                <h3 class="text-lg font-semibold text-gray-200 mb-2">Your Information</h3>
                <p><span class="font-semibold">Full Name:</span> {{ user.full_name }}</p>
                <p><span class="font-semibold">Email:</span> {{ user.email }}</p>
              </div>

              <!-- Update Profile Form -->
              <div class="bg-fuel-black p-4 rounded-lg shadow mb-6">
                <h3 class="text-lg font-semibold text-gray-200 mb-3">Update Profile</h3>
                <form method="POST" action="{{ url_for('dashboard.update_profile') }}" class="space-y-3">
                    
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                  <input type="text" name="full_name" value="{{ user.full_name }}" 
                         class="w-full p-2 rounded bg-fuel-gray text-white focus:outline-none" required>
                  <button type="submit" 
                          class="px-4 py-2 bg-fuel-orange hover:bg-orange-600 rounded-lg font-semibold">
                    Save Changes
                  </button>
                </form>
              </div>

              <!-- Change Password -->
              {% if user.password_hash %}
              <div class="bg-fuel-black p-4 rounded-lg shadow">
                <h3 class="text-lg font-semibold text-gray-200 mb-3">Change Password</h3>
                <form method="POST" action="{{ url_for('password_bp.change_password') }}" class="space-y-3">
                  
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                  <input type="password" name="old_password" placeholder="Current Password" 
                         class="w-full p-2 rounded bg-fuel-gray text-white focus:outline-none" required>
                  <input type="password" name="new_password" placeholder="New Password" 
                         class="w-full p-2 rounded bg-fuel-gray text-white focus:outline-none" required>
                  <input type="password" name="confirm_password" placeholder="Confirm New Password" 
                         class="w-full p-2 rounded bg-fuel-gray text-white focus:outline-none" required>
                  <button type="submit" 
                          class="px-4 py-2 bg-fuel-orange hover:bg-orange-600 rounded-lg font-semibold">
                    Update Password
                  </button>
                </form>
              </div>
              {% else %}
                <p class="bg-yellow-500 bg-opacity-20 text-yellow-400 px-3 py-2 rounded text-sm">
                  Password change not available for OAuth users.</p>
              {% endif %}
              <!-- User Vehicles Section -->
              <div class="bg-fuel-black p-4 rounded-lg shadow mb-6">
              <h3 class="text-lg font-semibold text-gray-200 mb-3">Your Vehicles</h3>
              {% if user.vehicles %}
              <ul class="space-y-2 text-gray-300">
                {% for v in user.vehicles %}
                  <li class="flex flex-col justify-between bg-fuel-gray p-3 rounded-lg">
                    <div class="flex justify-between items-center mb-1">
                      <span class="font-semibold">{{ v.name }} ({{ v.type }})</span>
                      <form method="POST" action="{{ url_for('vehicle.remove_vehicle', vehicle_id=v.id) }}">
                        <button type="submit" class="px-2 py-1 bg-fuel-red hover:bg-red-600 rounded text-sm">
                          Remove
                        </button>
                      </form>
                    </div>
                    <div class="text-sm text-gray-200 space-y-1">
                      <p><span class="font-semibold">Year:</span> {{ v.year }}</p>
                      <p><span class="font-semibold">License:</span> {{ v.license }}</p>
                      <p><span class="font-semibold">Fuel Type:</span> {{ v.fuel_type }}</p>
                    </div>
                  </li>
                {% endfor %}
              </ul>
              {% else %}
                <p class="text-gray-400 text-sm">No vehicles added yet.</p>
              {% endif %}
            </div>
            `;
          mainContent.innerHTML = content;
          break;

        default:
          mainContent.innerHTML = `<p>Select an option from the left menu.</p>`;
      }
    }

    menuLinks.forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const selected = e.target.textContent.trim();
      updateMainContent(selected);
      
      // Save selection to localStorage
      localStorage.setItem('selectedSection', selected);

      // Close mobile sidebar if needed
      if(!link.closest('.lg\\:flex')) {
        mobileSidebar.classList.remove('opacity-100','visible');
        mobileSidebar.classList.add('opacity-0','invisible');
            }
          });
        });


    // Default content
    const lastSection = localStorage.getItem('selectedSection') || 'ðŸ‘¤ Profile';
    updateMainContent(lastSection);
  </script>

</body>
</html>
